

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modules &mdash; Xbee-Gateway 2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=60dbed4a"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Usage" href="usage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Xbee-Gateway
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#main">main</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#module-setup">Module Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#xbee-device-initialization">XBee Device Initialization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#xbee-serial-port-selection">XBee Serial Port Selection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-xbeedevice">Creating the XBeeDevice</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fallback-if-device-not-found">Fallback if Device Not Found</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queue-initialization">Queue Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#xbeepolling">xbeePolling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-reception-callback">Data Reception Callback</a></li>
<li class="toctree-l4"><a class="reference internal" href="#new-address-detection">New Address Detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queueing-the-packet">Queueing the Packet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notes">Notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#commented-out-disconnection-handler">Commented-Out Disconnection Handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modbuspolling">modbusPolling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queue-consumption">Queue Consumption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#register-lookup">Register Lookup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#payload-parsing">Payload Parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#float-to-register-conversion">Float to Register Conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-to-modbus-context">Writing to Modbus Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modbusserver">modbusServer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modbus-identity-configuration">Modbus Identity Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dynamic-ip-address-resolution">Dynamic IP Address Resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#server-startup">Server Startup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#port-configuration">Port Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#startprocess">startProcess</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps-breakdown">Steps Breakdown</a></li>
<li class="toctree-l4"><a class="reference internal" href="#concurrency-considerations">Concurrency Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id12">__main__</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#explanation">Explanation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configgui">configGui</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gui-components">GUI Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#functions">Functions:</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#get_database"><code class="docutils literal notranslate"><span class="pre">get_database()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#add_database"><code class="docutils literal notranslate"><span class="pre">add_database()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#refresh"><code class="docutils literal notranslate"><span class="pre">refresh()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#live_search"><code class="docutils literal notranslate"><span class="pre">live_search()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#sort_table"><code class="docutils literal notranslate"><span class="pre">sort_table()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#get_available_address"><code class="docutils literal notranslate"><span class="pre">get_available_address()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#delete_selected"><code class="docutils literal notranslate"><span class="pre">delete_selected()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id17">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dbintegration">dbIntegration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id19">Module Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#modules-dependencies">Modules &amp; Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mongodb-collections">MongoDB Collections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#database-initialization">Database Initialization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modbusaddresspolice">modbusAddressPolice</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#validation-logic">Validation Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overlapping-address-rule">Overlapping Address Rule:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-usage">Example Usage:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-response-format">Error Response Format:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#typical-errors">Typical Errors:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">Dependencies:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updatereusableaddress">updateReusableAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#function-overview">Function Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gap-detection-algorithm">Gap Detection Algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#consumable-criteria">Consumable Criteria</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updateallendaddress">updateAllEndAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#functional-summary">Functional Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance-note">Performance Note</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">Example Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#related-functions">Related Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dbquerymodbusstartaddress">dbQueryModbusStartAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id26">Function Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-context">Usage Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id29">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configurexbeeradio">configureXbeeRadio</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#address-calculation">Address Calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id30">Validation Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-actions">Configuration Actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id32">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updatexbeedetails">updateXbeeDetails</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input-validations">Input Validations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mac-address-update">MAC Address Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modbus-address-update">Modbus Address Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#node-identifier-update">Node Identifier Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-workflow">Update Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#side-effects">Side Effects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id33">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#storexbeehistorydata">storeXbeeHistoryData</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input-normalization-and-validation">Input Normalization and Validation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#historian-collection-behavior">Historian Collection Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#document-structure-example">Document Structure Example:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#failure-modes">Failure Modes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id35">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id36">Example Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id37">Notes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#modbus">modbus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#serialselector">serialSelector</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variables">variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xbeedata">xbeeData</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xbeedummydatatransmitter">xbeeDummyDataTransmitter</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Xbee-Gateway</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Modules</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/modules.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="modules">
<h1>Modules<a class="headerlink" href="#modules" title="Link to this heading"></a></h1>
<section id="main">
<span id="id1"></span><h2>main<a class="headerlink" href="#main" title="Link to this heading"></a></h2>
<p>The <cite>main</cite> module is the entry point of the XBee Gateway application. It orchestrates the XBee serial communication, Modbus TCP server, and processing of sensor data from XBee radios. It uses <cite>asyncio</cite> to handle concurrent tasks efficiently.</p>
<section id="module-setup">
<h3>Module Setup<a class="headerlink" href="#module-setup" title="Link to this heading"></a></h3>
<section id="imports">
<h4>Imports<a class="headerlink" href="#imports" title="Link to this heading"></a></h4>
<p>The following standard and third-party modules are imported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sys</span></code>, <code class="docutils literal notranslate"><span class="pre">asyncio</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime</span></code>: Core Python modules for system interaction, concurrency, and time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">digi.xbee.devices.XBeeDevice</span></code> and <code class="docutils literal notranslate"><span class="pre">digi.xbee.exception.XBeeException</span></code>: For managing XBee communication and handling related exceptions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pymodbus.server.StartAsyncTcpServer</span></code> and <code class="docutils literal notranslate"><span class="pre">pymodbus.device.ModbusDeviceIdentification</span></code>: Used to run and identify the Modbus TCP server.</p></li>
<li><p>Application-specific modules:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.variables</span></code>: Stores shared runtime variables such as XBee instance, known MACs, Modbus port, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.xbeeData.cayenneParse</span></code>: Parses incoming XBee payloads into float values using Cayenne LPP protocol.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.dbIntegration.dbQueryModbusStartAddress</span></code>: Maps MAC addresses to Modbus register start addresses.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.serialSelector</span></code>: Contains:
- <code class="docutils literal notranslate"><span class="pre">selectUsbPort</span></code>: Chooses an available USB port.
- <code class="docutils literal notranslate"><span class="pre">handleUsbDisconnection</span></code>: (commented out) handles disconnection events.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.modbus</span></code>: Provides:
- <code class="docutils literal notranslate"><span class="pre">floatToRegisters</span></code>: Converts float values to 2 x 16-bit Modbus register pairs.
- <code class="docutils literal notranslate"><span class="pre">contextManager</span></code>: Returns a Modbus context for register mapping.
- <code class="docutils literal notranslate"><span class="pre">getIpAddress</span></code>: Determines local IP address for Modbus server binding.</p></li>
</ul>
</li>
</ul>
</section>
<section id="xbee-device-initialization">
<h4>XBee Device Initialization<a class="headerlink" href="#xbee-device-initialization" title="Link to this heading"></a></h4>
</section>
</section>
<section id="xbee-serial-port-selection">
<h3>XBee Serial Port Selection<a class="headerlink" href="#xbee-serial-port-selection" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">serialPort</span> <span class="o">=</span> <span class="n">selectUsbPort</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Attempts to detect which USB port the XBee radio is connected to.</p></li>
<li><p>If successful, the returned serial port is used to instantiate an <cite>XBeeDevice</cite>.</p></li>
</ul>
<section id="creating-the-xbeedevice">
<h4>Creating the XBeeDevice<a class="headerlink" href="#creating-the-xbeedevice" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="o">=</span> <span class="n">XBeeDevice</span><span class="p">(</span><span class="n">serialPort</span><span class="p">,</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeBaudRate</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>A global reference to the <cite>XBeeDevice</cite> is stored in <cite>variables.xbeeInstance</cite>.</p></li>
<li><p>The baud rate is fetched from shared config <cite>variables.xbeeBaudRate</cite>.</p></li>
</ul>
</section>
<section id="fallback-if-device-not-found">
<h4>Fallback if Device Not Found<a class="headerlink" href="#fallback-if-device-not-found" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">serialPort</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gateway radio not connected&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If no serial port is returned (e.g., no USB radio plugged in), the system exits early with an error message.</p></li>
</ul>
</section>
<section id="queue-initialization">
<h4>Queue Initialization<a class="headerlink" href="#queue-initialization" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeQueue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Initializes an asynchronous queue.</p></li>
<li><p>Each entry in the queue is a tuple: <code class="docutils literal notranslate"><span class="pre">(mac_address,</span> <span class="pre">raw_data_bytes)</span></code>.</p></li>
<li><p>This queue decouples the reception of XBee packets from the Modbus writing process.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">xbeeQueue</span></code> is consumed by <cite>modbusPolling()</cite> and populated by <cite>xbeePolling()</cite>.</p>
<p><code class="docutils literal notranslate"><span class="pre">variables.xbeeInstance</span></code> is a global variable, required across the entire script to maintain a reference to the XBee radio device for receiving messages and handling connections.</p>
</section>
<section id="summary">
<h4>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h4>
<p>This initialization block ensures that:</p>
<ul class="simple">
<li><p>All required modules and helpers are available.</p></li>
<li><p>The XBee radio is located and configured for communication.</p></li>
<li><p>A global queue is prepared for non-blocking data processing.</p></li>
<li><p>The application halts gracefully if the XBee device is not connected.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">main</span></code> is not just an entry point — it’s the coordination layer that glues asynchronous XBee communication, database-driven register mapping, and Modbus server exposure into a coherent, reactive gateway service.</p>
</section>
</section>
<section id="xbeepolling">
<h3>xbeePolling<a class="headerlink" href="#xbeepolling" title="Link to this heading"></a></h3>
<p>The <cite>xbeePolling</cite> coroutine handles continuous communication with the connected XBee radio. It listens for incoming RF messages and queues them for further processing by the Modbus layer.</p>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Opens the serial port and establishes a connection with the XBee device.</p></li>
<li><p>Registers a callback to process incoming data asynchronously.</p></li>
<li><p>Extracts metadata like the MAC address, timestamp, and payload.</p></li>
<li><p>Adds any newly discovered MAC addresses to a global known list.</p></li>
<li><p>Pushes each received packet into the global <cite>xbeeQueue</cite>.</p></li>
</ul>
</section>
<section id="implementation">
<h4>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">xbeePolling</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">dataReceiveCallback</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="p">):</span>
            <span class="o">...</span>

        <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">add_data_received_callback</span><span class="p">(</span><span class="n">dataReceiveCallback</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="data-reception-callback">
<h4>Data Reception Callback<a class="headerlink" href="#data-reception-callback" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">dataReceiveCallback</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="p">):</span>
    <span class="n">xbeeMacAddress</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="o">.</span><span class="n">remote_device</span><span class="o">.</span><span class="n">get_64bit_addr</span><span class="p">())</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">xbeeDataAsByte</span> <span class="o">=</span> <span class="n">xbeeMessage</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<p>This callback extracts:</p>
<ul class="simple">
<li><p><strong>xbeeMacAddress</strong>: The 64-bit MAC address of the sending node.</p></li>
<li><p><strong>timestamp</strong>: Human-readable time of reception.</p></li>
<li><p><strong>xbeeDataAsByte</strong>: Raw binary payload sent by the remote device.</p></li>
</ul>
</section>
<section id="new-address-detection">
<h4>New Address Detection<a class="headerlink" href="#new-address-detection" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">knownXbeeAddress</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New XBee Address Discovered: </span><span class="si">{</span><span class="n">xbeeMacAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">knownXbeeAddress</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of addresses discovered so far are: </span><span class="si">{</span><span class="n">variables</span><span class="o">.</span><span class="n">knownXbeeAddress</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This section dynamically maintains a list of all MAC addresses seen during runtime. Newly discovered radios are appended to <cite>variables.knownXbeeAddress</cite>.</p>
</section>
<section id="queueing-the-packet">
<h4>Queueing the Packet<a class="headerlink" href="#queueing-the-packet" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeQueue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="n">xbeeMacAddress</span><span class="p">,</span> <span class="n">xbeeDataAsByte</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <cite>(mac, data)</cite> tuple is inserted into the asynchronous <cite>xbeeQueue</cite>.</p></li>
<li><p>This decouples reception from processing, allowing later stages to consume data without blocking.</p></li>
</ul>
</section>
<section id="notes">
<h4>Notes<a class="headerlink" href="#notes" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>The inner <cite>while True</cite> loop is necessary to keep the <cite>xbeePolling</cite> coroutine alive.</p></li>
<li><p><cite>asyncio.sleep(1)</cite> is a lightweight way to yield control while keeping the task running.</p></li>
<li><p>If any exceptions occur, the serial port is closed in the <cite>finally</cite> block to avoid lockups.</p></li>
</ul>
</section>
<section id="commented-out-disconnection-handler">
<h4>Commented-Out Disconnection Handler<a class="headerlink" href="#commented-out-disconnection-handler" title="Link to this heading"></a></h4>
<p>There is a placeholder for future support of USB disconnection events:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># variables.xbeeInstance.add_error_callback(partial(handleUsbDisconnection, xbeeObject=variables.xbeeInstance))</span>
</pre></div>
</div>
<p>This uses a <cite>functools.partial</cite> to prebind the device instance and register a disconnection handler, but it is currently disabled (commented out).</p>
</section>
<section id="id2">
<h4>Summary<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<p>The <cite>xbeePolling</cite> function acts as the real-time listener for incoming XBee packets. It enables:</p>
<ul class="simple">
<li><p>Automatic discovery of new radios.</p></li>
<li><p>Timestamped payload extraction.</p></li>
<li><p>Non-blocking handoff to downstream Modbus and database processes via a shared queue.</p></li>
</ul>
</section>
</section>
<section id="modbuspolling">
<h3>modbusPolling<a class="headerlink" href="#modbuspolling" title="Link to this heading"></a></h3>
<p>The <cite>modbusPolling</cite> coroutine processes packets received from XBee radios and updates the Modbus server with the parsed sensor data.</p>
<section id="id3">
<h4>Overview<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Waits for new entries from the shared <cite>xbeeQueue</cite>.</p></li>
<li><p>Uses the MAC address to query a database and retrieve the Modbus register start address.</p></li>
<li><p>Parses raw binary payloads into floating-point sensor values using the Cayenne LPP format.</p></li>
<li><p>Converts floats into Modbus register values (16-bit integers).</p></li>
<li><p>Writes up to 20 registers to both the Holding (FC3) and Input (FC4) register blocks.</p></li>
</ul>
</section>
<section id="id4">
<h4>Implementation<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">modbusPolling</span><span class="p">(</span><span class="n">contextValue</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">xbeeQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startAddress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">sensorValues</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cayenneParse</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">)</span>
                <span class="n">registerValues</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sensorValues</span><span class="p">:</span>
                    <span class="n">registerValues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">floatToRegisters</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="n">registers</span> <span class="o">=</span> <span class="n">registerValues</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
                <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
                <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Xbee radio with mac address </span><span class="si">{</span><span class="n">mac</span><span class="si">}</span><span class="s2">, has not been configured</span><span class="se">\n</span><span class="s2">Other possible error are </span><span class="si">{</span><span class="n">startAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modbus polling error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">xbeeQueue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="queue-consumption">
<h4>Queue Consumption<a class="headerlink" href="#queue-consumption" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">xbeeQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>The coroutine waits (asynchronously) for new packets inserted by <cite>xbeePolling()</cite>. Each packet contains:</p>
<ul class="simple">
<li><p><cite>mac</cite>: 64-bit MAC address as a string.</p></li>
<li><p><cite>raw_data</cite>: binary payload received from the XBee node.</p></li>
</ul>
</section>
<section id="register-lookup">
<h4>Register Lookup<a class="headerlink" href="#register-lookup" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
</pre></div>
</div>
<p>This line queries the local database to determine where in the Modbus address space the data from this MAC should be written. The database should return a valid starting address (e.g., 4020), or an error object if the address is unregistered.</p>
</section>
<section id="payload-parsing">
<h4>Payload Parsing<a class="headerlink" href="#payload-parsing" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sensorValues</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cayenneParse</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">)</span>
</pre></div>
</div>
<p>This function decodes the Cayenne Low Power Payload (LPP) format into a list of float values representing sensor readings. It is assumed to be robust to errors in payload structure.</p>
</section>
<section id="float-to-register-conversion">
<h4>Float to Register Conversion<a class="headerlink" href="#float-to-register-conversion" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">registerValues</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sensorValues</span><span class="p">:</span>
    <span class="n">registerValues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">floatToRegisters</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</pre></div>
</div>
<p>Each float is converted into two 16-bit integers (Modbus registers) using IEEE 754 binary representation. Only the first 10 floats (20 registers) are used to ensure compatibility and prevent overflow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">registers</span> <span class="o">=</span> <span class="n">registerValues</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="writing-to-modbus-context">
<h4>Writing to Modbus Context<a class="headerlink" href="#writing-to-modbus-context" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
<span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
</pre></div>
</div>
<p>This writes the register block to both:</p>
<ul class="simple">
<li><p>Function Code 3 (Holding Registers)</p></li>
<li><p>Function Code 4 (Input Registers)</p></li>
</ul>
<p>Both address spaces mirror the same sensor values, allowing flexibility for downstream SCADA or HMI systems.</p>
</section>
<section id="error-handling">
<h4>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>If the MAC is not found in the database, a message is printed.</p></li>
<li><p>Any exception during parsing or writing is caught and printed.</p></li>
<li><p>After processing (even in error cases), <cite>xbeeQueue.task_done()</cite> is called to mark the queue task as complete.</p></li>
</ul>
</section>
<section id="id5">
<h4>Summary<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<p>The <cite>modbusPolling</cite> function acts as the transformation and mapping layer of the gateway. It:</p>
<ul class="simple">
<li><p>Decouples data reception from register updates.</p></li>
<li><p>Leverages asynchronous concurrency to handle large volumes of packets.</p></li>
<li><p>Ensures safe and consistent updates to the Modbus context.</p></li>
</ul>
</section>
</section>
<section id="modbusserver">
<h3>modbusServer<a class="headerlink" href="#modbusserver" title="Link to this heading"></a></h3>
<p>The <cite>modbusServer</cite> coroutine starts the asynchronous Modbus TCP server that exposes sensor data to external SCADA or HMI systems.</p>
<section id="id6">
<h4>Overview<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Initializes the Modbus device identification parameters.</p></li>
<li><p>Retrieves the local IP address dynamically.</p></li>
<li><p>Launches the <cite>StartAsyncTcpServer()</cite> from <cite>pymodbus</cite> to serve the register context.</p></li>
<li><p>Runs as an asyncio task concurrently with XBee polling and Modbus data processing.</p></li>
</ul>
</section>
<section id="id7">
<h4>Implementation<a class="headerlink" href="#id7" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">modbusServer</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">ModbusDeviceIdentification</span><span class="p">()</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">VendorName</span> <span class="o">=</span> <span class="s1">&#39;Cors System&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">ProductCode</span> <span class="o">=</span> <span class="s1">&#39;CSG&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">VendorUrl</span> <span class="o">=</span> <span class="s1">&#39;https://corssystem.com&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">ProductName</span> <span class="o">=</span> <span class="s1">&#39;Core Terminal Unit Gateway&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">ModelName</span> <span class="o">=</span> <span class="s1">&#39;Genesis&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">MajorMinorRevision</span> <span class="o">=</span> <span class="s1">&#39;2.0&#39;</span>

    <span class="n">ipAddress</span> <span class="o">=</span> <span class="n">getIpAddress</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Modbus TCP server on port </span><span class="si">{</span><span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">StartAsyncTcpServer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="n">identity</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">,</span> <span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="modbus-identity-configuration">
<h4>Modbus Identity Configuration<a class="headerlink" href="#modbus-identity-configuration" title="Link to this heading"></a></h4>
<p>The identity block provides descriptive information about the gateway device when queried by Modbus clients:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>VendorName           = Cors System
ProductCode          = CSG
ProductName          = Core Terminal Unit Gateway
ModelName            = Genesis
Version              = 2.0
</pre></div>
</div>
<p>These values are helpful for device discovery, diagnostics, or validation in a SCADA environment.</p>
</section>
<section id="dynamic-ip-address-resolution">
<h4>Dynamic IP Address Resolution<a class="headerlink" href="#dynamic-ip-address-resolution" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ipAddress</span> <span class="o">=</span> <span class="n">getIpAddress</span><span class="p">()</span>
</pre></div>
</div>
<p>This utility function fetches the device’s local IP address automatically, ensuring the gateway binds to the correct network interface. This is especially useful on devices like Raspberry Pi that may change IPs between boots.</p>
</section>
<section id="server-startup">
<h4>Server Startup<a class="headerlink" href="#server-startup" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">StartAsyncTcpServer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="n">identity</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">,</span> <span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span><span class="p">))</span>
</pre></div>
</div>
<p>This launches the non-blocking Modbus TCP server:</p>
<ul class="simple">
<li><p><cite>context</cite>: the Modbus server context which holds all register values.</p></li>
<li><p><cite>identity</cite>: the device info structure.</p></li>
<li><p><cite>address</cite>: a tuple of <cite>(IP, port)</cite>.</p></li>
</ul>
<p>Once started, the server runs indefinitely within the asyncio event loop, allowing simultaneous handling of:</p>
<ul class="simple">
<li><p>Client read requests (e.g., FC3 and FC4)</p></li>
<li><p>Context updates from <cite>modbusPolling</cite></p></li>
</ul>
</section>
<section id="port-configuration">
<h4>Port Configuration<a class="headerlink" href="#port-configuration" title="Link to this heading"></a></h4>
<p>The port is sourced from the <cite>variables</cite> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span>
</pre></div>
</div>
<p>Ensure this value matches the port expected by your SCADA or Modbus master systems. Typical ports include <cite>502</cite> (default Modbus TCP) or a custom value like <cite>5020</cite>.</p>
</section>
<section id="id8">
<h4>Summary<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p>The <cite>modbusServer</cite> coroutine is the final output layer of the XBee gateway:</p>
<ul class="simple">
<li><p>It makes the internal data accessible to the outside world.</p></li>
<li><p>Leverages asynchronous IO for non-blocking performance.</p></li>
<li><p>Integrates seamlessly with the shared Modbus context used by other tasks.</p></li>
</ul>
</section>
</section>
<section id="startprocess">
<h3>startProcess<a class="headerlink" href="#startprocess" title="Link to this heading"></a></h3>
<p>The <cite>startProcess</cite> coroutine serves as the centralized task coordinator for the XBee Gateway application.</p>
<section id="id9">
<h4>Overview<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Initializes the Modbus register context using <cite>contextManager</cite> from the <cite>modbus</cite> module.</p></li>
<li><p>Creates the background polling task for XBee data.</p></li>
<li><p>Starts the main event loop that concurrently runs:</p>
<ul>
<li><p>XBee serial data polling</p></li>
<li><p>Modbus context updates</p></li>
<li><p>Modbus TCP server</p></li>
</ul>
</li>
</ul>
<p>It is the main orchestrator that wires together the entire gateway workflow using <cite>asyncio.gather</cite>.</p>
</section>
<section id="id10">
<h4>Implementation<a class="headerlink" href="#id10" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startProcess</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">contextManager</span><span class="p">()</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">xbeePolling</span><span class="p">())</span>

    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span><span class="p">,</span>
        <span class="n">modbusPolling</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
        <span class="n">modbusServer</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="steps-breakdown">
<h4>Steps Breakdown<a class="headerlink" href="#steps-breakdown" title="Link to this heading"></a></h4>
<p><strong>1. Context Initialization</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">contextManager</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><cite>contextManager()</cite> is a helper function defined in the <cite>modules.modbus</cite> module.</p>
</div>
<p>It returns a <cite>ModbusServerContext</cite> object that holds all register blocks used in the server, including:</p>
<ul class="simple">
<li><p>Discrete Inputs (DI)</p></li>
<li><p>Coils (CO)</p></li>
<li><p>Holding Registers (HR)</p></li>
<li><p>Input Registers (IR)</p></li>
</ul>
<p>This centralized context is passed to both the <cite>modbusPolling</cite> task and the <cite>modbusServer</cite>, ensuring they operate on the same memory structure.</p>
<p><strong>2. Background Task Creation</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">xbeePolling</span><span class="p">())</span>
</pre></div>
</div>
<p>This launches the XBee radio polling loop in the background. The returned task object is stored in <cite>variables</cite> to allow external cancellation or monitoring.</p>
<p><strong>3. Launch Concurrent Tasks</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span><span class="p">,</span>
    <span class="n">modbusPolling</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
    <span class="n">modbusServer</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This schedules and runs all gateway components concurrently:</p>
<ul class="simple">
<li><p><cite>xbeePolling</cite> collects packets into a shared queue.</p></li>
<li><p><cite>modbusPolling</cite> consumes packets and updates Modbus registers.</p></li>
<li><p><cite>modbusServer</cite> exposes those registers over TCP.</p></li>
</ul>
<p>By leveraging <cite>asyncio.gather</cite>, all three coroutines operate within the same event loop, eliminating the need for threading.</p>
</section>
<section id="concurrency-considerations">
<h4>Concurrency Considerations<a class="headerlink" href="#concurrency-considerations" title="Link to this heading"></a></h4>
<p>Because all tasks share data structures like <cite>xbeeQueue</cite> and <cite>context</cite>, care is taken to:</p>
<ul class="simple">
<li><p>Use non-blocking I/O</p></li>
<li><p>Avoid race conditions via <cite>await</cite></p></li>
<li><p>Share state predictably using asyncio primitives</p></li>
</ul>
</section>
<section id="id11">
<h4>Summary<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<p>The <cite>startProcess()</cite> function glues the system together, ensuring the XBee Gateway:</p>
<ul class="simple">
<li><p>Initializes correctly</p></li>
<li><p>Runs all components in harmony</p></li>
<li><p>Operates in a responsive, non-blocking manner</p></li>
</ul>
<p>It is invoked by the <cite>__main__</cite> block when the program starts.</p>
</section>
</section>
<section id="id12">
<h3>__main__<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>The <cite>__main__</cite> block is the program’s entry point when the script is executed directly. It sets up the event loop, runs the gateway, and handles graceful shutdown on termination or error.</p>
<section id="id13">
<h4>Overview<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<p>This block ensures that:</p>
<ul class="simple">
<li><p>The gateway is only executed when the file is not imported as a module.</p></li>
<li><p>The <cite>startProcess()</cite> coroutine is run using <cite>asyncio.run</cite>.</p></li>
<li><p>Any runtime errors are logged to the console.</p></li>
<li><p>The XBee serial port is closed safely upon exit, preventing resource leaks.</p></li>
</ul>
</section>
<section id="id14">
<h4>Implementation<a class="headerlink" href="#id14" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">startProcess</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">User cancelled operation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown error with info as: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="explanation">
<h4>Explanation<a class="headerlink" href="#explanation" title="Link to this heading"></a></h4>
<p><strong>1. Main Execution Guard</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</pre></div>
</div>
<p>Ensures this code block only runs when the script is executed directly (e.g., <cite>python main.py</cite>). Prevents unintended execution if imported as a library or module.</p>
<p><strong>2. Async Runtime Launcher</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">startProcess</span><span class="p">())</span>
</pre></div>
</div>
<p>Starts the asyncio event loop and calls <cite>startProcess()</cite> to initialize and run all gateway tasks. This is the official way to start asynchronous programs in modern Python (<cite>&gt;=3.7</cite>).</p>
<p><strong>3. Graceful Shutdown</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">User cancelled operation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Handles user interruption (Ctrl+C) gracefully by printing a friendly message instead of a traceback.</p>
<p><strong>4. Catch-All Error Logging</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown error with info as: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Any unexpected errors during startup or runtime are caught and logged. This helps in debugging deployment or field issues.</p>
<p><strong>5. Resource Cleanup</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">finally</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>This block ensures that the XBee serial port is closed if it was previously opened. Prevents port locking and ensures the device can reconnect cleanly next time.</p>
</section>
<section id="id15">
<h4>Summary<a class="headerlink" href="#id15" title="Link to this heading"></a></h4>
<p>The <cite>__main__</cite> block is crucial for managing the lifecycle of the gateway. It:</p>
<ul class="simple">
<li><p>Starts the asyncio-based workflow</p></li>
<li><p>Handles interruptions and crashes</p></li>
<li><p>Ensures hardware resources (like serial ports) are released properly</p></li>
</ul>
<p>Together with <cite>startProcess</cite>, it ensures a robust, fault-tolerant startup and shutdown process.</p>
</section>
</section>
</section>
<section id="configgui">
<span id="id16"></span><h2>configGui<a class="headerlink" href="#configgui" title="Link to this heading"></a></h2>
<p>This Tkinter-based GUI allows users to configure the XBee network and Modbus communication settings for the gateway.</p>
<section id="gui-components">
<h3>GUI Components<a class="headerlink" href="#gui-components" title="Link to this heading"></a></h3>
<p>The interface consists of several main sections:</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt><strong>Header Section</strong></dt><dd><ul class="simple">
<li><p>Displays the application title</p></li>
<li><p>Shows the Modbus server IP address</p></li>
<li><p>Contains the “Configure Serial Number” button</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Add New Entry Section</strong></dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Input fields for:</dt><dd><ul>
<li><p>Node Identifier</p></li>
<li><p>Radio MAC Address</p></li>
<li><p>Modbus Start Address</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>“Available Addresses” button</p></li>
<li><p>“Add to Database” button</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Configured XBee Radios Section</strong></dt><dd><ul class="simple">
<li><p>Search bar with placeholder text</p></li>
<li><p>Refresh button</p></li>
<li><p>Sorting dropdown (First/Last Modified, Ascending/Descending Modbus Address)</p></li>
<li><dl class="simple">
<dt>Treeview table displaying configured radios with columns for:</dt><dd><ul>
<li><p>S/N (Serial Number)</p></li>
<li><p>Node Identifier</p></li>
<li><p>Radio MAC Address</p></li>
<li><p>Modbus Start Address</p></li>
<li><p>Modbus End Address</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>“Delete Selected” and “Update Selected” buttons</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Modal Windows</strong></dt><dd><ul class="simple">
<li><p>Available Addresses window</p></li>
<li><p>Update Entry window</p></li>
<li><p>Configuration window</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
</section>
<section id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tkinter</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PIL.Image</span></code>, <code class="docutils literal notranslate"><span class="pre">PIL.ImageTk</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.modbus.getIpAddress</span></code></p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">.dbIntegration</span></code> module functions:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">configureXbeeRadio</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">retrieveAllConfiguredRadio</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deleteXbeeDetails</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">updateXbeeDetails</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">updateReusableAddress</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">updateAllEndAddress</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="functions">
<h3>Functions:<a class="headerlink" href="#functions" title="Link to this heading"></a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="get_database">
<span class="sig-name descname"><span class="pre">get_database</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#get_database" title="Link to this definition"></a></dt>
<dd><p>Retrieves all configured radio entries from the database and inserts them into the GUI tree view.
If an error occurs during retrieval, an error message is shown to the user.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Calls the <cite>retrieveAllConfiguredRadio()</cite> function to fetch all radio configurations.</p></li>
<li><p>Iterates through the fetched data, inserting each entry into the GUI tree view with details such as index, item[0], item[1], item[2], and item[3].</p></li>
<li><p>If the result is a dictionary and contains an “error” key, an error message is displayed using a messagebox.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_object</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Error Handling:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>If the function retrieves an error message (when the result is a dictionary and contains the “error” key), the function will show an error dialog using <cite>messagebox.showerror</cite> with the message provided in the error field.</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Important Notes:</strong></dt><dd><ul class="simple">
<li><p>The <cite>retrieveAllConfiguredRadio()</cite> function should return a list or iterable with radio configurations, where each item is a tuple containing at least four elements. If the result is a dictionary with an “error” key, the function displays an error.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="add_database">
<span class="sig-name descname"><span class="pre">add_database</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#add_database" title="Link to this definition"></a></dt>
<dd><p>Adds a new radio entry to the database by configuring an XBee radio with a specified radio address, Modbus address, and node identifier.
If successful, the tree view is updated and the input fields are cleared. If an error occurs, an error message is shown to the user.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Retrieves the radio address, Modbus address, and node identifier from the corresponding input fields.</p></li>
<li><p>Attempts to configure the XBee radio using the <cite>configureXbeeRadio()</cite> function with the provided details.</p></li>
<li><p>If the configuration is successful, clears the input fields, shows a success message, and updates the tree view by calling <cite>get_database()</cite> to repopulate it.</p></li>
<li><p>If there is an error during the configuration, an error message is displayed.</p></li>
<li><p>If a <cite>ValueError</cite> is raised due to invalid input (e.g., non-integer Modbus address), an error message is displayed.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<p>If this function is part of a class, the method can be invoked as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_object</span><span class="o">.</span><span class="n">add_database</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Error Handling:</strong></p>
<dl class="simple">
<dt>The function handles errors in the following ways:</dt><dd><ul class="simple">
<li><p><strong>XBee Configuration Error</strong>: If the <cite>configureXbeeRadio()</cite> function returns an error message, an error dialog is shown using <cite>messagebox.showerror</cite>.</p></li>
<li><p><strong>Invalid Modbus Address</strong>: If a <cite>ValueError</cite> occurs due to an invalid Modbus address (non-integer value), an error dialog is shown with a specific message.</p></li>
</ul>
</dd>
<dt><strong>Important Notes:</strong></dt><dd><ul class="simple">
<li><p>The function expects the Modbus address input to be a valid integer. If the input is not a valid integer, the function raises a <cite>ValueError</cite> and prompts the user to enter a valid value.</p></li>
<li><p>The <cite>configureXbeeRadio()</cite> function must return a dictionary, where the absence of an “error” key indicates a successful configuration, and the presence of an “error” key indicates failure.</p></li>
<li><p>After a successful entry, the tree view is cleared and repopulated using the <cite>get_database()</cite> function.</p></li>
<li><p>This function does not return any value.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="refresh">
<span class="sig-name descname"><span class="pre">refresh</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#refresh" title="Link to this definition"></a></dt>
<dd><p>Refreshes the GUI by clearing and repopulating the radio configuration table and updating the displayed IP address of the Modbus server.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Clears all existing entries from the tree view widget.</p></li>
<li><p>Calls <cite>get_database()</cite> to reload and display the latest radio configuration data.</p></li>
<li><p>Retrieves the current IP address of the Modbus server using <cite>getIpAddress()</cite>.</p></li>
<li><p>Updates the <cite>ip_address_label</cite> widget to display the retrieved IP address.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_object</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method. (Implicit)</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This function does not return any value.</p>
</dd>
</dl>
</li>
</ul>
<dl class="simple">
<dt><strong>Important Notes:</strong></dt><dd><ul class="simple">
<li><p>Assumes that <cite>get_database()</cite> repopulates the tree view with current configuration data.</p></li>
<li><p>Assumes <cite>getIpAddress()</cite> returns a string representing the Modbus server’s current IP address.</p></li>
<li><p>The <cite>ip_address_label</cite> widget must already be defined and configured in the GUI for the IP update to display correctly.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="live_search">
<span class="sig-name descname"><span class="pre">live_search</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#live_search" title="Link to this definition"></a></dt>
<dd><p>Filters and displays tree view rows based on a live search query entered by the user in the search bar. If no matches are found, an informational dialog is shown.</p>
<dl class="simple">
<dt>This function performs the following steps:</dt><dd><ul class="simple">
<li><p>Retrieves the user’s input from the search bar and converts it to lowercase.</p></li>
<li><p>Temporarily detaches all items from the tree view to prepare for filtering.</p></li>
<li><p>Iterates through stored data (<cite>self.data</cite>) and reattaches only the items that match the search query.</p></li>
<li><p>If no matches are found, displays a message box notifying the user.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;KeyRelease&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_search</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">param event<span class="colon">:</span></dt>
<dd class="field-odd"><p>Automatically passed by event bindings (optional).</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Data Requirements:</strong></dt><dd><ul class="simple">
<li><dl class="simple">
<dt><cite>self.data</cite> should be a list of tuples in the form <cite>(values, iid)</cite>, where:</dt><dd><ul>
<li><p><cite>values</cite> is an iterable of displayed column values,</p></li>
<li><p><cite>iid</cite> is the item identifier in the tree view.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p><cite>self.search_bar</cite> should be an input widget (e.g., <cite>Entry</cite>) containing the search query.</p></li>
<li><p><cite>self.tree</cite> should be a <cite>ttk.Treeview</cite> widget.</p></li>
</ul>
</dd>
<dt><strong>Behavior:</strong></dt><dd><ul class="simple">
<li><p>The search is case-insensitive and matches substrings within any of the row values.</p></li>
<li><p>Matching rows are reattached to the tree; all others remain detached.</p></li>
<li><p>If no matches are found, a message box is shown with a “No match found” message.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sort_table">
<span class="sig-name descname"><span class="pre">sort_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sort_table" title="Link to this definition"></a></dt>
<dd><p>Sorts the entries in the tree view based on the selected criterion from a dropdown menu. Sorting options include modification order and Modbus address values.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Retrieves the current sorting option from a dropdown selection.</p></li>
<li><p>Collects all tree view items and their associated data.</p></li>
<li><dl class="simple">
<dt>Sorts the data based on the selected criterion:</dt><dd><ul>
<li><p><strong>First Modified</strong>: Sorts by original order (ascending by <cite>text</cite> field(an invisible column which carries values similar to an identification number)).</p></li>
<li><p><strong>Last Modified</strong>: Sorts by reverse order (descending by <cite>text</cite> field).</p></li>
<li><p><strong>Ascending Modbus Address</strong>: Sorts entries by the Modbus address in ascending order.</p></li>
<li><p><strong>Descending Modbus Address</strong>: Sorts entries by the Modbus address in descending order.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Reassigns serial numbers to each item based on the new order.</p></li>
<li><p>Moves each item in the tree view to reflect the sorted arrangement.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">dropdown</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;ComboboxSelected&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_table</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">param event<span class="colon">:</span></dt>
<dd class="field-odd"><p>Optional event object from GUI interactions.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Dependencies and Assumptions:</strong></dt><dd><ul class="simple">
<li><p><cite>self.dropdown</cite>: A dropdown widget (<cite>ttk.Combobox</cite>) used to select the sorting criterion.</p></li>
<li><p><cite>self.tree</cite>: A <cite>ttk.Treeview</cite> widget that displays rows of data.</p></li>
<li><p>The <cite>values</cite> for each tree item must be a list where the 4th value (<cite>values[3]</cite>) represents the Modbus address.</p></li>
<li><p>The <cite>text</cite> field of each item is used as a sortable ID (typically representing insertion order).</p></li>
</ul>
</dd>
<dt><strong>Sorting Behavior:</strong></dt><dd><ul class="simple">
<li><p>Each tree item’s serial number (first column value) is updated to reflect its position after sorting.</p></li>
<li><p>Items are visually reordered in the GUI using <cite>tree.move()</cite>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="get_available_address">
<span class="sig-name descname"><span class="pre">get_available_address</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#get_available_address" title="Link to this definition"></a></dt>
<dd><p>Opens a new window displaying a list of available Modbus address ranges retrieved from the backend. The data is shown in a scrollable table with columns for serial number, address range, range size, and usability.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Creates a new <cite>Toplevel</cite> window titled “Available Addresses”.</p></li>
<li><p>Retrieves available address data using the <cite>updateReusableAddress(“test”)</cite> function.</p></li>
<li><p>Constructs a scrollable <cite>ttk.Treeview</cite> table to present the address range data.</p></li>
<li><p>Populates the table with the retrieved data.</p></li>
<li><p>If an error occurs during address retrieval, displays an error dialog using <cite>messagebox.showerror</cite>.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">get_available_address</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>UI Elements Created:</strong></dt><dd><ul class="simple">
<li><p>A new <cite>Toplevel</cite> window (<cite>self.available_address_window</cite>) sized 800x300.</p></li>
<li><dl class="simple">
<dt>A scrollable <cite>ttk.Treeview</cite> (<cite>self.tree_available</cite>) with the following columns:</dt><dd><ul>
<li><p><strong>S/N</strong>: Serial number (auto-incremented).</p></li>
<li><p><strong>Available Range</strong>: The Modbus address range available.</p></li>
<li><p><strong>Range Size</strong>: Size of the address range.</p></li>
<li><p><strong>Usability</strong>: Whether the range is consumable or not.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt><strong>Data Source:</strong></dt><dd><ul class="simple">
<li><p>Uses <cite>updateReusableAddress(“test”)</cite> to fetch available address ranges.</p></li>
<li><dl class="simple">
<dt>Expects a list of dictionaries, each containing:</dt><dd><ul>
<li><p><cite>“modbusAddressRange”</cite> (str),</p></li>
<li><p><cite>“size”</cite> (int),</p></li>
<li><p><cite>“consumable”</cite> (bool or str indicating usability).</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt><strong>Error Handling:</strong></dt><dd><ul class="simple">
<li><p>If the response is a dictionary with an <cite>“error”</cite> key, an error message box is shown.</p></li>
</ul>
</dd>
<dt><strong>Notes:</strong></dt><dd><ul class="simple">
<li><p>The function assumes that all UI elements (e.g., <cite>tk</cite>, <cite>ttk</cite>, and <cite>messagebox</cite>) are properly imported and available.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="delete_selected">
<span class="sig-name descname"><span class="pre">delete_selected</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#delete_selected" title="Link to this definition"></a></dt>
<dd><p>Deletes one or more selected entries from the tree view and the backend database after user confirmation. If deletion is successful, the view is refreshed and a success message is shown.</p>
<dl class="simple">
<dt>This function performs the following steps:</dt><dd><ul class="simple">
<li><p>Retrieves selected items from the tree view.</p></li>
<li><p>If no item is selected, displays an error dialog prompting the user to select one.</p></li>
<li><p>Prompts the user with a confirmation dialog before deletion.</p></li>
<li><dl class="simple">
<dt>For each selected item:</dt><dd><ul>
<li><p>Extracts the radio MAC address from the item’s values.</p></li>
<li><p>Calls <cite>deleteXbeeDetails()</cite> to remove the corresponding entry from the backend.</p></li>
<li><p>If successful, deletes the item from the tree view.</p></li>
<li><p>If an error occurs during deletion, displays an error message.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Refreshes the UI by calling <cite>self.refresh()</cite> and shows a success message if deletions completed.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">delete_selected</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>User Prompts:</strong></dt><dd><ul class="simple">
<li><p>If nothing is selected: shows <cite>“Please select an item to delete.”</cite></p></li>
<li><p>Before deletion: asks for confirmation via <cite>“Are you sure you want to proceed?”</cite></p></li>
<li><p>After success: shows <cite>“Entry deleted successfully.”</cite></p></li>
</ul>
</dd>
<dt><strong>Assumptions:</strong></dt><dd><ul class="simple">
<li><p>The third value (<cite>values[2]</cite>) of each tree item contains the radio MAC address.</p></li>
<li><p><cite>deleteXbeeDetails(mac_address)</cite> returns a dictionary and uses an <cite>“error”</cite> key to indicate failure.</p></li>
<li><p><cite>self.refresh()</cite> updates the view after deletion.</p></li>
</ul>
</dd>
<dt><strong>Error Handling:</strong></dt><dd><ul class="simple">
<li><p>No selection: shows an error dialog.</p></li>
<li><p>Backend error during deletion: shows the error message in a dialog.</p></li>
</ul>
</dd>
<dt><strong>Notes:</strong></dt><dd><ul class="simple">
<li><p>The tree view must use the <cite>ttk.Treeview</cite> widget.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="id17">
<h3>Notes<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>The GUI is designed for 800x650 resolution</p></li>
<li><p>All database operations are reflected immediately in the UI</p></li>
<li><p>Input validation is performed for Modbus addresses</p></li>
<li><p>Confirmation dialogs are shown for destructive operations</p></li>
</ul>
</section>
</section>
<section id="dbintegration">
<span id="id18"></span><h2>dbIntegration<a class="headerlink" href="#dbintegration" title="Link to this heading"></a></h2>
<p>This module manages all MongoDB-related operations for the XBee Modbus Gateway system. It handles:</p>
<ul class="simple">
<li><p>Configuration, validation, and updating of XBee radio metadata such as MAC addresses, Modbus start/end addresses, and node identifiers.</p></li>
<li><p>Ensuring Modbus address allocation is valid and conflict-free using range validation and gap detection.</p></li>
<li><p>Updating and retrieving reusable Modbus address ranges for dynamic allocation.</p></li>
<li><p>Managing historical data storage for each XBee radio, supporting initialization, updates, and full data swaps in cases of MAC address reassignment.</p></li>
<li><p>Providing database interfaces for querying and modifying the Modbus address map and XBee radio assignments.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The MongoDB schema is optimized for time-series storage, and each XBee device is</p>
</div>
<p>tracked using its 64-bit MAC address.</p>
<section id="id19">
<h3>Module Setup<a class="headerlink" href="#id19" title="Link to this heading"></a></h3>
<section id="modules-dependencies">
<h4>Modules &amp; Dependencies<a class="headerlink" href="#modules-dependencies" title="Link to this heading"></a></h4>
<p>The following standard and third-party modules are imported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code>, <code class="docutils literal notranslate"><span class="pre">random</span></code>, <code class="docutils literal notranslate"><span class="pre">string</span></code>:
Core Python modules used for timestamps, ID generation, and text manipulation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pymongo</span></code>, <code class="docutils literal notranslate"><span class="pre">pymongo.errors.PyMongoError</span></code>:
MongoDB driver for Python and exception handling for database operations.</p></li>
</ul>
<p>Application-specific modules:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">modules.variables</span></code>:
Stores shared runtime variables and configuration constants.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.modbus</span></code>:
Provides:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">getIpAddress</span></code>: Retrieves the current IP address of the device, used to bind the MongoDB client to the local network interface.</p></li>
</ul>
</li>
</ul>
</section>
<section id="mongodb-collections">
<h4>MongoDB Collections<a class="headerlink" href="#mongodb-collections" title="Link to this heading"></a></h4>
<p>Two main MongoDB collections are initialized:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code>:
Stores metadata for each configured XBee device, such as MAC address, Modbus address range, and human-readable identifier.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">availableModbusAddressCollection</span></code>:
Maintains a list of reusable Modbus address ranges freed after device deletion or reallocation.</p></li>
</ul>
</section>
<section id="database-initialization">
<h4>Database Initialization<a class="headerlink" href="#database-initialization" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dbclient</span> <span class="pre">=</span> <span class="pre">pymongo.MongoClient(...)</span></code>:
Initializes the MongoDB client connection using the host IP determined by <code class="docutils literal notranslate"><span class="pre">getIpAddress()</span></code> from <code class="docutils literal notranslate"><span class="pre">modules.modbus</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gatewaDb</span> <span class="pre">=</span> <span class="pre">dbclient[&quot;Gateway&quot;]</span></code>:
References the main MongoDB database used by the gateway system.</p></li>
</ul>
</section>
</section>
<section id="modbusaddresspolice">
<h3>modbusAddressPolice<a class="headerlink" href="#modbusaddresspolice" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">modbusAddressPolice</span><span class="p">(</span><span class="n">proposedStartAddress</span><span class="p">,</span> <span class="n">supposedEndAddress</span><span class="p">)</span>
</pre></div>
</div>
<p>Validates whether a given Modbus address range is available and conforms to system constraints.</p>
<blockquote>
<div><p>This function checks whether a proposed range of Modbus register addresses is:
- within allowable numeric bounds,
- not overlapping with any existing Modbus address ranges already registered in the system,
- and structurally valid according to defined system-wide rules.</p>
<p>It is typically used during the configuration or onboarding of new XBee radio nodes to ensure
that each device is mapped to a safe and unique holding register range in the Modbus server context.</p>
<dl class="field-list">
<dt class="field-odd">param int proposedStartAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The first Modbus holding register address being proposed for
assignment (e.g., 40001).</p>
</dd>
<dt class="field-even">param int supposedEndAddress<span class="colon">:</span></dt>
<dd class="field-even"><p>The last Modbus holding register address (inclusive) being
proposed.</p>
</dd>
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>Returns a validation result object:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> — if the proposed range is valid and available.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{&quot;error&quot;:</span> <span class="pre">&quot;&lt;reason&gt;&quot;}</span></code> — if the proposed range is</p></li>
</ul>
<p>invalid or would conflict with existing addresses.</p>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>Union[bool, dict]</p>
</dd>
</dl>
</div></blockquote>
<section id="validation-logic">
<h4>Validation Logic<a class="headerlink" href="#validation-logic" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>The start address must be less than or equal to the end address.</p></li>
<li><p>The length (number of digits) of the start address must conform to the <cite>validModbusAddressLength</cite> constraint defined in <cite>variables</cite>.</p></li>
<li><p>The range must fall within bounds set by <cite>variables.lowestRegister</cite> and <cite>variables.highestRegister</cite>.</p></li>
<li><p>The address range must not overlap with any existing ranges stored in the <cite>configuredRadioCollection</cite> MongoDB collection.</p></li>
</ul>
</div></blockquote>
</section>
<section id="overlapping-address-rule">
<h4>Overlapping Address Rule:<a class="headerlink" href="#overlapping-address-rule" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Two address ranges are considered overlapping if:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>proposedStart &lt;= existingEnd and proposedEnd &gt;= existingStart
</pre></div>
</div>
</div></blockquote>
</section>
<section id="example-usage">
<h4>Example Usage:<a class="headerlink" href="#example-usage" title="Link to this heading"></a></h4>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">modbusAddressPolice</span><span class="p">(</span><span class="mi">40021</span><span class="p">,</span> <span class="mi">40040</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modbus address range is valid.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Address validation failed:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="error-response-format">
<h4>Error Response Format:<a class="headerlink" href="#error-response-format" title="Link to this heading"></a></h4>
<blockquote>
<div><p>When validation fails, the function returns a dictionary of the form:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Descriptive error message&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="typical-errors">
<h4>Typical Errors:<a class="headerlink" href="#typical-errors" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>“Start address cannot be greater than end address”</p></li>
<li><p>“Invalid modbus address”</p></li>
<li><p>“Modbus address out of range”</p></li>
<li><p>“Could not update: Selected modbus startAddress would cause address overlapping”</p></li>
<li><p>Any internal exception is returned as an error string</p></li>
</ul>
</div></blockquote>
</section>
<section id="id20">
<h4>Dependencies:<a class="headerlink" href="#id20" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>Uses global <cite>variables</cite> module to access:
- <cite>lowestRegister</cite>
- <cite>highestRegister</cite>
- <cite>validModbusAddressLength</cite></p></li>
<li><p>Reads from <cite>configuredRadioCollection</cite>, a MongoDB collection containing all configured devices and their Modbus address ranges.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="updatereusableaddress">
<h3>updateReusableAddress<a class="headerlink" href="#updatereusableaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">updateReusableAddress</span><span class="p">(</span><span class="n">returnData</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Scans configured Modbus address allocations and updates the database with all available (unused) address ranges.</p>
<blockquote>
<div><p>This utility function is essential for maintaining visibility into unallocated Modbus holding register blocks. It identifies address gaps between already-configured devices and updates the <cite>availableModbusAddressCollection</cite> accordingly. The available ranges can then be reused when configuring new XBee devices.</p>
<dl class="field-list">
<dt class="field-odd">param bool returnData<span class="colon">:</span></dt>
<dd class="field-odd"><p>Optional. If set, the function returns the list of available address blocks as a list of dictionaries.
If <cite>None</cite> (default), the function runs silently and only populates the database.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>If <cite>returnData</cite> is <cite>None</cite>, returns <cite>None</cite>.</p></li>
<li><p>If address gaps are found, returns a list of available range objects:</p></li>
</ul>
<blockquote>
<div><div class="highlight-json notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<dl class="simple">
<dt>[</dt><dd><dl class="simple">
<dt>{</dt><dd><p>“modbusAddressRange”: “4010-4030”,
“size”: 21,
“consumable”: “✅”</p>
</dd>
</dl>
</dd>
</dl>
<p>]</p>
</div></blockquote>
<ul>
<li><p>If no address gaps exist, returns:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No available address gaps found.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>If an error occurs, returns a dictionary with <cite>error</cite> and optional <cite>details</cite>.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>Union[None, list, dict]</p>
</dd>
</dl>
</div></blockquote>
<section id="function-overview">
<h4>Function Overview<a class="headerlink" href="#function-overview" title="Link to this heading"></a></h4>
<blockquote>
<div><p>This function performs the following steps:</p>
<ol class="arabic simple">
<li><p><strong>Drops the `availableModbusAddressCollection`</strong> to clear outdated data.</p></li>
<li><p><strong>Retrieves all configured address ranges</strong> from <cite>configuredRadioCollection</cite>.</p></li>
<li><p><strong>Sorts</strong> the address ranges by <cite>modbusStartAddress</cite>.</p></li>
<li><p><strong>Scans for gaps</strong> between configured ranges:
- A “gap” is defined as an unused range between two allocated address blocks.
- Gaps are considered <strong>consumable</strong> if their size is greater than or equal to <cite>variables.incrementalModbusAddress</cite>.</p></li>
<li><p><strong>Stores valid gaps</strong> in <cite>availableModbusAddressCollection</cite>, each with:
- <cite>modbusAddressRange</cite>: The range in “start-end” format.
- <cite>size</cite>: Number of registers in the gap.
- <cite>consumable</cite>: “✅” if usable, “❌” otherwise.</p></li>
<li><p><strong>Optionally returns the result</strong> if <cite>returnData</cite> is specified.</p></li>
</ol>
</div></blockquote>
</section>
<section id="gap-detection-algorithm">
<h4>Gap Detection Algorithm<a class="headerlink" href="#gap-detection-algorithm" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Gaps are identified by comparing the <cite>endAddress</cite> of a configured device with the <cite>startAddress</cite> of the next:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">startAddress</span> <span class="o">-</span> <span class="n">previousEnd</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">gapStart</span> <span class="o">=</span> <span class="n">previousEnd</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gapEnd</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The final unallocated range (from the last used address to the highest possible register) is also checked.</p>
</div></blockquote>
</section>
<section id="consumable-criteria">
<h4>Consumable Criteria<a class="headerlink" href="#consumable-criteria" title="Link to this heading"></a></h4>
<blockquote>
<div><p>A gap is marked as <strong>consumable</strong> (<cite>✅</cite>) only if:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gapSize</span> <span class="o">&gt;=</span> <span class="n">variables</span><span class="o">.</span><span class="n">incrementalModbusAddress</span>
</pre></div>
</div>
<p>Otherwise, it is marked as <strong>not consumable</strong> (<cite>❌</cite>).</p>
</div></blockquote>
</section>
<section id="id21">
<h4>Error Handling<a class="headerlink" href="#id21" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>MongoDB <cite>insert_one</cite> failures are caught and returned with detailed error messages.</p></li>
<li><p>General exceptions are caught and returned with an <cite>“error”</cite> key.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id22">
<h4>Dependencies<a class="headerlink" href="#id22" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>MongoDB collections:</p>
<ul>
<li><p><cite>configuredRadioCollection</cite> (read-only)</p></li>
<li><p><cite>availableModbusAddressCollection</cite> (dropped and written)</p></li>
</ul>
</li>
<li><p>Variables from the <cite>variables</cite> module:</p>
<ul>
<li><p><cite>lowestRegister</cite></p></li>
<li><p><cite>highestRegister</cite></p></li>
<li><p><cite>incrementalModbusAddress</cite></p></li>
</ul>
</li>
<li><p>Requires <cite>PyMongoError</cite> for database exception handling.</p></li>
</ul>
</div></blockquote>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h4>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run silently</span>
<span class="n">updateReusableAddress</span><span class="p">()</span>

<span class="c1"># Run and fetch results for further processing</span>
<span class="n">availableBlocks</span> <span class="o">=</span> <span class="n">updateReusableAddress</span><span class="p">(</span><span class="n">returnData</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">availableBlocks</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">&quot;modbusAddressRange&quot;</span><span class="p">],</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;consumable&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="updateallendaddress">
<h3>updateAllEndAddress<a class="headerlink" href="#updateallendaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">updateAllEndAddress</span><span class="p">(</span><span class="n">newRange</span><span class="p">)</span>
</pre></div>
</div>
<p>Recalculates and updates the <cite>modbusEndAddress</cite> field for all configured radios using a uniform range size derived from the provided <cite>newRange</cite> value.</p>
<blockquote>
<div><p>This function is useful when there’s a global change in how many Modbus registers should be allocated per device. It ensures all documents in the <cite>configuredRadioCollection</cite> reflect this new register allocation model, based on their existing <cite>modbusStartAddress</cite>.</p>
<dl class="field-list">
<dt class="field-odd">param int newRange<span class="colon">:</span></dt>
<dd class="field-odd"><p>The number of Modbus registers to assign per device. The function adds <cite>(newRange - 1)</cite> to each device’s <cite>modbusStartAddress</cite> to compute the new <cite>modbusEndAddress</cite>.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul>
<li><p>If updates are made:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;sucess&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;updated 25&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>(Where 25 is the number of documents updated.)</p>
</li>
<li><p>If an error occurs during the update operation:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Descriptive error message&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>If no <cite>modbusStartAddress</cite> is found, or no documents are modified, returns <cite>None</cite>.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>Union[dict, None]</p>
</dd>
</dl>
</div></blockquote>
<section id="functional-summary">
<h4>Functional Summary<a class="headerlink" href="#functional-summary" title="Link to this heading"></a></h4>
<p>This function:</p>
<blockquote>
<div><ol class="arabic">
<li><p><strong>Queries all radio documents</strong> from <cite>configuredRadioCollection</cite> that have a <cite>modbusStartAddress</cite>.</p></li>
<li><p><strong>Calculates</strong> the new <cite>modbusEndAddress</cite> for each document as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">newEndAddress</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">newRange</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Performs a batch update</strong> using <cite>bulk_write()</cite> with <cite>UpdateOne</cite> operations to apply changes efficiently.</p></li>
<li><p><strong>Calls `updateReusableAddress()`</strong> to refresh available address blocks after modifications.</p></li>
<li><p><strong>Returns</strong> the number of modified documents or an error response.</p></li>
</ol>
</div></blockquote>
</section>
<section id="id23">
<h4>Error Handling<a class="headerlink" href="#id23" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>All exceptions are caught and returned as a dictionary with an <cite>error</cite> key.</p></li>
<li><p>If the <cite>bulk_write()</cite> operation fails or modifies nothing, the function silently returns <cite>None</cite>.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id24">
<h4>Dependencies<a class="headerlink" href="#id24" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>MongoDB collection:</p>
<ul>
<li><p><cite>configuredRadioCollection</cite> (read and write)</p></li>
</ul>
</li>
<li><p>External function:</p>
<ul>
<li><p><cite>updateReusableAddress()</cite> — called after successful updates to refresh available address gaps.</p></li>
</ul>
</li>
<li><p>Libraries:</p>
<ul>
<li><p><cite>pymongo.UpdateOne</cite> and <cite>bulk_write</cite></p></li>
</ul>
</li>
</ul>
</div></blockquote>
</section>
<section id="performance-note">
<h4>Performance Note<a class="headerlink" href="#performance-note" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>The use of <cite>bulk_write()</cite> ensures efficient updating even for large numbers of documents.</p></li>
<li><p>The function assumes the presence of a valid <cite>modbusStartAddress</cite> in each document.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id25">
<h4>Example Usage<a class="headerlink" href="#id25" title="Link to this heading"></a></h4>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update all configured radios to use 20 Modbus registers each</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">updateAllEndAddress</span><span class="p">(</span><span class="n">newRange</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="related-functions">
<h4>Related Functions<a class="headerlink" href="#related-functions" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">updateReusableAddress()</span></code> — updates the list of reusable Modbus address gaps based on current configurations.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="dbquerymodbusstartaddress">
<h3>dbQueryModbusStartAddress<a class="headerlink" href="#dbquerymodbusstartaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">)</span>
</pre></div>
</div>
<p>Retrieves the configured Modbus start address for a given XBee MAC address from the database.</p>
<p>This function performs a lookup in the <code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code> to find the <code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code> associated with a specific XBee radio. It is typically used during Modbus polling to determine where sensor data from each radio should be written in the Modbus context.</p>
<dl class="field-list simple">
<dt class="field-odd">param str xbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The 64-bit MAC address of the XBee device, provided as a string. The function automatically converts the address to uppercase to match the format stored in the database.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>If the MAC address exists in the database, returns the integer value of <code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code>.</p></li>
<li><p>If the MAC address is not found, returns a string indicating that the address is missing.</p></li>
<li><p>If an exception occurs, prints the error and returns it as a string.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>Union[int, str]</p>
</dd>
</dl>
<section id="id26">
<h4>Function Overview<a class="headerlink" href="#id26" title="Link to this heading"></a></h4>
<p>This function executes the following steps:</p>
<ol class="arabic simple">
<li><p>Converts the provided MAC address to uppercase.</p></li>
<li><p>Searches the <code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code> for a matching <code class="docutils literal notranslate"><span class="pre">xbeeMac</span></code> value.</p></li>
<li><p>If a matching document is found, extracts and returns the <code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code>.</p></li>
<li><p>If no document is found, returns a descriptive message.</p></li>
<li><p>Catches and prints any exceptions, returning the error message.</p></li>
</ol>
</section>
<section id="usage-context">
<h4>Usage Context<a class="headerlink" href="#usage-context" title="Link to this heading"></a></h4>
<p>This function is called inside the Modbus polling logic to determine the register block for each XBee:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startAddress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
    <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id27">
<h4>Error Handling<a class="headerlink" href="#id27" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Wraps all logic in a try-except block.</p></li>
<li><p>On failure, prints the error message and returns it.</p></li>
<li><p>Ensures the main polling loop remains stable during faults.</p></li>
</ul>
</section>
<section id="id28">
<h4>Dependencies<a class="headerlink" href="#id28" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>MongoDB collection:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code> — stores XBee device configurations and associated Modbus address mappings.</p></li>
</ul>
</li>
</ul>
</section>
<section id="id29">
<h4>Example<a class="headerlink" href="#id29" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mac</span> <span class="o">=</span> <span class="s2">&quot;0013A20040B41234&quot;</span>
<span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startAddress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start address: </span><span class="si">{</span><span class="n">startAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error or not found: </span><span class="si">{</span><span class="n">startAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="configurexbeeradio">
<h3>configureXbeeRadio<a class="headerlink" href="#configurexbeeradio" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configureXbeeRadio</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">nodeIdentifier</span><span class="p">)</span>
</pre></div>
</div>
<p>Registers a new XBee radio device in the system by associating it with a unique MAC address, Modbus register block, and node identifier.</p>
<blockquote>
<div><p>This function performs comprehensive validation to ensure no conflicts exist in the configured Modbus address space or device identifiers. It calculates the Modbus <strong>end address internally</strong> using the formula:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">endAddress</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">incrementalModbusAddress</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>On success, it updates the database and creates a dedicated collection for storing historical data for that device.</p>
<dl class="field-list">
<dt class="field-odd">param str xbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The 64-bit MAC address of the XBee radio to configure (e.g., <code class="docutils literal notranslate"><span class="pre">0013A20040B2C3D4</span></code>). Must be uppercase and 16 characters long.</p>
</dd>
<dt class="field-even">param int startAddress<span class="colon">:</span></dt>
<dd class="field-even"><p>The starting Modbus register address for this device. Must be an integer and not conflict with existing device ranges.</p>
</dd>
<dt class="field-odd">param str nodeIdentifier<span class="colon">:</span></dt>
<dd class="field-odd"><p>A unique, human-readable label for the device (e.g., <code class="docutils literal notranslate"><span class="pre">WELLHEAD_A01</span></code>). Cannot be empty or reused.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul>
<li><p>On success:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;radio configured successfully&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On validation failure (e.g., duplicates, format errors):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Start address already utilized by WELLHEAD_A01&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On general exception:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Exception message&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</div></blockquote>
<section id="address-calculation">
<h4>Address Calculation<a class="headerlink" href="#address-calculation" title="Link to this heading"></a></h4>
<ul>
<li><p>The function automatically derives the Modbus <cite>endAddress</cite> using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">endAddress</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">incrementalModbusAddress</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>This defines the register block [startAddress, endAddress] inclusive.</p></li>
</ul>
</section>
<section id="id30">
<h4>Validation Logic<a class="headerlink" href="#id30" title="Link to this heading"></a></h4>
<ol class="arabic simple">
<li><p><strong>MAC Address:</strong>
- Must be uppercase and 16 characters long.
- Must not already exist in <cite>configuredRadioCollection</cite>.</p></li>
<li><p><strong>Start Address:</strong>
- Must be a valid integer.
- Must not be already used as a start address.
- Must not overlap with any existing Modbus block (validated by <cite>modbusAddressPolice()</cite>).</p></li>
<li><p><strong>Node Identifier:</strong>
- Cannot be empty.
- Must be unique across configured devices.</p></li>
</ol>
</section>
<section id="configuration-actions">
<h4>Configuration Actions<a class="headerlink" href="#configuration-actions" title="Link to this heading"></a></h4>
<ul>
<li><p>Inserts the following document into <cite>configuredRadioCollection</cite>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;xbeeNodeIdentifier&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NODE1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;xbeeMac&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;modbusStartAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4001</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;modbusEndAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4050</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Creates a MongoDB collection named after the MAC address (e.g., <cite>0013A20040B2C3D4</cite>) for storing historical radio data. The collection is seeded with:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-05-06T12:00:00&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Triggers a call to <cite>updateReusableAddress()</cite> to recalculate and store the list of free Modbus address blocks.</p></li>
</ul>
</section>
<section id="id31">
<h4>Dependencies<a class="headerlink" href="#id31" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>MongoDB Collections:
- <cite>configuredRadioCollection</cite>
- <cite>gatewayDb[&lt;xbeeMacAddress&gt;]</cite> (dynamic collection for history)</p></li>
<li><p>Functions:
- <cite>modbusAddressPolice()</cite>
- <cite>updateReusableAddress()</cite></p></li>
<li><p>Constants from <cite>variables</cite>:
- <cite>validMacAddressLength</cite>
- <cite>incrementalModbusAddress</cite></p></li>
</ul>
</section>
<section id="id32">
<h4>Example<a class="headerlink" href="#id32" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configureXbeeRadio</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="mi">4001</span><span class="p">,</span> <span class="s2">&quot;WELLHEAD_A01&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="updatexbeedetails">
<h3>updateXbeeDetails<a class="headerlink" href="#updatexbeedetails" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">updateXbeeDetails</span><span class="p">(</span><span class="n">oldXbeeMacAddress</span><span class="p">,</span> <span class="n">jsonParameterToBeUpdated</span><span class="p">)</span>
</pre></div>
</div>
<p>Updates specific fields of an already-configured XBee radio entry, with full validation of MAC address uniqueness, Modbus register allocation correctness, and node identifier exclusivity.</p>
<blockquote>
<div><p>This function allows updating one or more of the following fields for an existing device:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeMac</span></code> (MAC address)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusEndAddress</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeNodeIdentifier</span></code></p></li>
</ul>
<p>Updates are only accepted if no conflicts exist in the system, and the modified values differ from the existing values.
If address-related fields are modified, the <cite>updateReusableAddress()</cite> utility is automatically triggered to refresh available register gaps. Additionally, if a MAC address is changed, the function <strong>renames the associated historian collection</strong> to match the new MAC.</p>
<dl class="field-list">
<dt class="field-odd">param str oldXbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The current MAC address of the XBee device to update.
Must already exist in the <cite>configuredRadioCollection</cite>.</p>
</dd>
<dt class="field-even">param dict jsonParameterToBeUpdated<span class="colon">:</span></dt>
<dd class="field-even"><p>A dictionary containing one or more keys to update.
Only the following keys are allowed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeMac</span></code> (str)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code> (int)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusEndAddress</span></code> (int)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeNodeIdentifier</span></code> (str)</p></li>
</ul>
</dd>
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><ul>
<li><p>On success:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Document updated successfully.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On validation failure:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;new mac address already exist&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On redundant request (no change detected):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Update request received, but no changes were made.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On general exception:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Exception message&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</div></blockquote>
<section id="input-validations">
<h4>Input Validations<a class="headerlink" href="#input-validations" title="Link to this heading"></a></h4>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">jsonParameterToBeUpdated</span></code> must be a <cite>dict</cite>. Otherwise:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Structure of updated value is invalid. Expected a dictionary.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Only the allowed keys are permitted. If unknown keys are found:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid keys found: [&#39;badKey&#39;]. Allowed keys: [...]&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="mac-address-update">
<h4>MAC Address Update<a class="headerlink" href="#mac-address-update" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Validates that the new MAC:</p>
<ul>
<li><p>Is 16 characters long (as per <cite>variables.validMacAddressLength</cite>)</p></li>
<li><p>Is different from the existing MAC</p></li>
<li><p>Does not already exist in the system</p></li>
</ul>
</li>
<li><p>If valid:</p>
<ul>
<li><p>The existing historian collection under <cite>gatewayDb[oldXbeeMacAddress]</cite> is <strong>renamed</strong> to the new MAC.</p></li>
</ul>
</li>
</ul>
</section>
<section id="modbus-address-update">
<h4>Modbus Address Update<a class="headerlink" href="#modbus-address-update" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>If either <cite>modbusStartAddress</cite> or <cite>modbusEndAddress</cite> is updated:</p>
<ul>
<li><p>The function resolves both values, using provided ones or falling back to existing ones.</p></li>
<li><p>The range is validated using <cite>modbusAddressPolice(start, end)</cite>.</p></li>
<li><p>If valid, the update is flagged to <strong>refresh address gaps</strong> via <cite>updateReusableAddress()</cite> after DB update.</p></li>
</ul>
</li>
</ul>
</section>
<section id="node-identifier-update">
<h4>Node Identifier Update<a class="headerlink" href="#node-identifier-update" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>The new identifier:</p>
<ul>
<li><p>Must not be empty.</p></li>
<li><p>Must be different from the existing one.</p></li>
<li><p>Must not be already used by another radio.</p></li>
</ul>
</li>
</ul>
</section>
<section id="update-workflow">
<h4>Update Workflow<a class="headerlink" href="#update-workflow" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Normalize all string inputs to uppercase.</p></li>
<li><p>Validate each requested change:</p>
<ul class="simple">
<li><p>MAC → uniqueness and length</p></li>
<li><p>Modbus → address overlap prevention</p></li>
<li><p>Node ID → uniqueness and validity</p></li>
</ul>
</li>
<li><p>Perform atomic update via:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="n">oldXbeeMacAddress</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">updates</span><span class="p">})</span>
</pre></div>
</div>
</li>
<li><p>If a Modbus address was changed:</p>
<ul class="simple">
<li><p>Call <cite>updateReusableAddress()</cite> to recalculate and store new available blocks.</p></li>
</ul>
</li>
</ol>
</section>
<section id="side-effects">
<h4>Side Effects<a class="headerlink" href="#side-effects" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Historian collection is <strong>renamed</strong> if MAC is updated.</p></li>
<li><p>Modbus address availability is <strong>recalculated</strong> if start/end address is changed.</p></li>
</ul>
</section>
<section id="id33">
<h4>Dependencies<a class="headerlink" href="#id33" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>MongoDB collections:</p>
<ul>
<li><p><cite>configuredRadioCollection</cite></p></li>
<li><p><cite>gatewayDb[&lt;xbeeMac&gt;]</cite> (for renaming historian)</p></li>
</ul>
</li>
<li><p>Internal functions:</p>
<ul>
<li><p><cite>modbusAddressPolice()</cite></p></li>
<li><p><cite>updateReusableAddress()</cite></p></li>
</ul>
</li>
<li><p>Variables from <cite>variables</cite>:</p>
<ul>
<li><p><cite>validMacAddressLength</cite></p></li>
</ul>
</li>
</ul>
</section>
<section id="id34">
<h4>Example<a class="headerlink" href="#id34" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update MAC address and start address</span>
<span class="n">updateXbeeDetails</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="s2">&quot;0013A20040B2C3D9&quot;</span><span class="p">,</span>
    <span class="s2">&quot;modbusStartAddress&quot;</span><span class="p">:</span> <span class="mi">4060</span>
<span class="p">})</span>

<span class="c1"># Update only node identifier</span>
<span class="n">updateXbeeDetails</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;xbeeNodeIdentifier&quot;</span><span class="p">:</span> <span class="s2">&quot;WELLHEAD_B07&quot;</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="storexbeehistorydata">
<h3>storeXbeeHistoryData<a class="headerlink" href="#storexbeehistorydata" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">storeXbeeHistoryData</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">,</span> <span class="n">xbeeData</span><span class="p">,</span> <span class="n">xbeeDataTimestamp</span><span class="p">)</span>
</pre></div>
</div>
<p>Stores a timestamped data snapshot from an XBee device into a dedicated MongoDB historian collection named after the XBee MAC address.</p>
<blockquote>
<div><p>This function is intended to be called whenever a new packet of radio sensor data is received. It verifies the MAC address has been configured, ensures the data is correctly structured as a list, and inserts it into a corresponding MongoDB collection (one collection per radio, named by MAC).</p>
<dl class="field-list simple">
<dt class="field-odd">param str xbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>MAC address of the radio node. Must match a previously configured device in <cite>configuredRadioCollection</cite>.</p>
</dd>
<dt class="field-even">param list xbeeData<span class="colon">:</span></dt>
<dd class="field-even"><p>List of sensor or telemetry values received from the XBee device. Must be of list type.</p>
</dd>
<dt class="field-odd">param datetime xbeeDataTimestamp<span class="colon">:</span></dt>
<dd class="field-odd"><p>A <cite>datetime</cite> object representing when the data was received. Used as the timestamp for the inserted document.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> on successful insertion into the historian collection.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> on validation failure, database failure, or unexpected exceptions.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool | None</p>
</dd>
</dl>
</div></blockquote>
<section id="input-normalization-and-validation">
<h4>Input Normalization and Validation<a class="headerlink" href="#input-normalization-and-validation" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>MAC Normalization</strong>:
- MAC address is converted to uppercase with <code class="docutils literal notranslate"><span class="pre">str(xbeeMacAddress).upper()</span></code>.</p></li>
<li><p><strong>MAC Existence Check</strong>:
- The function checks if the MAC is registered in <cite>configuredRadioCollection</cite>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="n">xbeeMacAddress</span><span class="p">})</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>If not found, the function logs an error and exits early.</p></li>
</ul>
</li>
<li><p><strong>Data Type Validation</strong>:
- Ensures <cite>xbeeData</cite> is a Python list. If not, it logs the type mismatch and exits.</p></li>
</ol>
</section>
<section id="historian-collection-behavior">
<h4>Historian Collection Behavior<a class="headerlink" href="#historian-collection-behavior" title="Link to this heading"></a></h4>
<ul>
<li><p>A historian collection is automatically created or reused using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeHistoryEntry</span> <span class="o">=</span> <span class="n">gatewayDb</span><span class="p">[</span><span class="n">xbeeMacAddress</span><span class="p">]</span>
</pre></div>
</div>
<p>This ensures:
- Each XBee device gets its own dedicated collection.
- The collection name is the uppercase MAC string (e.g., <cite>0013A20040B2C3D4</cite>).</p>
</li>
</ul>
</section>
<section id="document-structure-example">
<h4>Document Structure Example:<a class="headerlink" href="#document-structure-example" title="Link to this heading"></a></h4>
<p>The inserted document has the structure:</p>
<p>This allows efficient time-series querying and historical graphing.</p>
</section>
<section id="failure-modes">
<h4>Failure Modes<a class="headerlink" href="#failure-modes" title="Link to this heading"></a></h4>
<ul>
<li><p><strong>Unregistered MAC address</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Mac Address has not been configured
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
<li><p><strong>Data is not a list</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Expected data &lt;xbeeData&gt; should be passed as list
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
<li><p><strong>MongoDB insertion fails</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Could not update the database
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
<li><p><strong>Unhandled exception</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Fatal error with details as; &lt;exception string&gt;
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
</ul>
</section>
<section id="id35">
<h4>Dependencies<a class="headerlink" href="#id35" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><strong>MongoDB collections</strong>:
- <cite>configuredRadioCollection</cite>: Verifies MAC address registration.
- <cite>gatewayDb[&lt;xbeeMac&gt;]</cite>: Target collection for historian entries.</p></li>
</ul>
</section>
<section id="id36">
<h4>Example Usage<a class="headerlink" href="#id36" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">storeXbeeHistoryData</span><span class="p">(</span>
    <span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">78.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">33.5</span><span class="p">,</span> <span class="mf">9.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id37">
<h4>Notes<a class="headerlink" href="#id37" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>This function assumes that the historian collections have been initialized via <cite>configureXbeeRadio()</cite>.</p></li>
<li><p>It does <strong>not</strong> check for data schema conformity (e.g., number or type of elements in <cite>xbeeData</cite>) beyond requiring a list.</p></li>
</ul>
<section id="swapxbeehistoryandmacaddress">
<h5>swapXbeeHistoryAndMacAddress<a class="headerlink" href="#swapxbeehistoryandmacaddress" title="Link to this heading"></a></h5>
</section>
<section id="deletexbeedetails">
<h5>deleteXbeeDetails<a class="headerlink" href="#deletexbeedetails" title="Link to this heading"></a></h5>
</section>
<section id="retrieveallconfiguredradio">
<h5>retrieveAllConfiguredRadio<a class="headerlink" href="#retrieveallconfiguredradio" title="Link to this heading"></a></h5>
</section>
<section id="populatedbhelper">
<h5>populateDbHelper<a class="headerlink" href="#populatedbhelper" title="Link to this heading"></a></h5>
</section>
</section>
</section>
</section>
<section id="modbus">
<span id="id38"></span><h2>modbus<a class="headerlink" href="#modbus" title="Link to this heading"></a></h2>
</section>
<section id="serialselector">
<span id="id39"></span><h2>serialSelector<a class="headerlink" href="#serialselector" title="Link to this heading"></a></h2>
</section>
<section id="variables">
<span id="id40"></span><h2>variables<a class="headerlink" href="#variables" title="Link to this heading"></a></h2>
</section>
<section id="xbeedata">
<span id="id41"></span><h2>xbeeData<a class="headerlink" href="#xbeedata" title="Link to this heading"></a></h2>
</section>
<section id="xbeedummydatatransmitter">
<span id="id42"></span><h2>xbeeDummyDataTransmitter<a class="headerlink" href="#xbeedummydatatransmitter" title="Link to this heading"></a></h2>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="usage.html" class="btn btn-neutral float-left" title="Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, n1lby73.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>