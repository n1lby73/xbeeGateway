

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modules &mdash; Xbee-Gateway 2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=60dbed4a"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Usage" href="usage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Xbee-Gateway
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#main">main</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#module-setup">Module Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#xbee-device-initialization">XBee Device Initialization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#xbee-serial-port-selection">XBee Serial Port Selection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-xbeedevice">Creating the XBeeDevice</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fallback-if-device-not-found">Fallback if Device Not Found</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queue-initialization">Queue Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#xbeepolling">xbeePolling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-reception-callback">Data Reception Callback</a></li>
<li class="toctree-l4"><a class="reference internal" href="#new-address-detection">New Address Detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queueing-the-packet">Queueing the Packet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#notes">Notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#commented-out-disconnection-handler">Commented-Out Disconnection Handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modbuspolling">modbusPolling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queue-consumption">Queue Consumption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#register-lookup">Register Lookup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#payload-parsing">Payload Parsing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#float-to-register-conversion">Float to Register Conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-to-modbus-context">Writing to Modbus Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modbusserver">modbusServer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modbus-identity-configuration">Modbus Identity Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dynamic-ip-address-resolution">Dynamic IP Address Resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#server-startup">Server Startup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#port-configuration">Port Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#startprocess">startProcess</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps-breakdown">Steps Breakdown</a></li>
<li class="toctree-l4"><a class="reference internal" href="#concurrency-considerations">Concurrency Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id12">__main__</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#explanation">Explanation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">Summary</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#configgui">configGui</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gui-components">GUI Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#functions">Functions:</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#get_database"><code class="docutils literal notranslate"><span class="pre">get_database()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#add_database"><code class="docutils literal notranslate"><span class="pre">add_database()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#refresh"><code class="docutils literal notranslate"><span class="pre">refresh()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#live_search"><code class="docutils literal notranslate"><span class="pre">live_search()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#sort_table"><code class="docutils literal notranslate"><span class="pre">sort_table()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#get_available_address"><code class="docutils literal notranslate"><span class="pre">get_available_address()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#delete_selected"><code class="docutils literal notranslate"><span class="pre">delete_selected()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#update_selected"><code class="docutils literal notranslate"><span class="pre">update_selected()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#click_update"><code class="docutils literal notranslate"><span class="pre">click_update()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#configure_button"><code class="docutils literal notranslate"><span class="pre">configure_button()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#read_serial_and_modbusport"><code class="docutils literal notranslate"><span class="pre">read_serial_and_modbusport()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#clear_placeholder"><code class="docutils literal notranslate"><span class="pre">clear_placeholder()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#add_placeholder"><code class="docutils literal notranslate"><span class="pre">add_placeholder()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id17">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dbintegration">dbIntegration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id19">Module Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#modules-dependencies">Modules &amp; Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mongodb-collections">MongoDB Collections</a></li>
<li class="toctree-l4"><a class="reference internal" href="#database-initialization">Database Initialization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#modbusaddresspolice">modbusAddressPolice</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#validation-logic">Validation Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overlapping-address-rule">Overlapping Address Rule:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-usage">Example Usage:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-response-format">Error Response Format:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#typical-errors">Typical Errors:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">Dependencies:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updatereusableaddress">updateReusableAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#function-overview">Function Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gap-detection-algorithm">Gap Detection Algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#consumable-criteria">Consumable Criteria</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updateallendaddress">updateAllEndAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#functional-summary">Functional Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance-note">Performance Note</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">Example Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#related-functions">Related Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dbquerymodbusstartaddress">dbQueryModbusStartAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id26">Function Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-context">Usage Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id29">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#configurexbeeradio">configureXbeeRadio</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#address-calculation">Address Calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id30">Validation Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-actions">Configuration Actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id31">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id32">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updatexbeedetails">updateXbeeDetails</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input-validations">Input Validations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mac-address-update">MAC Address Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modbus-address-update">Modbus Address Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#node-identifier-update">Node Identifier Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-workflow">Update Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#side-effects">Side Effects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id33">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#storexbeehistorydata">storeXbeeHistoryData</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input-normalization-and-validation">Input Normalization and Validation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#historian-collection-behavior">Historian Collection Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#document-structure-example">Document Structure Example:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#failure-modes">Failure Modes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id35">Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id36">Example Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id37">Notes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#swapxbeehistoryandmacaddress">swapXbeeHistoryAndMacAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#purpose-and-use-case">Purpose and Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validation-and-normalization">Validation and Normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mongodb-rename-mechanism">MongoDB Rename Mechanism</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mac-field-swapping-in-database">MAC Field Swapping in Database</a></li>
<li class="toctree-l4"><a class="reference internal" href="#success-error-handling">Success &amp; Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id38">Notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id39">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#deletexbeedetails">deleteXbeeDetails</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id40">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validation-and-preparation">Validation and Preparation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deletion-steps">Deletion Steps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#success-criteria">Success Criteria</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id41">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id42">Side Effects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id43">Notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id44">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#retrieveallconfiguredradio">retrieveAllConfiguredRadio</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id45">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-details">Implementation Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#return-value">Return Value</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id46">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id47">Side Effects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id48">Example Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#populatedbhelper">populateDbHelper</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id49">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#purpose">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id50">Implementation Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id51">Return Value</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id52">Side Effects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-output">Example Output</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#main-block-entry">__main__ Block Entry</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id53">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id54">Purpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id55">Implementation Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id56">Return Value</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id57">Side Effects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id58">Example Usage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#modbus">modbus</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id60">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#key-functionalities">Key Functionalities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id61">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id62">Purpose</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#floattoregisters">floatToRegisters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id63">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id64">Implementation Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#contextmanager">contextManager</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id65">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id66">Implementation Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id67">Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#getipaddress">getIpAddress</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id68">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id69">Implementation Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#console-output">Console Output</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-scenario">Usage Scenario</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#serialselector">serialSelector</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id71">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id72">Key Functionalities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id73">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id74">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id75">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#selectusbport">selectUsbPort</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#definition">Definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parameters">Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#returns">Returns</a></li>
<li class="toctree-l4"><a class="reference internal" href="#behavior">Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exceptions-handled">Exceptions Handled</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id76">Example Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cli-mode">CLI Mode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#handleusbdisconnection">handleUsbDisconnection</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id77">Definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id78">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id79">Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id80">Returns</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id81">Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id82">Exceptions Handled</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id83">Example Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spaghetti-code-warning">Spaghetti Code Warning</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#main-execution-block">__main__ Execution Block</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id84">Definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id85">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id86">Behavior</a></li>
<li class="toctree-l4"><a class="reference internal" href="#command-line-usage">Command-Line Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#typical-use-case">Typical Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#note">Note</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#variables">variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id88">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#global-configuration-constants">Global Configuration Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#global-runtime-variables">Global Runtime Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id89">Usage Context</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#xbeedata">xbeeData</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id91">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#key-responsibilities">Key Responsibilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id92">Usage Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id93">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#getnodeid">getNodeId</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id94">Definition</a></li>
<li class="toctree-l4"><a class="reference internal" href="#function-workflow">Function Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id95">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage-status">Usage Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id96">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cayenneparse">cayenneParse</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#decoding-process">Decoding Process</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id97">Example Output</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id98">Usage Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id99">Notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id100">Dependencies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#xbeedummydatatransmitter">xbeeDummyDataTransmitter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id102">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#key-features">Key Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#global-constants">Global Constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xbee-address-definitions">XBee Address Definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#simulated-messages">Simulated Messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#softwareserial-definitions">SoftwareSerial Definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-setup">Function: setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-loop">Function: loop</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-send-transmit-request">Function: send_transmit_request</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-calculatechecksum">Function: calculateChecksum</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-receive-transmit-request-optional-utility">Function: receive_transmit_request (optional utility)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-notes">Usage Notes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Xbee-Gateway</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Modules</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/modules.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="modules">
<h1>Modules<a class="headerlink" href="#modules" title="Link to this heading"></a></h1>
<section id="main">
<span id="id1"></span><h2>main<a class="headerlink" href="#main" title="Link to this heading"></a></h2>
<p>The <cite>main</cite> module is the entry point of the XBee Gateway application. It orchestrates the XBee serial communication, Modbus TCP server, and processing of sensor data from XBee radios. It uses <cite>asyncio</cite> to handle concurrent tasks efficiently.</p>
<section id="module-setup">
<h3>Module Setup<a class="headerlink" href="#module-setup" title="Link to this heading"></a></h3>
<section id="imports">
<h4>Imports<a class="headerlink" href="#imports" title="Link to this heading"></a></h4>
<p>The following standard and third-party modules are imported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sys</span></code>, <code class="docutils literal notranslate"><span class="pre">asyncio</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime</span></code>: Core Python modules for system interaction, concurrency, and time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">digi.xbee.devices.XBeeDevice</span></code> and <code class="docutils literal notranslate"><span class="pre">digi.xbee.exception.XBeeException</span></code>: For managing XBee communication and handling related exceptions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pymodbus.server.StartAsyncTcpServer</span></code> and <code class="docutils literal notranslate"><span class="pre">pymodbus.device.ModbusDeviceIdentification</span></code>: Used to run and identify the Modbus TCP server.</p></li>
<li><p>Application-specific modules:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.variables</span></code>: Stores shared runtime variables such as XBee instance, known MACs, Modbus port, etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.xbeeData.cayenneParse</span></code>: Parses incoming XBee payloads into float values using Cayenne LPP protocol.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.dbIntegration.dbQueryModbusStartAddress</span></code>: Maps MAC addresses to Modbus register start addresses.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.serialSelector</span></code>: Contains:
- <code class="docutils literal notranslate"><span class="pre">selectUsbPort</span></code>: Chooses an available USB port.
- <code class="docutils literal notranslate"><span class="pre">handleUsbDisconnection</span></code>: (commented out) handles disconnection events.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.modbus</span></code>: Provides:
- <code class="docutils literal notranslate"><span class="pre">floatToRegisters</span></code>: Converts float values to 2 x 16-bit Modbus register pairs.
- <code class="docutils literal notranslate"><span class="pre">contextManager</span></code>: Returns a Modbus context for register mapping.
- <code class="docutils literal notranslate"><span class="pre">getIpAddress</span></code>: Determines local IP address for Modbus server binding.</p></li>
</ul>
</li>
</ul>
</section>
<section id="xbee-device-initialization">
<h4>XBee Device Initialization<a class="headerlink" href="#xbee-device-initialization" title="Link to this heading"></a></h4>
</section>
</section>
<section id="xbee-serial-port-selection">
<h3>XBee Serial Port Selection<a class="headerlink" href="#xbee-serial-port-selection" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">serialPort</span> <span class="o">=</span> <span class="n">selectUsbPort</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Attempts to detect which USB port the XBee radio is connected to.</p></li>
<li><p>If successful, the returned serial port is used to instantiate an <cite>XBeeDevice</cite>.</p></li>
</ul>
<section id="creating-the-xbeedevice">
<h4>Creating the XBeeDevice<a class="headerlink" href="#creating-the-xbeedevice" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="o">=</span> <span class="n">XBeeDevice</span><span class="p">(</span><span class="n">serialPort</span><span class="p">,</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeBaudRate</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>A global reference to the <cite>XBeeDevice</cite> is stored in <cite>variables.xbeeInstance</cite>.</p></li>
<li><p>The baud rate is fetched from shared config <cite>variables.xbeeBaudRate</cite>.</p></li>
</ul>
</section>
<section id="fallback-if-device-not-found">
<h4>Fallback if Device Not Found<a class="headerlink" href="#fallback-if-device-not-found" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">serialPort</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gateway radio not connected&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If no serial port is returned (e.g., no USB radio plugged in), the system exits early with an error message.</p></li>
</ul>
</section>
<section id="queue-initialization">
<h4>Queue Initialization<a class="headerlink" href="#queue-initialization" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeQueue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Initializes an asynchronous queue.</p></li>
<li><p>Each entry in the queue is a tuple: <code class="docutils literal notranslate"><span class="pre">(mac_address,</span> <span class="pre">raw_data_bytes)</span></code>.</p></li>
<li><p>This queue decouples the reception of XBee packets from the Modbus writing process.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">xbeeQueue</span></code> is consumed by <cite>modbusPolling()</cite> and populated by <cite>xbeePolling()</cite>.</p>
<p><code class="docutils literal notranslate"><span class="pre">variables.xbeeInstance</span></code> is a global variable, required across the entire script to maintain a reference to the XBee radio device for receiving messages and handling connections.</p>
</section>
<section id="summary">
<h4>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h4>
<p>This initialization block ensures that:</p>
<ul class="simple">
<li><p>All required modules and helpers are available.</p></li>
<li><p>The XBee radio is located and configured for communication.</p></li>
<li><p>A global queue is prepared for non-blocking data processing.</p></li>
<li><p>The application halts gracefully if the XBee device is not connected.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">main</span></code> is not just an entry point — it’s the coordination layer that glues asynchronous XBee communication, database-driven register mapping, and Modbus server exposure into a coherent, reactive gateway service.</p>
</section>
</section>
<section id="xbeepolling">
<h3>xbeePolling<a class="headerlink" href="#xbeepolling" title="Link to this heading"></a></h3>
<p>The <cite>xbeePolling</cite> coroutine handles continuous communication with the connected XBee radio. It listens for incoming RF messages and queues them for further processing by the Modbus layer.</p>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Opens the serial port and establishes a connection with the XBee device.</p></li>
<li><p>Registers a callback to process incoming data asynchronously.</p></li>
<li><p>Extracts metadata like the MAC address, timestamp, and payload.</p></li>
<li><p>Adds any newly discovered MAC addresses to a global known list.</p></li>
<li><p>Pushes each received packet into the global <cite>xbeeQueue</cite>.</p></li>
</ul>
</section>
<section id="implementation">
<h4>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">xbeePolling</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">dataReceiveCallback</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="p">):</span>
            <span class="o">...</span>

        <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">add_data_received_callback</span><span class="p">(</span><span class="n">dataReceiveCallback</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="data-reception-callback">
<h4>Data Reception Callback<a class="headerlink" href="#data-reception-callback" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">dataReceiveCallback</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="p">):</span>
    <span class="n">xbeeMacAddress</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="o">.</span><span class="n">remote_device</span><span class="o">.</span><span class="n">get_64bit_addr</span><span class="p">())</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">xbeeMessage</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">xbeeDataAsByte</span> <span class="o">=</span> <span class="n">xbeeMessage</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<p>This callback extracts:</p>
<ul class="simple">
<li><p><strong>xbeeMacAddress</strong>: The 64-bit MAC address of the sending node.</p></li>
<li><p><strong>timestamp</strong>: Human-readable time of reception.</p></li>
<li><p><strong>xbeeDataAsByte</strong>: Raw binary payload sent by the remote device.</p></li>
</ul>
</section>
<section id="new-address-detection">
<h4>New Address Detection<a class="headerlink" href="#new-address-detection" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">knownXbeeAddress</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">New XBee Address Discovered: </span><span class="si">{</span><span class="n">xbeeMacAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">knownXbeeAddress</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of addresses discovered so far are: </span><span class="si">{</span><span class="n">variables</span><span class="o">.</span><span class="n">knownXbeeAddress</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This section dynamically maintains a list of all MAC addresses seen during runtime. Newly discovered radios are appended to <cite>variables.knownXbeeAddress</cite>.</p>
</section>
<section id="queueing-the-packet">
<h4>Queueing the Packet<a class="headerlink" href="#queueing-the-packet" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeQueue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="n">xbeeMacAddress</span><span class="p">,</span> <span class="n">xbeeDataAsByte</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <cite>(mac, data)</cite> tuple is inserted into the asynchronous <cite>xbeeQueue</cite>.</p></li>
<li><p>This decouples reception from processing, allowing later stages to consume data without blocking.</p></li>
</ul>
</section>
<section id="notes">
<h4>Notes<a class="headerlink" href="#notes" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>The inner <cite>while True</cite> loop is necessary to keep the <cite>xbeePolling</cite> coroutine alive.</p></li>
<li><p><cite>asyncio.sleep(1)</cite> is a lightweight way to yield control while keeping the task running.</p></li>
<li><p>If any exceptions occur, the serial port is closed in the <cite>finally</cite> block to avoid lockups.</p></li>
</ul>
</section>
<section id="commented-out-disconnection-handler">
<h4>Commented-Out Disconnection Handler<a class="headerlink" href="#commented-out-disconnection-handler" title="Link to this heading"></a></h4>
<p>There is a placeholder for future support of USB disconnection events:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># variables.xbeeInstance.add_error_callback(partial(handleUsbDisconnection, xbeeObject=variables.xbeeInstance))</span>
</pre></div>
</div>
<p>This uses a <cite>functools.partial</cite> to prebind the device instance and register a disconnection handler, but it is currently disabled (commented out).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>⚠️ <strong>Note for developers:</strong> The <cite>add_error_callback</cite> method is <strong>not available in the official Digi XBee Python library</strong> (<cite>digi-xbee</cite>). It has been introduced in a <strong>custom fork</strong> of the library:</p>
<p>🔗 <a class="reference external" href="https://github.com/n1lby73/xbee-python">https://github.com/n1lby73/xbee-python</a></p>
<p>A pull request to include this feature in the upstream library has already been submitted:</p>
<p>🔗 <a class="reference external" href="https://github.com/digidotcom/xbee-python/pull/310">https://github.com/digidotcom/xbee-python/pull/310</a></p>
<p>As of now, the pull request has <strong>not yet been merged</strong> by Digi International (the library maintainers). Until then, this functionality will only work if you use the custom fork mentioned above.</p>
</div>
<p>The project now includes support for handling USB disconnection events for the XBee radio.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">add_error_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">handleUsbDisconnection</span><span class="p">,</span> <span class="n">xbeeObject</span><span class="o">=</span><span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="p">))</span>
</pre></div>
</div>
<p>This line registers an error callback that detects when the USB-connected XBee device is unexpectedly removed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While this functionality is now active, the implementation is currently <strong>not cleanly modularized</strong>.
It has been integrated in a somewhat “spaghetti” manner as a temporary solution to maintain stability
and ensure continuous operation.</p>
<p>Future refactoring is planned to improve separation of concerns and robustness in the disconnection handling logic.</p>
</div>
</section>
<section id="id2">
<h4>Summary<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<p>The <cite>xbeePolling</cite> function acts as the real-time listener for incoming XBee packets. It enables:</p>
<ul class="simple">
<li><p>Automatic discovery of new radios.</p></li>
<li><p>Timestamped payload extraction.</p></li>
<li><p>Non-blocking handoff to downstream Modbus and database processes via a shared queue.</p></li>
</ul>
</section>
</section>
<section id="modbuspolling">
<h3>modbusPolling<a class="headerlink" href="#modbuspolling" title="Link to this heading"></a></h3>
<p>The <cite>modbusPolling</cite> coroutine processes packets received from XBee radios and updates the Modbus server with the parsed sensor data.</p>
<section id="id3">
<h4>Overview<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Waits for new entries from the shared <cite>xbeeQueue</cite>.</p></li>
<li><p>Uses the MAC address to query a database and retrieve the Modbus register start address.</p></li>
<li><p>Parses raw binary payloads into floating-point sensor values using the Cayenne LPP format.</p></li>
<li><p>Converts floats into Modbus register values (16-bit integers).</p></li>
<li><p>Writes up to 20 registers to both the Holding (FC3) and Input (FC4) register blocks.</p></li>
</ul>
</section>
<section id="id4">
<h4>Implementation<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">modbusPolling</span><span class="p">(</span><span class="n">contextValue</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">xbeeQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startAddress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">sensorValues</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cayenneParse</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">)</span>
                <span class="n">registerValues</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sensorValues</span><span class="p">:</span>
                    <span class="n">registerValues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">floatToRegisters</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="n">registers</span> <span class="o">=</span> <span class="n">registerValues</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
                <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
                <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Xbee radio with mac address </span><span class="si">{</span><span class="n">mac</span><span class="si">}</span><span class="s2">, has not been configured</span><span class="se">\n</span><span class="s2">Other possible error are </span><span class="si">{</span><span class="n">startAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modbus polling error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">xbeeQueue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="queue-consumption">
<h4>Queue Consumption<a class="headerlink" href="#queue-consumption" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">xbeeQueue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>The coroutine waits (asynchronously) for new packets inserted by <cite>xbeePolling()</cite>. Each packet contains:</p>
<ul class="simple">
<li><p><cite>mac</cite>: 64-bit MAC address as a string.</p></li>
<li><p><cite>raw_data</cite>: binary payload received from the XBee node.</p></li>
</ul>
</section>
<section id="register-lookup">
<h4>Register Lookup<a class="headerlink" href="#register-lookup" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
</pre></div>
</div>
<p>This line queries the local database to determine where in the Modbus address space the data from this MAC should be written. The database should return a valid starting address (e.g., 4020), or an error object if the address is unregistered.</p>
</section>
<section id="payload-parsing">
<h4>Payload Parsing<a class="headerlink" href="#payload-parsing" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sensorValues</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cayenneParse</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">)</span>
</pre></div>
</div>
<p>This function decodes the Cayenne Low Power Payload (LPP) format into a list of float values representing sensor readings. It is assumed to be robust to errors in payload structure.</p>
</section>
<section id="float-to-register-conversion">
<h4>Float to Register Conversion<a class="headerlink" href="#float-to-register-conversion" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">registerValues</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sensorValues</span><span class="p">:</span>
    <span class="n">registerValues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">floatToRegisters</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</pre></div>
</div>
<p>Each float is converted into two 16-bit integers (Modbus registers) using IEEE 754 binary representation. Only the first 10 floats (20 registers) are used to ensure compatibility and prevent overflow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">registers</span> <span class="o">=</span> <span class="n">registerValues</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="writing-to-modbus-context">
<h4>Writing to Modbus Context<a class="headerlink" href="#writing-to-modbus-context" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
<span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
</pre></div>
</div>
<p>This writes the register block to both:</p>
<ul class="simple">
<li><p>Function Code 3 (Holding Registers)</p></li>
<li><p>Function Code 4 (Input Registers)</p></li>
</ul>
<p>Both address spaces mirror the same sensor values, allowing flexibility for downstream SCADA or HMI systems.</p>
</section>
<section id="error-handling">
<h4>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>If the MAC is not found in the database, a message is printed.</p></li>
<li><p>Any exception during parsing or writing is caught and printed.</p></li>
<li><p>After processing (even in error cases), <cite>xbeeQueue.task_done()</cite> is called to mark the queue task as complete.</p></li>
</ul>
</section>
<section id="id5">
<h4>Summary<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<p>The <cite>modbusPolling</cite> function acts as the transformation and mapping layer of the gateway. It:</p>
<ul class="simple">
<li><p>Decouples data reception from register updates.</p></li>
<li><p>Leverages asynchronous concurrency to handle large volumes of packets.</p></li>
<li><p>Ensures safe and consistent updates to the Modbus context.</p></li>
</ul>
</section>
</section>
<section id="modbusserver">
<h3>modbusServer<a class="headerlink" href="#modbusserver" title="Link to this heading"></a></h3>
<p>The <cite>modbusServer</cite> coroutine starts the asynchronous Modbus TCP server that exposes sensor data to external SCADA or HMI systems.</p>
<section id="id6">
<h4>Overview<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Initializes the Modbus device identification parameters.</p></li>
<li><p>Retrieves the local IP address dynamically.</p></li>
<li><p>Launches the <cite>StartAsyncTcpServer()</cite> from <cite>pymodbus</cite> to serve the register context.</p></li>
<li><p>Runs as an asyncio task concurrently with XBee polling and Modbus data processing.</p></li>
</ul>
</section>
<section id="id7">
<h4>Implementation<a class="headerlink" href="#id7" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">modbusServer</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">identity</span> <span class="o">=</span> <span class="n">ModbusDeviceIdentification</span><span class="p">()</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">VendorName</span> <span class="o">=</span> <span class="s1">&#39;Cors System&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">ProductCode</span> <span class="o">=</span> <span class="s1">&#39;CSG&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">VendorUrl</span> <span class="o">=</span> <span class="s1">&#39;https://corssystem.com&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">ProductName</span> <span class="o">=</span> <span class="s1">&#39;Core Terminal Unit Gateway&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">ModelName</span> <span class="o">=</span> <span class="s1">&#39;Genesis&#39;</span>
    <span class="n">identity</span><span class="o">.</span><span class="n">MajorMinorRevision</span> <span class="o">=</span> <span class="s1">&#39;2.0&#39;</span>

    <span class="n">ipAddress</span> <span class="o">=</span> <span class="n">getIpAddress</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Modbus TCP server on port </span><span class="si">{</span><span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">StartAsyncTcpServer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="n">identity</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">,</span> <span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="modbus-identity-configuration">
<h4>Modbus Identity Configuration<a class="headerlink" href="#modbus-identity-configuration" title="Link to this heading"></a></h4>
<p>The identity block provides descriptive information about the gateway device when queried by Modbus clients:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>VendorName           = Cors System
ProductCode          = CSG
ProductName          = Core Terminal Unit Gateway
ModelName            = Genesis
Version              = 2.0
</pre></div>
</div>
<p>These values are helpful for device discovery, diagnostics, or validation in a SCADA environment.</p>
</section>
<section id="dynamic-ip-address-resolution">
<h4>Dynamic IP Address Resolution<a class="headerlink" href="#dynamic-ip-address-resolution" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ipAddress</span> <span class="o">=</span> <span class="n">getIpAddress</span><span class="p">()</span>
</pre></div>
</div>
<p>This utility function fetches the device’s local IP address automatically, ensuring the gateway binds to the correct network interface. This is especially useful on devices like Raspberry Pi that may change IPs between boots.</p>
</section>
<section id="server-startup">
<h4>Server Startup<a class="headerlink" href="#server-startup" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">StartAsyncTcpServer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">identity</span><span class="o">=</span><span class="n">identity</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="n">ipAddress</span><span class="p">,</span> <span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span><span class="p">))</span>
</pre></div>
</div>
<p>This launches the non-blocking Modbus TCP server:</p>
<ul class="simple">
<li><p><cite>context</cite>: the Modbus server context which holds all register values.</p></li>
<li><p><cite>identity</cite>: the device info structure.</p></li>
<li><p><cite>address</cite>: a tuple of <cite>(IP, port)</cite>.</p></li>
</ul>
<p>Once started, the server runs indefinitely within the asyncio event loop, allowing simultaneous handling of:</p>
<ul class="simple">
<li><p>Client read requests (e.g., FC3 and FC4)</p></li>
<li><p>Context updates from <cite>modbusPolling</cite></p></li>
</ul>
</section>
<section id="port-configuration">
<h4>Port Configuration<a class="headerlink" href="#port-configuration" title="Link to this heading"></a></h4>
<p>The port is sourced from the <cite>variables</cite> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="o">.</span><span class="n">modbusPort</span>
</pre></div>
</div>
<p>Ensure this value matches the port expected by your SCADA or Modbus master systems. Typical ports include <cite>502</cite> (default Modbus TCP) or a custom value like <cite>5020</cite>.</p>
</section>
<section id="id8">
<h4>Summary<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p>The <cite>modbusServer</cite> coroutine is the final output layer of the XBee gateway:</p>
<ul class="simple">
<li><p>It makes the internal data accessible to the outside world.</p></li>
<li><p>Leverages asynchronous IO for non-blocking performance.</p></li>
<li><p>Integrates seamlessly with the shared Modbus context used by other tasks.</p></li>
</ul>
</section>
</section>
<section id="startprocess">
<h3>startProcess<a class="headerlink" href="#startprocess" title="Link to this heading"></a></h3>
<p>The <cite>startProcess</cite> coroutine serves as the centralized task coordinator for the XBee Gateway application.</p>
<section id="id9">
<h4>Overview<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<p>This function:</p>
<ul class="simple">
<li><p>Initializes the Modbus register context using <cite>contextManager</cite> from the <cite>modbus</cite> module.</p></li>
<li><p>Creates the background polling task for XBee data.</p></li>
<li><p>Starts the main event loop that concurrently runs:</p>
<ul>
<li><p>XBee serial data polling</p></li>
<li><p>Modbus context updates</p></li>
<li><p>Modbus TCP server</p></li>
</ul>
</li>
</ul>
<p>It is the main orchestrator that wires together the entire gateway workflow using <cite>asyncio.gather</cite>.</p>
</section>
<section id="id10">
<h4>Implementation<a class="headerlink" href="#id10" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startProcess</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">contextManager</span><span class="p">()</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">xbeePolling</span><span class="p">())</span>

    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span><span class="p">,</span>
        <span class="n">modbusPolling</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
        <span class="n">modbusServer</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="steps-breakdown">
<h4>Steps Breakdown<a class="headerlink" href="#steps-breakdown" title="Link to this heading"></a></h4>
<p><strong>1. Context Initialization</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">contextManager</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><cite>contextManager()</cite> is a helper function defined in the <cite>modules.modbus</cite> module.</p>
</div>
<p>It returns a <cite>ModbusServerContext</cite> object that holds all register blocks used in the server, including:</p>
<ul class="simple">
<li><p>Discrete Inputs (DI)</p></li>
<li><p>Coils (CO)</p></li>
<li><p>Holding Registers (HR)</p></li>
<li><p>Input Registers (IR)</p></li>
</ul>
<p>This centralized context is passed to both the <cite>modbusPolling</cite> task and the <cite>modbusServer</cite>, ensuring they operate on the same memory structure.</p>
<p><strong>2. Background Task Creation</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">xbeePolling</span><span class="p">())</span>
</pre></div>
</div>
<p>This launches the XBee radio polling loop in the background. The returned task object is stored in <cite>variables</cite> to allow external cancellation or monitoring.</p>
<p><strong>3. Launch Concurrent Tasks</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">xbeePollingTask</span><span class="p">,</span>
    <span class="n">modbusPolling</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
    <span class="n">modbusServer</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This schedules and runs all gateway components concurrently:</p>
<ul class="simple">
<li><p><cite>xbeePolling</cite> collects packets into a shared queue.</p></li>
<li><p><cite>modbusPolling</cite> consumes packets and updates Modbus registers.</p></li>
<li><p><cite>modbusServer</cite> exposes those registers over TCP.</p></li>
</ul>
<p>By leveraging <cite>asyncio.gather</cite>, all three coroutines operate within the same event loop, eliminating the need for threading.</p>
</section>
<section id="concurrency-considerations">
<h4>Concurrency Considerations<a class="headerlink" href="#concurrency-considerations" title="Link to this heading"></a></h4>
<p>Because all tasks share data structures like <cite>xbeeQueue</cite> and <cite>context</cite>, care is taken to:</p>
<ul class="simple">
<li><p>Use non-blocking I/O</p></li>
<li><p>Avoid race conditions via <cite>await</cite></p></li>
<li><p>Share state predictably using asyncio primitives</p></li>
</ul>
</section>
<section id="id11">
<h4>Summary<a class="headerlink" href="#id11" title="Link to this heading"></a></h4>
<p>The <cite>startProcess()</cite> function glues the system together, ensuring the XBee Gateway:</p>
<ul class="simple">
<li><p>Initializes correctly</p></li>
<li><p>Runs all components in harmony</p></li>
<li><p>Operates in a responsive, non-blocking manner</p></li>
</ul>
<p>It is invoked by the <cite>__main__</cite> block when the program starts.</p>
</section>
</section>
<section id="id12">
<h3>__main__<a class="headerlink" href="#id12" title="Link to this heading"></a></h3>
<p>The <cite>__main__</cite> block is the program’s entry point when the script is executed directly. It sets up the event loop, runs the gateway, and handles graceful shutdown on termination or error.</p>
<section id="id13">
<h4>Overview<a class="headerlink" href="#id13" title="Link to this heading"></a></h4>
<p>This block ensures that:</p>
<ul class="simple">
<li><p>The gateway is only executed when the file is not imported as a module.</p></li>
<li><p>The <cite>startProcess()</cite> coroutine is run using <cite>asyncio.run</cite>.</p></li>
<li><p>Any runtime errors are logged to the console.</p></li>
<li><p>The XBee serial port is closed safely upon exit, preventing resource leaks.</p></li>
</ul>
</section>
<section id="id14">
<h4>Implementation<a class="headerlink" href="#id14" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">startProcess</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">User cancelled operation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown error with info as: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="explanation">
<h4>Explanation<a class="headerlink" href="#explanation" title="Link to this heading"></a></h4>
<p><strong>1. Main Execution Guard</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</pre></div>
</div>
<p>Ensures this code block only runs when the script is executed directly (e.g., <cite>python main.py</cite>). Prevents unintended execution if imported as a library or module.</p>
<p><strong>2. Async Runtime Launcher</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">startProcess</span><span class="p">())</span>
</pre></div>
</div>
<p>Starts the asyncio event loop and calls <cite>startProcess()</cite> to initialize and run all gateway tasks. This is the official way to start asynchronous programs in modern Python (<cite>&gt;=3.7</cite>).</p>
<p><strong>3. Graceful Shutdown</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">User cancelled operation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Handles user interruption (Ctrl+C) gracefully by printing a friendly message instead of a traceback.</p>
<p><strong>4. Catch-All Error Logging</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown error with info as: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Any unexpected errors during startup or runtime are caught and logged. This helps in debugging deployment or field issues.</p>
<p><strong>5. Resource Cleanup</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">finally</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">is_open</span><span class="p">():</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">xbeeInstance</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>This block ensures that the XBee serial port is closed if it was previously opened. Prevents port locking and ensures the device can reconnect cleanly next time.</p>
</section>
<section id="id15">
<h4>Summary<a class="headerlink" href="#id15" title="Link to this heading"></a></h4>
<p>The <cite>__main__</cite> block is crucial for managing the lifecycle of the gateway. It:</p>
<ul class="simple">
<li><p>Starts the asyncio-based workflow</p></li>
<li><p>Handles interruptions and crashes</p></li>
<li><p>Ensures hardware resources (like serial ports) are released properly</p></li>
</ul>
<p>Together with <cite>startProcess</cite>, it ensures a robust, fault-tolerant startup and shutdown process.</p>
</section>
</section>
</section>
<section id="configgui">
<span id="id16"></span><h2>configGui<a class="headerlink" href="#configgui" title="Link to this heading"></a></h2>
<p>This Tkinter-based GUI allows users to configure the XBee network and Modbus communication settings for the gateway.</p>
<section id="gui-components">
<h3>GUI Components<a class="headerlink" href="#gui-components" title="Link to this heading"></a></h3>
<p>The interface consists of several main sections:</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt><strong>Header Section</strong></dt><dd><ul class="simple">
<li><p>Displays the application title</p></li>
<li><p>Shows the Modbus server IP address</p></li>
<li><p>Contains the “Configure Serial Number” button</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Add New Entry Section</strong></dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Input fields for:</dt><dd><ul>
<li><p>Node Identifier</p></li>
<li><p>Radio MAC Address</p></li>
<li><p>Modbus Start Address</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>“Available Addresses” button</p></li>
<li><p>“Add to Database” button</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Configured XBee Radios Section</strong></dt><dd><ul class="simple">
<li><p>Search bar with placeholder text</p></li>
<li><p>Refresh button</p></li>
<li><p>Sorting dropdown (First/Last Modified, Ascending/Descending Modbus Address)</p></li>
<li><dl class="simple">
<dt>Treeview table displaying configured radios with columns for:</dt><dd><ul>
<li><p>S/N (Serial Number)</p></li>
<li><p>Node Identifier</p></li>
<li><p>Radio MAC Address</p></li>
<li><p>Modbus Start Address</p></li>
<li><p>Modbus End Address</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>“Delete Selected” and “Update Selected” buttons</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Modal Windows</strong></dt><dd><ul class="simple">
<li><p>Available Addresses window</p></li>
<li><p>Update Entry window</p></li>
<li><p>Configuration window</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
</section>
<section id="dependencies">
<h3>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tkinter</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PIL.Image</span></code>, <code class="docutils literal notranslate"><span class="pre">PIL.ImageTk</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.modbus.getIpAddress</span></code></p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">.dbIntegration</span></code> module functions:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">configureXbeeRadio</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">retrieveAllConfiguredRadio</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deleteXbeeDetails</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">updateXbeeDetails</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">updateReusableAddress</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">updateAllEndAddress</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="functions">
<h3>Functions:<a class="headerlink" href="#functions" title="Link to this heading"></a></h3>
<dl class="py function">
<dt class="sig sig-object py" id="get_database">
<span class="sig-name descname"><span class="pre">get_database</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#get_database" title="Link to this definition"></a></dt>
<dd><p>Retrieves all configured radio entries from the database and inserts them into the GUI tree view.
If an error occurs during retrieval, an error message is shown to the user.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Calls the <cite>retrieveAllConfiguredRadio()</cite> function to fetch all radio configurations.</p></li>
<li><p>Iterates through the fetched data, inserting each entry into the GUI tree view with details such as index, item[0], item[1], item[2], and item[3].</p></li>
<li><p>If the result is a dictionary and contains an “error” key, an error message is displayed using a messagebox.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method. (Implicit)</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This function does not return any value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p><strong>Error Handling:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>If the function retrieves an error message (when the result is a dictionary and contains the “error” key), the function will show an error dialog using <cite>messagebox.showerror</cite> with the message provided in the error field.</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Notes:</strong></dt><dd><ul class="simple">
<li><p>The <cite>retrieveAllConfiguredRadio()</cite> function should return a list or iterable with radio configurations, where each item is a tuple containing at least four elements. If the result is a dictionary with an “error” key, the function displays an error.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="add_database">
<span class="sig-name descname"><span class="pre">add_database</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#add_database" title="Link to this definition"></a></dt>
<dd><p>Adds a new radio entry to the database by configuring an XBee radio with a specified radio address, Modbus address, and node identifier.
If successful, the tree view is updated and the input fields are cleared. If an error occurs, an error message is shown to the user.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Retrieves the radio address, Modbus address, and node identifier from the corresponding input fields.</p></li>
<li><p>Attempts to configure the XBee radio using the <cite>configureXbeeRadio()</cite> function with the provided details.</p></li>
<li><p>If the configuration is successful, clears the input fields, shows a success message, and updates the tree view by calling <cite>get_database()</cite> to repopulate it.</p></li>
<li><p>If there is an error during the configuration, an error message is displayed.</p></li>
<li><p>If a <cite>ValueError</cite> is raised due to invalid input (e.g., non-integer Modbus address), an error message is displayed.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<p>If this function is part of a class, the method can be invoked as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_database</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method. (Implicit)</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This function does not return any value.</p>
</dd>
</dl>
</li>
</ul>
<p><strong>Error Handling:</strong></p>
<dl class="simple">
<dt>The function handles errors in the following ways:</dt><dd><ul class="simple">
<li><p><strong>XBee Configuration Error</strong>: If the <cite>configureXbeeRadio()</cite> function returns an error message, an error dialog is shown using <cite>messagebox.showerror</cite>.</p></li>
<li><p><strong>Invalid Modbus Address</strong>: If a <cite>ValueError</cite> occurs due to an invalid Modbus address (non-integer value), an error dialog is shown with a specific message.</p></li>
</ul>
</dd>
<dt><strong>Notes:</strong></dt><dd><ul class="simple">
<li><p>The function expects the Modbus address input to be a valid integer. If the input is not a valid integer, the function raises a <cite>ValueError</cite> and prompts the user to enter a valid value.</p></li>
<li><p>The <cite>configureXbeeRadio()</cite> function must return a dictionary, where the absence of an “error” key indicates a successful configuration, and the presence of an “error” key indicates failure.</p></li>
<li><p>After a successful entry, the tree view is cleared and repopulated using the <cite>get_database()</cite> function.</p></li>
<li><p>This function does not return any value.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="refresh">
<span class="sig-name descname"><span class="pre">refresh</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#refresh" title="Link to this definition"></a></dt>
<dd><p>Refreshes the GUI by clearing and repopulating the radio configuration table and updating the displayed IP address of the Modbus server.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Clears all existing entries from the tree view widget.</p></li>
<li><p>Calls <cite>get_database()</cite> to reload and display the latest radio configuration data.</p></li>
<li><p>Retrieves the current IP address of the Modbus server using <cite>getIpAddress()</cite>.</p></li>
<li><p>Updates the <cite>ip_address_label</cite> widget to display the retrieved IP address.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method. (Implicit)</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This function does not return any value.</p>
</dd>
</dl>
</li>
</ul>
<dl class="simple">
<dt><strong>Important Notes:</strong></dt><dd><ul class="simple">
<li><p>Assumes that <cite>get_database()</cite> repopulates the tree view with current configuration data.</p></li>
<li><p>Assumes <cite>getIpAddress()</cite> returns a string representing the Modbus server’s current IP address.</p></li>
<li><p>The <cite>ip_address_label</cite> widget must already be defined and configured in the GUI for the IP update to display correctly.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="live_search">
<span class="sig-name descname"><span class="pre">live_search</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#live_search" title="Link to this definition"></a></dt>
<dd><p>Filters and displays tree view rows based on a live search query entered by the user in the search bar. If no matches are found, an informational dialog is shown.</p>
<dl class="simple">
<dt>This function performs the following steps:</dt><dd><ul class="simple">
<li><p>Retrieves the user’s input from the search bar and converts it to lowercase.</p></li>
<li><p>Temporarily detaches all items from the tree view to prepare for filtering.</p></li>
<li><p>Iterates through stored data (<cite>self.data</cite>) and reattaches only the items that match the search query.</p></li>
<li><p>If no matches are found, displays a message box notifying the user.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;KeyRelease&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_search</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">param event<span class="colon">:</span></dt>
<dd class="field-odd"><p>Automatically passed by event bindings (optional).</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Data Requirements:</strong></dt><dd><ul class="simple">
<li><dl class="simple">
<dt><cite>self.data</cite> should be a list of tuples in the form <cite>(values, iid)</cite>, where:</dt><dd><ul>
<li><p><cite>values</cite> is an iterable of displayed column values,</p></li>
<li><p><cite>iid</cite> is the item identifier in the tree view.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p><cite>self.search_bar</cite> should be an input widget (e.g., <cite>Entry</cite>) containing the search query.</p></li>
<li><p><cite>self.tree</cite> should be a <cite>ttk.Treeview</cite> widget.</p></li>
</ul>
</dd>
<dt><strong>Behavior:</strong></dt><dd><ul class="simple">
<li><p>The search is case-insensitive and matches substrings within any of the row values.</p></li>
<li><p>Matching rows are reattached to the tree; all others remain detached.</p></li>
<li><p>If no matches are found, a message box is shown with a “No match found” message.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="sort_table">
<span class="sig-name descname"><span class="pre">sort_table</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#sort_table" title="Link to this definition"></a></dt>
<dd><p>Sorts the entries in the tree view based on the selected criterion from a dropdown menu. Sorting options include modification order and Modbus address values.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Retrieves the current sorting option from a dropdown selection.</p></li>
<li><p>Collects all tree view items and their associated data.</p></li>
<li><dl class="simple">
<dt>Sorts the data based on the selected criterion:</dt><dd><ul>
<li><p><strong>First Modified</strong>: Sorts by original order (ascending by <cite>text</cite> field(an invisible column which carries values similar to an identification number)).</p></li>
<li><p><strong>Last Modified</strong>: Sorts by reverse order (descending by <cite>text</cite> field).</p></li>
<li><p><strong>Ascending Modbus Address</strong>: Sorts entries by the Modbus address in ascending order.</p></li>
<li><p><strong>Descending Modbus Address</strong>: Sorts entries by the Modbus address in descending order.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Reassigns serial numbers to each item based on the new order.</p></li>
<li><p>Moves each item in the tree view to reflect the sorted arrangement.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">dropdown</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;ComboboxSelected&gt;&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_table</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">param event<span class="colon">:</span></dt>
<dd class="field-odd"><p>Optional event object from GUI interactions.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Dependencies and Assumptions:</strong></dt><dd><ul class="simple">
<li><p><cite>self.dropdown</cite>: A dropdown widget (<cite>ttk.Combobox</cite>) used to select the sorting criterion.</p></li>
<li><p><cite>self.tree</cite>: A <cite>ttk.Treeview</cite> widget that displays rows of data.</p></li>
<li><p>The <cite>values</cite> for each tree item must be a list where the 4th value (<cite>values[3]</cite>) represents the Modbus address.</p></li>
<li><p>The <cite>text</cite> field of each item is used as a sortable ID (typically representing insertion order).</p></li>
</ul>
</dd>
<dt><strong>Sorting Behavior:</strong></dt><dd><ul class="simple">
<li><p>Each tree item’s serial number (first column value) is updated to reflect its position after sorting.</p></li>
<li><p>Items are visually reordered in the GUI using <cite>tree.move()</cite>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="get_available_address">
<span class="sig-name descname"><span class="pre">get_available_address</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#get_available_address" title="Link to this definition"></a></dt>
<dd><p>Opens a new window displaying a list of available Modbus address ranges retrieved from the backend. The data is shown in a scrollable table with columns for serial number, address range, range size, and usability.</p>
<dl class="simple">
<dt>This function performs the following tasks:</dt><dd><ul class="simple">
<li><p>Creates a new <cite>Toplevel</cite> window titled “Available Addresses”.</p></li>
<li><p>Retrieves available address data using the <cite>updateReusableAddress(“test”)</cite> function.</p></li>
<li><p>Constructs a scrollable <cite>ttk.Treeview</cite> table to present the address range data.</p></li>
<li><p>Populates the table with the retrieved data.</p></li>
<li><p>If an error occurs during address retrieval, displays an error dialog using <cite>messagebox.showerror</cite>.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">get_available_address</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>UI Elements Created:</strong></dt><dd><ul class="simple">
<li><p>A new <cite>Toplevel</cite> window (<cite>self.available_address_window</cite>) sized 800x300.</p></li>
<li><dl class="simple">
<dt>A scrollable <cite>ttk.Treeview</cite> (<cite>self.tree_available</cite>) with the following columns:</dt><dd><ul>
<li><p><strong>S/N</strong>: Serial number (auto-incremented).</p></li>
<li><p><strong>Available Range</strong>: The Modbus address range available.</p></li>
<li><p><strong>Range Size</strong>: Size of the address range.</p></li>
<li><p><strong>Usability</strong>: Whether the range is consumable or not.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt><strong>Data Source:</strong></dt><dd><ul class="simple">
<li><p>Uses <cite>updateReusableAddress(“test”)</cite> to fetch available address ranges.</p></li>
<li><dl class="simple">
<dt>Expects a list of dictionaries, each containing:</dt><dd><ul>
<li><p><cite>“modbusAddressRange”</cite> (str),</p></li>
<li><p><cite>“size”</cite> (int),</p></li>
<li><p><cite>“consumable”</cite> (bool or str indicating usability).</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt><strong>Error Handling:</strong></dt><dd><ul class="simple">
<li><p>If the response is a dictionary with an <cite>“error”</cite> key, an error message box is shown.</p></li>
</ul>
</dd>
<dt><strong>Notes:</strong></dt><dd><ul class="simple">
<li><p>The function assumes that all UI elements (e.g., <cite>tk</cite>, <cite>ttk</cite>, and <cite>messagebox</cite>) are properly imported and available.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="delete_selected">
<span class="sig-name descname"><span class="pre">delete_selected</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#delete_selected" title="Link to this definition"></a></dt>
<dd><p>Deletes one or more selected entries from the tree view and the backend database after user confirmation. If deletion is successful, the view is refreshed and a success message is shown.</p>
<dl class="simple">
<dt>This function performs the following steps:</dt><dd><ul class="simple">
<li><p>Retrieves selected items from the tree view.</p></li>
<li><p>If no item is selected, displays an error dialog prompting the user to select one.</p></li>
<li><p>Prompts the user with a confirmation dialog before deletion.</p></li>
<li><dl class="simple">
<dt>For each selected item:</dt><dd><ul>
<li><p>Extracts the radio MAC address from the item’s values.</p></li>
<li><p>Calls <cite>deleteXbeeDetails()</cite> to remove the corresponding entry from the backend.</p></li>
<li><p>If successful, deletes the item from the tree view.</p></li>
<li><p>If an error occurs during deletion, displays an error message.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Refreshes the UI by calling <cite>self.refresh()</cite> and shows a success message if deletions completed.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">delete_selected</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>User Prompts:</strong></dt><dd><ul class="simple">
<li><p>If nothing is selected: shows <cite>“Please select an item to delete.”</cite></p></li>
<li><p>Before deletion: asks for confirmation via <cite>“Are you sure you want to proceed?”</cite></p></li>
<li><p>After success: shows <cite>“Entry deleted successfully.”</cite></p></li>
</ul>
</dd>
<dt><strong>Assumptions:</strong></dt><dd><ul class="simple">
<li><p>The third value (<cite>values[2]</cite>) of each tree item contains the radio MAC address.</p></li>
<li><p><cite>deleteXbeeDetails(mac_address)</cite> returns a dictionary and uses an <cite>“error”</cite> key to indicate failure.</p></li>
<li><p><cite>self.refresh()</cite> updates the view after deletion.</p></li>
</ul>
</dd>
<dt><strong>Error Handling:</strong></dt><dd><ul class="simple">
<li><p>No selection: shows an error dialog.</p></li>
<li><p>Backend error during deletion: shows the error message in a dialog.</p></li>
</ul>
</dd>
<dt><strong>Notes:</strong></dt><dd><ul class="simple">
<li><p>The tree view must use the <cite>ttk.Treeview</cite> widget.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="update_selected">
<span class="sig-name descname"><span class="pre">update_selected</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#update_selected" title="Link to this definition"></a></dt>
<dd><p>Opens a form to update the selected entry in the tree view. Pre-fills the form with existing data, and waits for user input to complete the update.</p>
<dl class="simple">
<dt>This function performs the following steps:</dt><dd><ul class="simple">
<li><p>Checks whether a tree item is selected. If not, displays an error message.</p></li>
<li><p>Disables the update button to prevent multiple update windows.</p></li>
<li><p>Opens a new <cite>Toplevel</cite> window titled “Update Entry”.</p></li>
<li><dl class="simple">
<dt>Builds an entry form with fields for:</dt><dd><ul>
<li><p>Node Identifier</p></li>
<li><p>Radio MAC Address</p></li>
<li><p>Modbus Start Address</p></li>
<li><p>Modbus End Address</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Pre-fills these input fields with the current values from the selected item.</p></li>
<li><p>Binds the window close protocol to <cite>self.close_window</cite> and waits until the window is closed before re-enabling the update button.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">update_button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_selected</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>UI Elements Created:</strong></dt><dd><ul class="simple">
<li><p>A modal <cite>Toplevel</cite> window named <cite>self.update_window</cite>.</p></li>
<li><p>Four labeled input fields for updating node, MAC address, and Modbus addresses.</p></li>
<li><p>A button labeled “Update Entry” that calls <cite>self.click_update</cite>.</p></li>
</ul>
</dd>
<dt><strong>Data Handling:</strong></dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Uses <cite>self.tree.item(self.selected_item)[“values”]</cite> to extract:</dt><dd><ul>
<li><p><cite>values[1]</cite>: Node Identifier</p></li>
<li><p><cite>values[2]</cite>: Radio MAC Address</p></li>
<li><p><cite>values[3]</cite>: Modbus Start Address</p></li>
<li><p><cite>values[4]</cite>: Modbus End Address</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>These values are inserted into their corresponding entry fields for user editing.</p></li>
</ul>
</dd>
<dt><strong>Window Behavior:</strong></dt><dd><ul class="simple">
<li><p>The main window waits for the update window to close before continuing.</p></li>
<li><p>Update button (<cite>self.update_button</cite>) is disabled while the update window is open and re-enabled afterward.</p></li>
<li><p>The close action is bound to a custom cleanup method (<cite>self.close_window</cite>).</p></li>
</ul>
</dd>
<dt><strong>Error Handling:</strong></dt><dd><ul class="simple">
<li><p>If no item is selected in the tree, an error message is shown: “Please select an item to update.”</p></li>
</ul>
</dd>
<dt><strong>Assumptions:</strong></dt><dd><ul class="simple">
<li><p><cite>self.tree</cite> is a <cite>ttk.Treeview</cite> with at least 5 columns in each row.</p></li>
<li><p><cite>self.click_update()</cite> and <cite>self.close_window()</cite> are defined elsewhere in the class.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="click_update">
<span class="sig-name descname"><span class="pre">click_update</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#click_update" title="Link to this definition"></a></dt>
<dd><p>Applies the updates specified in the update entry form and updates the backend database accordingly.</p>
<dl class="simple">
<dt>This function performs the following actions:</dt><dd><ul class="simple">
<li><p>Retrieves new values entered by the user in the update form.</p></li>
<li><p>Compares the new values to the previously stored values.</p></li>
<li><p>Builds a dictionary (<cite>self.json_data</cite>) with only the fields that have changed.</p></li>
<li><dl class="simple">
<dt>If changes are detected:</dt><dd><ul>
<li><p>Prompts the user for confirmation showing a summary of the updates.</p></li>
<li><p>Sends the update data to the backend using <cite>updateXbeeDetails</cite>.</p></li>
<li><p>If successful, refreshes the main table view, displays a success message, and closes the update window.</p></li>
<li><p>If an error occurs, displays the error message.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>If no changes are detected, shows an error and closes the update window.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">click_update</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Details:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">param self<span class="colon">:</span></dt>
<dd class="field-odd"><p>The instance of the class calling the method.</p>
</dd>
</dl>
</li>
<li><dl class="field-list simple">
<dt class="field-odd">return<span class="colon">:</span></dt>
<dd class="field-odd"><p>This method does not return a value.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Key Variables:</strong></dt><dd><ul class="simple">
<li><p><cite>self.json_data</cite>: A dictionary containing only updated fields.</p></li>
<li><p><cite>self.result</cite>: A list of human-readable change summaries.</p></li>
</ul>
</dd>
<dt><strong>Update Workflow:</strong></dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Compares new inputs against old values:</dt><dd><ul>
<li><p><cite>xbeeNodeIdentifier</cite></p></li>
<li><p><cite>xbeeMac</cite></p></li>
<li><p><cite>modbusStartAddress</cite></p></li>
<li><p><cite>modbusEndAddress</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Only modified fields are sent in the update request.</p></li>
<li><p>A confirmation dialog shows the user what will change before proceeding.</p></li>
</ul>
</dd>
<dt><strong>Backend Interaction:</strong></dt><dd><ul class="simple">
<li><p>Uses <cite>updateXbeeDetails(mac_address, json_data)</cite> to update the device configuration.</p></li>
<li><p>A successful response is expected to have no <cite>“error”</cite> key.</p></li>
</ul>
</dd>
<dt><strong>User Prompts:</strong></dt><dd><ul class="simple">
<li><p>If updates are found: prompts with “Are you fine with this update?” and shows details.</p></li>
<li><p>If no changes are found: shows “No new update detected.”</p></li>
<li><p>On success: shows “Entry updated successfully.”</p></li>
<li><p>On error: shows the error message from the backend.</p></li>
</ul>
</dd>
<dt><strong>Assumptions:</strong></dt><dd><ul class="simple">
<li><p>All entry widgets (<cite>self.node_input</cite>, etc.) are valid and exist.</p></li>
<li><p><cite>self.old_*</cite> attributes are set beforehand (typically from <cite>update_selected()</cite>).</p></li>
<li><p><cite>self.refresh()</cite> refreshes the tree view, and <cite>self.close_window()</cite> cleans up the modal.</p></li>
</ul>
</dd>
<dt><strong>Error Handling:</strong></dt><dd><ul class="simple">
<li><p>Backend errors are shown via <cite>messagebox.showerror</cite>.</p></li>
<li><p>If no changes are detected, user is informed and the update window is closed.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="configure_button">
<span class="sig-name descname"><span class="pre">configure_button</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#configure_button" title="Link to this definition"></a></dt>
<dd><p>Opens the configuration window and preloads settings from a local Python module file called <cite>variables.py</cite>.</p>
<dl class="simple">
<dt>This function performs the following actions:</dt><dd><ul class="simple">
<li><p>Opens and reads the contents of <cite>modules/variables.py</cite>.</p></li>
<li><dl class="simple">
<dt>Extracts values for:</dt><dd><ul>
<li><p><cite>prefferedRadioSerialNumber</cite></p></li>
<li><p><cite>modbusPort</cite></p></li>
<li><p><cite>incrementalModbusAddress</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Displays a new configuration window with input fields for these values.</p></li>
<li><p>Pre-fills the fields with the values read from the file.</p></li>
<li><p>Adds a <strong>Save</strong> button that triggers <cite>self.read_serial_and_modbusport</cite> when clicked.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">configure_button</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Function Workflow:</strong></p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>Opens the <cite>modules/variables.py</cite> file and searches for:</dt><dd><ul>
<li><p><cite>prefferedRadioSerialNumber</cite></p></li>
<li><p><cite>modbusPort</cite></p></li>
<li><p><cite>incrementalModbusAddress</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Extracts the values, strips quotation marks and whitespace as needed.</p></li>
<li><p>Creates a <cite>tk.Toplevel</cite> window titled <em>Configuration Window</em>.</p></li>
<li><p>Adds <cite>tk.Entry</cite> widgets for each extracted setting, pre-filled with current values.</p></li>
<li><p>Places a <strong>Save</strong> button that calls <cite>read_serial_and_modbusport</cite>.</p></li>
</ul>
</div></blockquote>
<p><strong>Dependencies:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Assumes the file <cite>modules/variables.py</cite> exists and contains the target variables.</p></li>
<li><p>Relies on the method <cite>read_serial_and_modbusport</cite> to handle saving updated settings.</p></li>
</ul>
<p><strong>Potential Exceptions:</strong></p>
<ul class="simple">
<li><p>If the <cite>modules/variables.py</cite> file is missing or unreadable, a <cite>FileNotFoundError</cite> or <cite>IOError</cite> may be raised.</p></li>
<li><p>If any of the expected variables are missing from the file, corresponding inputs will be empty.</p></li>
</ul>
</div></blockquote>
<p><strong>Notes:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>This function does <strong>not</strong> save changes itself—it only reads and displays current settings.</p></li>
<li><p>The actual save logic is delegated to <cite>read_serial_and_modbusport</cite>.</p></li>
</ul>
</div></blockquote>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="read_serial_and_modbusport">
<span class="sig-name descname"><span class="pre">read_serial_and_modbusport</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#read_serial_and_modbusport" title="Link to this definition"></a></dt>
<dd><p>Updates configuration variables in the <cite>modules/variables.py</cite> file based on user input from the configuration GUI.</p>
<dl class="simple">
<dt>This method performs the following tasks:</dt><dd><ul class="simple">
<li><p>Reads current values from <cite>modules/variables.py</cite>.</p></li>
<li><p>Compares them to user-provided inputs in the GUI.</p></li>
<li><dl class="simple">
<dt>If any changes are detected:</dt><dd><ul>
<li><p>Updates the file with new values.</p></li>
<li><p>Optionally updates all Modbus end addresses if the incremental value changed.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Displays appropriate message dialogs to confirm and report results.</p></li>
</ul>
</dd>
</dl>
<p><strong>Example Usage:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">read_serial_and_modbusport</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Process Overview:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Reads the file <cite>modules/variables.py</cite> line-by-line.</p></li>
<li><dl class="simple">
<dt>Compares the following variables:</dt><dd><ul>
<li><p><cite>prefferedRadioSerialNumber</cite></p></li>
<li><p><cite>modbusPort</cite></p></li>
<li><p><cite>incrementalModbusAddress</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>For each variable that differs from the old value:</dt><dd><ul>
<li><p>Constructs a new line.</p></li>
<li><p>Updates the corresponding line in memory.</p></li>
<li><p>Appends the change to a result list for display.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>If <cite>incrementalModbusAddress</cite> changed, prompts the user to update all Modbus end addresses via <cite>updateAllEndAddress()</cite>.</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>GUI Interaction:</strong></dt><dd><ul class="simple">
<li><p>Prompts user to confirm changes via <cite>messagebox.askyesno</cite>.</p></li>
<li><p>On update success, shows <cite>messagebox.showinfo</cite>.</p></li>
<li><p>If no change detected, shows <cite>messagebox.showerror</cite>.</p></li>
</ul>
</dd>
<dt><strong>Dependencies:</strong></dt><dd><ul class="simple">
<li><p>Requires file <cite>modules/variables.py</cite> to exist and be writable.</p></li>
<li><p>Calls external method <cite>updateAllEndAddress(new_incremental_address)</cite> if <cite>incrementalModbusAddress</cite> is updated.</p></li>
<li><p>Calls <cite>self.refresh()</cite> after a successful update and optional end address update.</p></li>
</ul>
</dd>
<dt><strong>Raises:</strong></dt><dd><ul class="simple">
<li><p><cite>ValueError</cite> if GUI input cannot be cast to integers.</p></li>
<li><p><cite>FileNotFoundError</cite> or <cite>IOError</cite> if file access fails.</p></li>
</ul>
</dd>
<dt><strong>Notes:</strong></dt><dd><ul class="simple">
<li><p>Closes the configuration window (<cite>self.configure_window</cite>) after execution.</p></li>
<li><p>Does not rollback changes if an error occurs after writing the file.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="clear_placeholder">
<span class="sig-name descname"><span class="pre">clear_placeholder</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#clear_placeholder" title="Link to this definition"></a></dt>
<dd><p>Clears the placeholder text from the search bar input field when it gains focus.</p>
<p>This method is typically bound to the <cite>&lt;FocusIn&gt;</cite> event of the search bar widget. When the field is focused and the default placeholder text (“Search here”) is present, it removes the placeholder and sets the text color to black.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">param event<span class="colon">:</span></dt>
<dd class="field-odd"><p>The event object triggered by the GUI (usually <cite>&lt;FocusIn&gt;</cite>).</p>
</dd>
<dt class="field-even">type event<span class="colon">:</span></dt>
<dd class="field-even"><p>tkinter.Event</p>
</dd>
</dl>
</div></blockquote>
<p><strong>Example Binding:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;FocusIn&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_placeholder</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Behavior:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Checks if the current text in the <cite>search_bar</cite> is <cite>“Search here”</cite>.</p></li>
<li><dl class="simple">
<dt>If so:</dt><dd><ul>
<li><p>Clears the input field.</p></li>
<li><p>Changes the text color to black (default typing color).</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Used For:</strong></dt><dd><ul class="simple">
<li><p>Enhancing user experience by managing placeholder behavior in entry fields.</p></li>
</ul>
</dd>
<dt><strong>Dependencies:</strong></dt><dd><ul class="simple">
<li><p>Assumes <cite>self.search_bar</cite> is a <cite>tk.Entry</cite> widget.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="add_placeholder">
<span class="sig-name descname"><span class="pre">add_placeholder</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#add_placeholder" title="Link to this definition"></a></dt>
<dd><p>Adds a placeholder text to the search bar if the field is empty.</p>
<p>This method is usually bound to the <cite>&lt;FocusOut&gt;</cite> event of the search bar widget. When the entry field loses focus and is empty, it inserts a default placeholder text (“Search here”) and changes the text color to grey to indicate it’s a placeholder.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">param event<span class="colon">:</span></dt>
<dd class="field-odd"><p>The event object triggered by the GUI (usually <cite>&lt;FocusOut&gt;</cite>).</p>
</dd>
<dt class="field-even">type event<span class="colon">:</span></dt>
<dd class="field-even"><p>tkinter.Event</p>
</dd>
</dl>
</div></blockquote>
<p><strong>Example Binding:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">search_bar</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;FocusOut&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_placeholder</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Behavior:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>Checks if the <cite>search_bar</cite> field is currently empty.</p></li>
<li><dl class="simple">
<dt>If so:</dt><dd><ul>
<li><p>Inserts the text <cite>“Search here”</cite>.</p></li>
<li><p>Sets the text color to grey.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<dl class="simple">
<dt><strong>Used For:</strong></dt><dd><ul class="simple">
<li><p>Providing user-friendly guidance in input fields with placeholder text.</p></li>
</ul>
</dd>
<dt><strong>Dependencies:</strong></dt><dd><ul class="simple">
<li><p>Assumes <cite>self.search_bar</cite> is a <cite>tk.Entry</cite> widget.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="id17">
<h3>Notes<a class="headerlink" href="#id17" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>The GUI is designed for 800x650 resolution</p></li>
<li><p>All database operations are reflected immediately in the UI</p></li>
<li><p>Input validation is performed for Modbus addresses</p></li>
<li><p>Confirmation dialogs are shown for destructive operations</p></li>
<li><p>All functions return <cite>None</cite> unless otherwise specified</p></li>
</ul>
</section>
</section>
<section id="dbintegration">
<span id="id18"></span><h2>dbIntegration<a class="headerlink" href="#dbintegration" title="Link to this heading"></a></h2>
<p>This module manages all MongoDB-related operations for the XBee Modbus Gateway system. It handles:</p>
<ul class="simple">
<li><p>Configuration, validation, and updating of XBee radio metadata such as MAC addresses, Modbus start/end addresses, and node identifiers.</p></li>
<li><p>Ensuring Modbus address allocation is valid and conflict-free using range validation and gap detection.</p></li>
<li><p>Updating and retrieving reusable Modbus address ranges for dynamic allocation.</p></li>
<li><p>Managing historical data storage for each XBee radio, supporting initialization, updates, and full data swaps in cases of MAC address reassignment.</p></li>
<li><p>Providing database interfaces for querying and modifying the Modbus address map and XBee radio assignments.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The MongoDB schema is optimized for time-series storage, and each XBee device is
tracked using its 64-bit MAC address.</p>
</div>
<section id="id19">
<h3>Module Setup<a class="headerlink" href="#id19" title="Link to this heading"></a></h3>
<section id="modules-dependencies">
<h4>Modules &amp; Dependencies<a class="headerlink" href="#modules-dependencies" title="Link to this heading"></a></h4>
<p>The following standard and third-party modules are imported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">datetime</span></code>, <code class="docutils literal notranslate"><span class="pre">random</span></code>, <code class="docutils literal notranslate"><span class="pre">string</span></code>:
Core Python modules used for timestamps, ID generation, and text manipulation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pymongo</span></code>, <code class="docutils literal notranslate"><span class="pre">pymongo.errors.PyMongoError</span></code>:
MongoDB driver for Python and exception handling for database operations.</p></li>
</ul>
<p>Application-specific modules:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">modules.variables</span></code>:
Stores shared runtime variables and configuration constants.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modules.modbus</span></code>:
Provides:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">getIpAddress</span></code>: Retrieves the current IP address of the device, used to bind the MongoDB client to the local network interface.</p></li>
</ul>
</li>
</ul>
</section>
<section id="mongodb-collections">
<h4>MongoDB Collections<a class="headerlink" href="#mongodb-collections" title="Link to this heading"></a></h4>
<p>Two main MongoDB collections are initialized:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code>:
Stores metadata for each configured XBee device, such as MAC address, Modbus address range, and human-readable identifier.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">availableModbusAddressCollection</span></code>:
Maintains a list of reusable Modbus address ranges freed after device deletion or reallocation.</p></li>
</ul>
</section>
<section id="database-initialization">
<h4>Database Initialization<a class="headerlink" href="#database-initialization" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dbclient</span> <span class="pre">=</span> <span class="pre">pymongo.MongoClient(...)</span></code>:
Initializes the MongoDB client connection using the host IP determined by <code class="docutils literal notranslate"><span class="pre">getIpAddress()</span></code> from <code class="docutils literal notranslate"><span class="pre">modules.modbus</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gatewaDb</span> <span class="pre">=</span> <span class="pre">dbclient[&quot;Gateway&quot;]</span></code>:
References the main MongoDB database used by the gateway system.</p></li>
</ul>
</section>
</section>
<section id="modbusaddresspolice">
<h3>modbusAddressPolice<a class="headerlink" href="#modbusaddresspolice" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">modbusAddressPolice</span><span class="p">(</span><span class="n">proposedStartAddress</span><span class="p">,</span> <span class="n">supposedEndAddress</span><span class="p">)</span>
</pre></div>
</div>
<p>Validates whether a given Modbus address range is available and conforms to system constraints.</p>
<blockquote>
<div><p>This function checks whether a proposed range of Modbus register addresses is:
- within allowable numeric bounds,
- not overlapping with any existing Modbus address ranges already registered in the system,
- and structurally valid according to defined system-wide rules.</p>
<p>It is typically used during the configuration or onboarding of new XBee radio nodes to ensure
that each device is mapped to a safe and unique holding register range in the Modbus server context.</p>
<dl class="field-list simple">
<dt class="field-odd">param int proposedStartAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The first Modbus holding register address being proposed for
assignment (e.g., 40001).</p>
</dd>
<dt class="field-even">param int supposedEndAddress<span class="colon">:</span></dt>
<dd class="field-even"><p>The last Modbus holding register address (inclusive) being
proposed.</p>
</dd>
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>Returns a validation result object:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> — if the proposed range is valid and available.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{&quot;error&quot;:</span> <span class="pre">&quot;&lt;reason&gt;&quot;}</span></code> — if the proposed range is invalid or would conflict with existing addresses.</p></li>
</ul>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>Union[bool, dict]</p>
</dd>
</dl>
</div></blockquote>
<section id="validation-logic">
<h4>Validation Logic<a class="headerlink" href="#validation-logic" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>The start address must be less than or equal to the end address.</p></li>
<li><p>The length (number of digits) of the start address must conform to the <cite>validModbusAddressLength</cite> constraint defined in <cite>variables</cite>.</p></li>
<li><p>The range must fall within bounds set by <cite>variables.lowestRegister</cite> and <cite>variables.highestRegister</cite>.</p></li>
<li><p>The address range must not overlap with any existing ranges stored in the <cite>configuredRadioCollection</cite> MongoDB collection.</p></li>
</ul>
</div></blockquote>
</section>
<section id="overlapping-address-rule">
<h4>Overlapping Address Rule:<a class="headerlink" href="#overlapping-address-rule" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Two address ranges are considered overlapping if:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>proposedStart &lt;= existingEnd and proposedEnd &gt;= existingStart
</pre></div>
</div>
</div></blockquote>
</section>
<section id="example-usage">
<h4>Example Usage:<a class="headerlink" href="#example-usage" title="Link to this heading"></a></h4>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">modbusAddressPolice</span><span class="p">(</span><span class="mi">40021</span><span class="p">,</span> <span class="mi">40040</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Modbus address range is valid.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Address validation failed:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="error-response-format">
<h4>Error Response Format:<a class="headerlink" href="#error-response-format" title="Link to this heading"></a></h4>
<blockquote>
<div><p>When validation fails, the function returns a dictionary of the form:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Descriptive error message&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="typical-errors">
<h4>Typical Errors:<a class="headerlink" href="#typical-errors" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>“Start address cannot be greater than end address”</p></li>
<li><p>“Invalid modbus address”</p></li>
<li><p>“Modbus address out of range”</p></li>
<li><p>“Could not update: Selected modbus startAddress would cause address overlapping”</p></li>
<li><p>Any internal exception is returned as an error string</p></li>
</ul>
</div></blockquote>
</section>
<section id="id20">
<h4>Dependencies:<a class="headerlink" href="#id20" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>Uses global <cite>variables</cite> module to access:
- <cite>lowestRegister</cite>
- <cite>highestRegister</cite>
- <cite>validModbusAddressLength</cite></p></li>
<li><p>Reads from <cite>configuredRadioCollection</cite>, a MongoDB collection containing all configured devices and their Modbus address ranges.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="updatereusableaddress">
<h3>updateReusableAddress<a class="headerlink" href="#updatereusableaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">updateReusableAddress</span><span class="p">(</span><span class="n">returnData</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Scans configured Modbus address allocations and updates the database with all available (unused) address ranges.</p>
<blockquote>
<div><p>This utility function is essential for maintaining visibility into unallocated Modbus holding register blocks. It identifies address gaps between already-configured devices and updates the <cite>availableModbusAddressCollection</cite> accordingly. The available ranges can then be reused when configuring new XBee devices.</p>
<dl class="field-list">
<dt class="field-odd">param bool returnData<span class="colon">:</span></dt>
<dd class="field-odd"><blockquote>
<div><p>Optional. If set, the function returns the list of available address blocks as a list of dictionaries.
If <cite>None</cite> (default), the function runs silently and only populates the database.</p>
</div></blockquote>
<dl class="field-list">
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><ul>
<li><p>If <cite>returnData</cite> is <cite>None</cite>, returns <cite>None</cite>.</p></li>
<li><p>If address gaps are found, returns a list of available range objects:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;modbusAddressRange&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4010-4030&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;consumable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;✅&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>If no address gaps exist, returns:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;info&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;No available address gaps found.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>If an error occurs, returns a dictionary with <cite>error</cite> and optional <cite>details</cite>.</p></li>
</ul>
</dd>
</dl>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>Union[None, list, dict]</p>
</dd>
</dl>
</div></blockquote>
<section id="function-overview">
<h4>Function Overview<a class="headerlink" href="#function-overview" title="Link to this heading"></a></h4>
<blockquote>
<div><p>This function performs the following steps:</p>
<ol class="arabic simple">
<li><p><strong>Drops the `availableModbusAddressCollection`</strong> to clear outdated data.</p></li>
<li><p><strong>Retrieves all configured address ranges</strong> from <cite>configuredRadioCollection</cite>.</p></li>
<li><p><strong>Sorts</strong> the address ranges by <cite>modbusStartAddress</cite>.</p></li>
<li><p><strong>Scans for gaps</strong> between configured ranges:
- A “gap” is defined as an unused range between two allocated address blocks.
- Gaps are considered <strong>consumable</strong> if their size is greater than or equal to <cite>variables.incrementalModbusAddress</cite>.</p></li>
<li><p><strong>Stores valid gaps</strong> in <cite>availableModbusAddressCollection</cite>, each with:
- <cite>modbusAddressRange</cite>: The range in “start-end” format.
- <cite>size</cite>: Number of registers in the gap.
- <cite>consumable</cite>: “✅” if usable, “❌” otherwise.</p></li>
<li><p><strong>Optionally returns the result</strong> if <cite>returnData</cite> is specified.</p></li>
</ol>
</div></blockquote>
</section>
<section id="gap-detection-algorithm">
<h4>Gap Detection Algorithm<a class="headerlink" href="#gap-detection-algorithm" title="Link to this heading"></a></h4>
<blockquote>
<div><p>Gaps are identified by comparing the <cite>endAddress</cite> of a configured device with the <cite>startAddress</cite> of the next:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">startAddress</span> <span class="o">-</span> <span class="n">previousEnd</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">gapStart</span> <span class="o">=</span> <span class="n">previousEnd</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gapEnd</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The final unallocated range (from the last used address to the highest possible register) is also checked.</p>
</div></blockquote>
</section>
<section id="consumable-criteria">
<h4>Consumable Criteria<a class="headerlink" href="#consumable-criteria" title="Link to this heading"></a></h4>
<blockquote>
<div><p>A gap is marked as <strong>consumable</strong> (<cite>✅</cite>) only if:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gapSize</span> <span class="o">&gt;=</span> <span class="n">variables</span><span class="o">.</span><span class="n">incrementalModbusAddress</span>
</pre></div>
</div>
<p>Otherwise, it is marked as <strong>not consumable</strong> (<cite>❌</cite>).</p>
</div></blockquote>
</section>
<section id="id21">
<h4>Error Handling<a class="headerlink" href="#id21" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>MongoDB <cite>insert_one</cite> failures are caught and returned with detailed error messages.</p></li>
<li><p>General exceptions are caught and returned with an <cite>“error”</cite> key.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id22">
<h4>Dependencies<a class="headerlink" href="#id22" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>MongoDB collections:</p>
<ul>
<li><p><cite>configuredRadioCollection</cite> (read-only)</p></li>
<li><p><cite>availableModbusAddressCollection</cite> (dropped and written)</p></li>
</ul>
</li>
<li><p>Variables from the <cite>variables</cite> module:</p>
<ul>
<li><p><cite>lowestRegister</cite></p></li>
<li><p><cite>highestRegister</cite></p></li>
<li><p><cite>incrementalModbusAddress</cite></p></li>
</ul>
</li>
<li><p>Requires <cite>PyMongoError</cite> for database exception handling.</p></li>
</ul>
</div></blockquote>
</section>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h4>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run silently</span>
<span class="n">updateReusableAddress</span><span class="p">()</span>

<span class="c1"># Run and fetch results for further processing</span>
<span class="n">availableBlocks</span> <span class="o">=</span> <span class="n">updateReusableAddress</span><span class="p">(</span><span class="n">returnData</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">availableBlocks</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="s2">&quot;modbusAddressRange&quot;</span><span class="p">],</span> <span class="n">block</span><span class="p">[</span><span class="s2">&quot;consumable&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="updateallendaddress">
<h3>updateAllEndAddress<a class="headerlink" href="#updateallendaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">updateAllEndAddress</span><span class="p">(</span><span class="n">newRange</span><span class="p">)</span>
</pre></div>
</div>
<p>Recalculates and updates the <cite>modbusEndAddress</cite> field for all configured radios using a uniform range size derived from the provided <cite>newRange</cite> value.</p>
<blockquote>
<div><p>This function is useful when there’s a global change in how many Modbus registers should be allocated per device. It ensures all documents in the <cite>configuredRadioCollection</cite> reflect this new register allocation model, based on their existing <cite>modbusStartAddress</cite>.</p>
<dl class="field-list">
<dt class="field-odd">param int newRange<span class="colon">:</span></dt>
<dd class="field-odd"><p>The number of Modbus registers to assign per device. The function adds <cite>(newRange - 1)</cite> to each device’s <cite>modbusStartAddress</cite> to compute the new <cite>modbusEndAddress</cite>.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul>
<li><p>If updates are made:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;sucess&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;updated 25&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>(Where 25 is the number of documents updated.)</p>
</li>
<li><p>If an error occurs during the update operation:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Descriptive error message&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>If no <cite>modbusStartAddress</cite> is found, or no documents are modified, returns <cite>None</cite>.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>Union[dict, None]</p>
</dd>
</dl>
</div></blockquote>
<section id="functional-summary">
<h4>Functional Summary<a class="headerlink" href="#functional-summary" title="Link to this heading"></a></h4>
<p>This function:</p>
<blockquote>
<div><ol class="arabic">
<li><p><strong>Queries all radio documents</strong> from <cite>configuredRadioCollection</cite> that have a <cite>modbusStartAddress</cite>.</p></li>
<li><p><strong>Calculates</strong> the new <cite>modbusEndAddress</cite> for each document as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">newEndAddress</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">newRange</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Performs a batch update</strong> using <cite>bulk_write()</cite> with <cite>UpdateOne</cite> operations to apply changes efficiently.</p></li>
<li><p><strong>Calls `updateReusableAddress()`</strong> to refresh available address blocks after modifications.</p></li>
<li><p><strong>Returns</strong> the number of modified documents or an error response.</p></li>
</ol>
</div></blockquote>
</section>
<section id="id23">
<h4>Error Handling<a class="headerlink" href="#id23" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>All exceptions are caught and returned as a dictionary with an <cite>error</cite> key.</p></li>
<li><p>If the <cite>bulk_write()</cite> operation fails or modifies nothing, the function silently returns <cite>None</cite>.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id24">
<h4>Dependencies<a class="headerlink" href="#id24" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>MongoDB collection:</p>
<ul>
<li><p><cite>configuredRadioCollection</cite> (read and write)</p></li>
</ul>
</li>
<li><p>External function:</p>
<ul>
<li><p><cite>updateReusableAddress()</cite> — called after successful updates to refresh available address gaps.</p></li>
</ul>
</li>
<li><p>Libraries:</p>
<ul>
<li><p><cite>pymongo.UpdateOne</cite> and <cite>bulk_write</cite></p></li>
</ul>
</li>
</ul>
</div></blockquote>
</section>
<section id="performance-note">
<h4>Performance Note<a class="headerlink" href="#performance-note" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>The use of <cite>bulk_write()</cite> ensures efficient updating even for large numbers of documents.</p></li>
<li><p>The function assumes the presence of a valid <cite>modbusStartAddress</cite> in each document.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id25">
<h4>Example Usage<a class="headerlink" href="#id25" title="Link to this heading"></a></h4>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update all configured radios to use 20 Modbus registers each</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">updateAllEndAddress</span><span class="p">(</span><span class="n">newRange</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="related-functions">
<h4>Related Functions<a class="headerlink" href="#related-functions" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">updateReusableAddress()</span></code> — updates the list of reusable Modbus address gaps based on current configurations.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="dbquerymodbusstartaddress">
<h3>dbQueryModbusStartAddress<a class="headerlink" href="#dbquerymodbusstartaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">)</span>
</pre></div>
</div>
<p>Retrieves the configured Modbus start address for a given XBee MAC address from the database.</p>
<p>This function performs a lookup in the <code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code> to find the <code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code> associated with a specific XBee radio. It is typically used during Modbus polling to determine where sensor data from each radio should be written in the Modbus context.</p>
<dl class="field-list simple">
<dt class="field-odd">param str xbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The 64-bit MAC address of the XBee device, provided as a string. The function automatically converts the address to uppercase to match the format stored in the database.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p>If the MAC address exists in the database, returns the integer value of <code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code>.</p></li>
<li><p>If the MAC address is not found, returns a string indicating that the address is missing.</p></li>
<li><p>If an exception occurs, prints the error and returns it as a string.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>Union[int, str]</p>
</dd>
</dl>
<section id="id26">
<h4>Function Overview<a class="headerlink" href="#id26" title="Link to this heading"></a></h4>
<p>This function executes the following steps:</p>
<ol class="arabic simple">
<li><p>Converts the provided MAC address to uppercase.</p></li>
<li><p>Searches the <code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code> for a matching <code class="docutils literal notranslate"><span class="pre">xbeeMac</span></code> value.</p></li>
<li><p>If a matching document is found, extracts and returns the <code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code>.</p></li>
<li><p>If no document is found, returns a descriptive message.</p></li>
<li><p>Catches and prints any exceptions, returning the error message.</p></li>
</ol>
</section>
<section id="usage-context">
<h4>Usage Context<a class="headerlink" href="#usage-context" title="Link to this heading"></a></h4>
<p>This function is called inside the Modbus polling logic to determine the register block for each XBee:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startAddress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
    <span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id27">
<h4>Error Handling<a class="headerlink" href="#id27" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Wraps all logic in a try-except block.</p></li>
<li><p>On failure, prints the error message and returns it.</p></li>
<li><p>Ensures the main polling loop remains stable during faults.</p></li>
</ul>
</section>
<section id="id28">
<h4>Dependencies<a class="headerlink" href="#id28" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>MongoDB collection:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">configuredRadioCollection</span></code> — stores XBee device configurations and associated Modbus address mappings.</p></li>
</ul>
</li>
</ul>
</section>
<section id="id29">
<h4>Example<a class="headerlink" href="#id29" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mac</span> <span class="o">=</span> <span class="s2">&quot;0013A20040B41234&quot;</span>
<span class="n">startAddress</span> <span class="o">=</span> <span class="n">dbQueryModbusStartAddress</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">startAddress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start address: </span><span class="si">{</span><span class="n">startAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error or not found: </span><span class="si">{</span><span class="n">startAddress</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="configurexbeeradio">
<h3>configureXbeeRadio<a class="headerlink" href="#configurexbeeradio" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configureXbeeRadio</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">nodeIdentifier</span><span class="p">)</span>
</pre></div>
</div>
<p>Registers a new XBee radio device in the system by associating it with a unique MAC address, Modbus register block, and node identifier.</p>
<blockquote>
<div><p>This function performs comprehensive validation to ensure no conflicts exist in the configured Modbus address space or device identifiers. It calculates the Modbus <strong>end address internally</strong> using the formula:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">endAddress</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">incrementalModbusAddress</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>On success, it updates the database and creates a dedicated collection for storing historical data for that device.</p>
<dl class="field-list">
<dt class="field-odd">param str xbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The 64-bit MAC address of the XBee radio to configure (e.g., <code class="docutils literal notranslate"><span class="pre">0013A20040B2C3D4</span></code>). Must be uppercase and 16 characters long.</p>
</dd>
<dt class="field-even">param int startAddress<span class="colon">:</span></dt>
<dd class="field-even"><p>The starting Modbus register address for this device. Must be an integer and not conflict with existing device ranges.</p>
</dd>
<dt class="field-odd">param str nodeIdentifier<span class="colon">:</span></dt>
<dd class="field-odd"><p>A unique, human-readable label for the device (e.g., <code class="docutils literal notranslate"><span class="pre">WELLHEAD_A01</span></code>). Cannot be empty or reused.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul>
<li><p>On success:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;radio configured successfully&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On validation failure (e.g., duplicates, format errors):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Start address already utilized by WELLHEAD_A01&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On general exception:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Exception message&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</div></blockquote>
<section id="address-calculation">
<h4>Address Calculation<a class="headerlink" href="#address-calculation" title="Link to this heading"></a></h4>
<ul>
<li><p>The function automatically derives the Modbus <cite>endAddress</cite> using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">endAddress</span> <span class="o">=</span> <span class="n">startAddress</span> <span class="o">+</span> <span class="p">(</span><span class="n">variables</span><span class="o">.</span><span class="n">incrementalModbusAddress</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>This defines the register block [startAddress, endAddress] inclusive.</p></li>
</ul>
</section>
<section id="id30">
<h4>Validation Logic<a class="headerlink" href="#id30" title="Link to this heading"></a></h4>
<ol class="arabic simple">
<li><p><strong>MAC Address:</strong>
- Must be uppercase and 16 characters long.
- Must not already exist in <cite>configuredRadioCollection</cite>.</p></li>
<li><p><strong>Start Address:</strong>
- Must be a valid integer.
- Must not be already used as a start address.
- Must not overlap with any existing Modbus block (validated by <cite>modbusAddressPolice()</cite>).</p></li>
<li><p><strong>Node Identifier:</strong>
- Cannot be empty.
- Must be unique across configured devices.</p></li>
</ol>
</section>
<section id="configuration-actions">
<h4>Configuration Actions<a class="headerlink" href="#configuration-actions" title="Link to this heading"></a></h4>
<ul>
<li><p>Inserts the following document into <cite>configuredRadioCollection</cite>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;xbeeNodeIdentifier&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;NODE1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;xbeeMac&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;modbusStartAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4001</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;modbusEndAddress&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4050</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Creates a MongoDB collection named after the MAC address (e.g., <cite>0013A20040B2C3D4</cite>) for storing historical radio data. The collection is seeded with:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-05-06T12:00:00&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Triggers a call to <cite>updateReusableAddress()</cite> to recalculate and store the list of free Modbus address blocks.</p></li>
</ul>
</section>
<section id="id31">
<h4>Dependencies<a class="headerlink" href="#id31" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>MongoDB Collections:
- <cite>configuredRadioCollection</cite>
- <cite>gatewayDb[&lt;xbeeMacAddress&gt;]</cite> (dynamic collection for history)</p></li>
<li><p>Functions:
- <cite>modbusAddressPolice()</cite>
- <cite>updateReusableAddress()</cite></p></li>
<li><p>Constants from <cite>variables</cite>:
- <cite>validMacAddressLength</cite>
- <cite>incrementalModbusAddress</cite></p></li>
</ul>
</section>
<section id="id32">
<h4>Example<a class="headerlink" href="#id32" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configureXbeeRadio</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="mi">4001</span><span class="p">,</span> <span class="s2">&quot;WELLHEAD_A01&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="updatexbeedetails">
<h3>updateXbeeDetails<a class="headerlink" href="#updatexbeedetails" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">updateXbeeDetails</span><span class="p">(</span><span class="n">oldXbeeMacAddress</span><span class="p">,</span> <span class="n">jsonParameterToBeUpdated</span><span class="p">)</span>
</pre></div>
</div>
<p>Updates specific fields of an already-configured XBee radio entry, with full validation of MAC address uniqueness, Modbus register allocation correctness, and node identifier exclusivity.</p>
<blockquote>
<div><p>This function allows updating one or more of the following fields for an existing device:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeMac</span></code> (MAC address)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusEndAddress</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeNodeIdentifier</span></code></p></li>
</ul>
<p>Updates are only accepted if no conflicts exist in the system, and the modified values differ from the existing values.
If address-related fields are modified, the <cite>updateReusableAddress()</cite> utility is automatically triggered to refresh available register gaps. Additionally, if a MAC address is changed, the function <strong>renames the associated historian collection</strong> to match the new MAC.</p>
<dl class="field-list">
<dt class="field-odd">param str oldXbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The current MAC address of the XBee device to update.
Must already exist in the <cite>configuredRadioCollection</cite>.</p>
</dd>
<dt class="field-even">param dict jsonParameterToBeUpdated<span class="colon">:</span></dt>
<dd class="field-even"><p>A dictionary containing one or more keys to update.
Only the following keys are allowed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeMac</span></code> (str)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusStartAddress</span></code> (int)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modbusEndAddress</span></code> (int)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeNodeIdentifier</span></code> (str)</p></li>
</ul>
</dd>
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><ul>
<li><p>On success:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Document updated successfully.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On validation failure:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;new mac address already exist&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On redundant request (no change detected):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Update request received, but no changes were made.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>On general exception:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Exception message&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</div></blockquote>
<section id="input-validations">
<h4>Input Validations<a class="headerlink" href="#input-validations" title="Link to this heading"></a></h4>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">jsonParameterToBeUpdated</span></code> must be a <cite>dict</cite>. Otherwise:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Structure of updated value is invalid. Expected a dictionary.&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Only the allowed keys are permitted. If unknown keys are found:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid keys found: [&#39;badKey&#39;]. Allowed keys: [...]&quot;</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="mac-address-update">
<h4>MAC Address Update<a class="headerlink" href="#mac-address-update" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Validates that the new MAC:</p>
<ul>
<li><p>Is 16 characters long (as per <cite>variables.validMacAddressLength</cite>)</p></li>
<li><p>Is different from the existing MAC</p></li>
<li><p>Does not already exist in the system</p></li>
</ul>
</li>
<li><p>If valid:</p>
<ul>
<li><p>The existing historian collection under <cite>gatewayDb[oldXbeeMacAddress]</cite> is <strong>renamed</strong> to the new MAC.</p></li>
</ul>
</li>
</ul>
</section>
<section id="modbus-address-update">
<h4>Modbus Address Update<a class="headerlink" href="#modbus-address-update" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>If either <cite>modbusStartAddress</cite> or <cite>modbusEndAddress</cite> is updated:</p>
<ul>
<li><p>The function resolves both values, using provided ones or falling back to existing ones.</p></li>
<li><p>The range is validated using <cite>modbusAddressPolice(start, end)</cite>.</p></li>
<li><p>If valid, the update is flagged to <strong>refresh address gaps</strong> via <cite>updateReusableAddress()</cite> after DB update.</p></li>
</ul>
</li>
</ul>
</section>
<section id="node-identifier-update">
<h4>Node Identifier Update<a class="headerlink" href="#node-identifier-update" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>The new identifier:</p>
<ul>
<li><p>Must not be empty.</p></li>
<li><p>Must be different from the existing one.</p></li>
<li><p>Must not be already used by another radio.</p></li>
</ul>
</li>
</ul>
</section>
<section id="update-workflow">
<h4>Update Workflow<a class="headerlink" href="#update-workflow" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Normalize all string inputs to uppercase.</p></li>
<li><p>Validate each requested change:</p>
<ul class="simple">
<li><p>MAC → uniqueness and length</p></li>
<li><p>Modbus → address overlap prevention</p></li>
<li><p>Node ID → uniqueness and validity</p></li>
</ul>
</li>
<li><p>Perform atomic update via:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="n">oldXbeeMacAddress</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">updates</span><span class="p">})</span>
</pre></div>
</div>
</li>
<li><p>If a Modbus address was changed:</p>
<ul class="simple">
<li><p>Call <cite>updateReusableAddress()</cite> to recalculate and store new available blocks.</p></li>
</ul>
</li>
</ol>
</section>
<section id="side-effects">
<h4>Side Effects<a class="headerlink" href="#side-effects" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Historian collection is <strong>renamed</strong> if MAC is updated.</p></li>
<li><p>Modbus address availability is <strong>recalculated</strong> if start/end address is changed.</p></li>
</ul>
</section>
<section id="id33">
<h4>Dependencies<a class="headerlink" href="#id33" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>MongoDB collections:</p>
<ul>
<li><p><cite>configuredRadioCollection</cite></p></li>
<li><p><cite>gatewayDb[&lt;xbeeMac&gt;]</cite> (for renaming historian)</p></li>
</ul>
</li>
<li><p>Internal functions:</p>
<ul>
<li><p><cite>modbusAddressPolice()</cite></p></li>
<li><p><cite>updateReusableAddress()</cite></p></li>
</ul>
</li>
<li><p>Variables from <cite>variables</cite>:</p>
<ul>
<li><p><cite>validMacAddressLength</cite></p></li>
</ul>
</li>
</ul>
</section>
<section id="id34">
<h4>Example<a class="headerlink" href="#id34" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update MAC address and start address</span>
<span class="n">updateXbeeDetails</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="s2">&quot;0013A20040B2C3D9&quot;</span><span class="p">,</span>
    <span class="s2">&quot;modbusStartAddress&quot;</span><span class="p">:</span> <span class="mi">4060</span>
<span class="p">})</span>

<span class="c1"># Update only node identifier</span>
<span class="n">updateXbeeDetails</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;xbeeNodeIdentifier&quot;</span><span class="p">:</span> <span class="s2">&quot;WELLHEAD_B07&quot;</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="storexbeehistorydata">
<h3>storeXbeeHistoryData<a class="headerlink" href="#storexbeehistorydata" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">storeXbeeHistoryData</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">,</span> <span class="n">xbeeData</span><span class="p">,</span> <span class="n">xbeeDataTimestamp</span><span class="p">)</span>
</pre></div>
</div>
<p>Stores a timestamped data snapshot from an XBee device into a dedicated MongoDB historian collection named after the XBee MAC address.</p>
<blockquote>
<div><p>This function is intended to be called whenever a new packet of radio sensor data is received. It verifies the MAC address has been configured, ensures the data is correctly structured as a list, and inserts it into a corresponding MongoDB collection (one collection per radio, named by MAC).</p>
<dl class="field-list simple">
<dt class="field-odd">param str xbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>MAC address of the radio node. Must match a previously configured device in <cite>configuredRadioCollection</cite>.</p>
</dd>
<dt class="field-even">param list xbeeData<span class="colon">:</span></dt>
<dd class="field-even"><p>List of sensor or telemetry values received from the XBee device. Must be of list type.</p>
</dd>
<dt class="field-odd">param datetime xbeeDataTimestamp<span class="colon">:</span></dt>
<dd class="field-odd"><p>A <cite>datetime</cite> object representing when the data was received. Used as the timestamp for the inserted document.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code> on successful insertion into the historian collection.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> on validation failure, database failure, or unexpected exceptions.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool | None</p>
</dd>
</dl>
</div></blockquote>
<section id="input-normalization-and-validation">
<h4>Input Normalization and Validation<a class="headerlink" href="#input-normalization-and-validation" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>MAC Normalization</strong>:
- MAC address is converted to uppercase with <code class="docutils literal notranslate"><span class="pre">str(xbeeMacAddress).upper()</span></code>.</p></li>
<li><p><strong>MAC Existence Check</strong>:
- The function checks if the MAC is registered in <cite>configuredRadioCollection</cite>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="n">xbeeMacAddress</span><span class="p">})</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>If not found, the function logs an error and exits early.</p></li>
</ul>
</li>
<li><p><strong>Data Type Validation</strong>:
- Ensures <cite>xbeeData</cite> is a Python list. If not, it logs the type mismatch and exits.</p></li>
</ol>
</section>
<section id="historian-collection-behavior">
<h4>Historian Collection Behavior<a class="headerlink" href="#historian-collection-behavior" title="Link to this heading"></a></h4>
<ul>
<li><p>A historian collection is automatically created or reused using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeHistoryEntry</span> <span class="o">=</span> <span class="n">gatewayDb</span><span class="p">[</span><span class="n">xbeeMacAddress</span><span class="p">]</span>
</pre></div>
</div>
<p>This ensures:
- Each XBee device gets its own dedicated collection.
- The collection name is the uppercase MAC string (e.g., <cite>0013A20040B2C3D4</cite>).</p>
</li>
</ul>
</section>
<section id="document-structure-example">
<h4>Document Structure Example:<a class="headerlink" href="#document-structure-example" title="Link to this heading"></a></h4>
<p>The inserted document has the structure:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-05-06T14:33:21.832000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">23.4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">55.6</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;more&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>This allows efficient time-series querying and historical graphing.</p>
</section>
<section id="failure-modes">
<h4>Failure Modes<a class="headerlink" href="#failure-modes" title="Link to this heading"></a></h4>
<ul>
<li><p><strong>Unregistered MAC address</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Mac Address has not been configured
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
<li><p><strong>Data is not a list</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Expected data &lt;xbeeData&gt; should be passed as list
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
<li><p><strong>MongoDB insertion fails</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Could not update the database
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
<li><p><strong>Unhandled exception</strong>:</p>
<p>Logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Fatal error with details as; &lt;exception string&gt;
</pre></div>
</div>
<p>Returns: <code class="docutils literal notranslate"><span class="pre">None</span></code></p>
</li>
</ul>
</section>
<section id="id35">
<h4>Dependencies<a class="headerlink" href="#id35" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><strong>MongoDB collections</strong>:
- <cite>configuredRadioCollection</cite>: Verifies MAC address registration.
- <cite>gatewayDb[&lt;xbeeMac&gt;]</cite>: Target collection for historian entries.</p></li>
</ul>
</section>
<section id="id36">
<h4>Example Usage<a class="headerlink" href="#id36" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">storeXbeeHistoryData</span><span class="p">(</span>
    <span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="mf">78.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">33.5</span><span class="p">,</span> <span class="mf">9.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id37">
<h4>Notes<a class="headerlink" href="#id37" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>This function assumes that the historian collections have been initialized via <cite>configureXbeeRadio()</cite>.</p></li>
<li><p>It does <strong>not</strong> check for data schema conformity (e.g., number or type of elements in <cite>xbeeData</cite>) beyond requiring a list.</p></li>
</ul>
</section>
</section>
<section id="swapxbeehistoryandmacaddress">
<h3>swapXbeeHistoryAndMacAddress<a class="headerlink" href="#swapxbeehistoryandmacaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">swapXbeeHistoryAndMacAddress</span><span class="p">(</span><span class="n">firstXbeeMacAddress</span><span class="p">,</span> <span class="n">secondXbeeMacAddress</span><span class="p">)</span>
</pre></div>
</div>
<p>Swaps the XBee MAC addresses and historical data collections between two configured radios. This function is useful in real-world scenarios where physical XBee devices are swapped between two locations.</p>
<blockquote>
<div><p>Instead of using <cite>updateXbeeDetails()</cite>, which would raise a duplication error when changing MAC addresses, this function handles the swap cleanly by also exchanging the corresponding historian collections, ensuring historical data continuity.</p>
<dl class="field-list simple">
<dt class="field-odd">param str firstXbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The MAC address of the first configured XBee device (before the swap).</p>
</dd>
<dt class="field-even">param str secondXbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-even"><p>The MAC address of the second configured XBee device (before the swap).</p>
</dd>
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{&quot;success&quot;:</span> <span class="pre">&quot;Document</span> <span class="pre">updated</span> <span class="pre">successfully.&quot;}</span></code> if swap was successful.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{&quot;error&quot;:</span> <span class="pre">&quot;&lt;reason&gt;&quot;}</span></code> if an error occurs or inputs are invalid.</p></li>
</ul>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</div></blockquote>
<section id="purpose-and-use-case">
<h4>Purpose and Use Case<a class="headerlink" href="#purpose-and-use-case" title="Link to this heading"></a></h4>
<p>This function is specifically designed for <strong>field operations</strong> where:
- Two XBee radios (e.g., installed at well A and well B) are physically swapped.
- The MAC addresses are now mismatched with their original Modbus start addresses and historian data.
- Directly calling <cite>updateXbeeDetails()</cite> would violate uniqueness constraints for MACs.</p>
<p>Instead, <cite>swapXbeeHistoryAndMacAddress()</cite>:
1. Swaps their MAC entries in the <cite>configuredRadioCollection</cite>.
2. Swaps their historian collections in the MongoDB database.</p>
</section>
<section id="validation-and-normalization">
<h4>Validation and Normalization<a class="headerlink" href="#validation-and-normalization" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>Both input MACs are normalized to uppercase.</p></li>
<li><p>The function verifies that <strong>both MACs exist</strong> in the <cite>configuredRadioCollection</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">mac</span><span class="o">&gt;</span><span class="p">})</span>
</pre></div>
</div>
<p>If either MAC is unregistered, an error is returned.</p>
</li>
</ol>
</section>
<section id="mongodb-rename-mechanism">
<h4>MongoDB Rename Mechanism<a class="headerlink" href="#mongodb-rename-mechanism" title="Link to this heading"></a></h4>
<p>Historian collections (one per MAC) are renamed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gatewayDb</span><span class="p">[</span><span class="n">firstMac</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">secondMac</span><span class="p">)</span>
<span class="n">gatewayDb</span><span class="p">[</span><span class="n">secondMac</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">firstMac</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Important</strong>:
- MongoDB <cite>rename()</cite> swaps the collection name while keeping its contents.
- This effectively <strong>swaps the historical data</strong> stored under each MAC.
- No data is lost or duplicated.</p>
</section>
<section id="mac-field-swapping-in-database">
<h4>MAC Field Swapping in Database<a class="headerlink" href="#mac-field-swapping-in-database" title="Link to this heading"></a></h4>
<p>The configured MAC address values in <cite>configuredRadioCollection</cite> are updated accordingly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">new_value</span><span class="o">&gt;</span><span class="p">}}</span>
</pre></div>
</div>
<p>Two <cite>update_one()</cite> operations are run—one per MAC.</p>
</section>
<section id="success-error-handling">
<h4>Success &amp; Error Handling<a class="headerlink" href="#success-error-handling" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>If both <cite>update_one()</cite> operations modify exactly one document each, a success is returned.</p></li>
<li><p>If no changes are detected, an appropriate error is returned.</p></li>
</ul>
<p>Unhandled exceptions (e.g., from rename conflicts or database access issues) are caught and returned as:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;exception message&gt;&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id38">
<h4>Notes<a class="headerlink" href="#id38" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>This function <strong>does not validate</strong> the structure of historian data itself—it assumes the format is consistent.</p></li>
<li><p>It is designed to be used <strong>only after both MACs have been configured</strong>.</p></li>
<li><p>This operation is <strong>atomic in intent but not transactional</strong>, so if the rename or update fails midway, manual recovery may be needed.</p></li>
</ul>
</section>
<section id="id39">
<h4>Example Usage<a class="headerlink" href="#id39" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">swapXbeeHistoryAndMacAddress</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="s2">&quot;0013A20040B2C3A9&quot;</span><span class="p">)</span>

<span class="c1"># Outcome:</span>
<span class="c1"># - Historical data collections of the two radios are swapped</span>
<span class="c1"># - MACs are exchanged in the radio mapping config</span>
</pre></div>
</div>
</section>
</section>
<section id="deletexbeedetails">
<h3>deleteXbeeDetails<a class="headerlink" href="#deletexbeedetails" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">deleteXbeeDetails</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">)</span>
</pre></div>
</div>
<p>Deletes a configured XBee radio device and its associated historical data from the system. This function performs a <strong>full cleanup</strong> — removing both the configuration entry and the corresponding MongoDB historian collection.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">param str xbeeMacAddress<span class="colon">:</span></dt>
<dd class="field-odd"><p>The MAC address of the XBee radio to be deleted. It is case-insensitive and automatically converted to uppercase internally.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{&quot;success&quot;:</span> <span class="pre">&quot;Deleted</span> <span class="pre">&lt;MAC&gt;</span> <span class="pre">and</span> <span class="pre">it's</span> <span class="pre">history</span> <span class="pre">data</span> <span class="pre">successfully.&quot;}</span></code> if the operation succeeds.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{&quot;error&quot;:</span> <span class="pre">&quot;&lt;reason&gt;&quot;}</span></code> if the MAC address is not found or an error occurs.</p></li>
</ul>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</div></blockquote>
<section id="id40">
<h4>Overview<a class="headerlink" href="#id40" title="Link to this heading"></a></h4>
<p>This function is used to <strong>unregister a previously configured XBee radio</strong>, including:</p>
<ul class="simple">
<li><p>Removing its entry from the <cite>configuredRadioCollection</cite> which stores MAC address, Modbus start/end addresses, and node identifiers.</p></li>
<li><p>Dropping its MongoDB historian collection (named using the MAC address) which stores timestamped sensor data.</p></li>
</ul>
<p>It is useful when:</p>
<ul class="simple">
<li><p>A radio is permanently removed from the field.</p></li>
<li><p>Configuration needs to be reset before re-adding.</p></li>
<li><p>Storage optimization is necessary (e.g., clearing unused history collections).</p></li>
</ul>
</section>
<section id="validation-and-preparation">
<h4>Validation and Preparation<a class="headerlink" href="#validation-and-preparation" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>The input MAC is converted to uppercase:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeMacAddress</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xbeeMacAddress</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>The MAC is checked for existence using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="n">xbeeMacAddress</span><span class="p">})</span>
</pre></div>
</div>
<p>If not found, a descriptive error is returned.</p>
</li>
</ol>
</section>
<section id="deletion-steps">
<h4>Deletion Steps<a class="headerlink" href="#deletion-steps" title="Link to this heading"></a></h4>
<p>Once validated, two deletion operations are performed:</p>
<ol class="arabic">
<li><p><strong>Delete configuration entry</strong> from <cite>configuredRadioCollection</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s2">&quot;xbeeMac&quot;</span><span class="p">:</span> <span class="n">xbeeMacAddress</span><span class="p">})</span>
</pre></div>
</div>
</li>
<li><p><strong>Drop historical data</strong> from the MAC-named collection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gatewayDb</span><span class="p">[</span><span class="n">xbeeMacAddress</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
</pre></div>
</div>
<p>This removes the full collection associated with the XBee, including all sensor records.</p>
</li>
</ol>
</section>
<section id="success-criteria">
<h4>Success Criteria<a class="headerlink" href="#success-criteria" title="Link to this heading"></a></h4>
<p>To confirm successful deletion:</p>
<ul>
<li><p>The <cite>delete_one()</cite> operation must indicate <cite>deleted_count == 1</cite></p></li>
<li><p>The dropped historian collection name must no longer appear in:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gatewayDb</span><span class="o">.</span><span class="n">list_collection_names</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>If both are successful:</p>
<ul class="simple">
<li><p>The reusable Modbus address pool is refreshed via <cite>updateReusableAddress()</cite></p></li>
<li><p>A success message is returned.</p></li>
</ul>
<p>If either deletion fails or does not result in a change, an error response is returned:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;delete request received, but no changes were made.&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id41">
<h4>Error Handling<a class="headerlink" href="#id41" title="Link to this heading"></a></h4>
<p>The function uses a <cite>try-except</cite> block to capture all runtime exceptions and return a structured error message:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;exception message&gt;&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id42">
<h4>Side Effects<a class="headerlink" href="#id42" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><strong>State Mutation</strong>: The gateway system’s configuration and historical memory are permanently altered.</p></li>
<li><p><strong>Cleanup</strong>: Releasing unused Modbus address ranges by updating the reusable pool.</p></li>
</ul>
</section>
<section id="id43">
<h4>Notes<a class="headerlink" href="#id43" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>This function is <strong>not reversible</strong> — once the historical collection is dropped, the data is lost.</p></li>
<li><p>Use with caution in live systems where monitoring and audit records are critical.</p></li>
<li><p>This function assumes MongoDB handles renames and drops atomically in a single-node setup. In multi-node environments, ensure replication lag is considered.</p></li>
</ul>
</section>
<section id="id44">
<h4>Example Usage<a class="headerlink" href="#id44" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">deleteXbeeDetails</span><span class="p">(</span><span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">)</span>

<span class="c1"># Result:</span>
<span class="c1"># - Radio with MAC &quot;0013A20040B2C3D4&quot; removed from configuration.</span>
<span class="c1"># - Historical sensor readings dropped from gatewayDb.</span>
</pre></div>
</div>
</section>
</section>
<section id="retrieveallconfiguredradio">
<h3>retrieveAllConfiguredRadio<a class="headerlink" href="#retrieveallconfiguredradio" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">retrieveAllConfiguredRadio</span><span class="p">()</span>
</pre></div>
</div>
<p>Retrieves a list of all configured XBee radios from the database, returning their stored configuration values (without MongoDB internal metadata). This is useful for management interfaces, diagnostics, or administrative dashboards.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p>A list of lists, where each inner list contains values for a configured XBee radio in the order retrieved from MongoDB.</p></li>
<li><p>Or, <code class="docutils literal notranslate"><span class="pre">{&quot;error&quot;:</span> <span class="pre">&quot;&lt;exception</span> <span class="pre">message&gt;&quot;}</span></code> if an error occurs.</p></li>
</ul>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>list or dict</p>
</dd>
</dl>
</div></blockquote>
<section id="id45">
<h4>Overview<a class="headerlink" href="#id45" title="Link to this heading"></a></h4>
<p>This function performs a <strong>read-only scan</strong> of the <cite>configuredRadioCollection</cite>, which stores MAC address, Modbus start/end addresses, and node identifiers for each registered radio.</p>
<p>It <strong>excludes MongoDB’s internal `_id` field</strong> during retrieval and formats each result into a flat list of values.</p>
<p>The structure of each returned item is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="s2">&quot;&lt;xbeeNodeIdentifier&gt;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;&lt;xbeeMac&gt;&quot;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">modbusStartAddress</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">modbusEndAddress</span><span class="o">&gt;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>These lists are then wrapped in a parent list representing all configured radios.</p>
</section>
<section id="implementation-details">
<h4>Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p>The function initializes an empty list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">retrievedData</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</li>
<li><p>It performs a MongoDB <cite>find()</cite> query to fetch all documents from the <cite>configuredRadioCollection</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">allConfiguredData</span> <span class="o">=</span> <span class="n">configuredRadioCollection</span><span class="o">.</span><span class="n">find</span><span class="p">({},</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The empty query <cite>{}</cite> means “select all documents”.</p></li>
<li><p>The projection <cite>{“_id”: 0}</cite> removes the <cite>_id</cite> field from results.</p></li>
</ul>
</li>
<li><p>Each document is iterated and converted to a flat list of values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">allConfiguredData</span><span class="p">:</span>
    <span class="n">currentDataList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">currentDataList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>All flattened lists are collected into a final output list:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">retrievedData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentDataList</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="return-value">
<h4>Return Value<a class="headerlink" href="#return-value" title="Link to this heading"></a></h4>
<p>If successful, returns:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;NODE_A&quot;</span><span class="p">,</span> <span class="s2">&quot;0013A20040B2C3D4&quot;</span><span class="p">,</span> <span class="mi">4001</span><span class="p">,</span> <span class="mi">4020</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;NODE_B&quot;</span><span class="p">,</span> <span class="s2">&quot;0013A20040B2C3D5&quot;</span><span class="p">,</span> <span class="mi">4021</span><span class="p">,</span> <span class="mi">4040</span><span class="p">],</span>
    <span class="o">...</span>
<span class="p">]</span>
</pre></div>
</div>
<p>If an exception is thrown (e.g., database connection failure), returns a dictionary:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Detailed error message&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id46">
<h4>Error Handling<a class="headerlink" href="#id46" title="Link to this heading"></a></h4>
<p>All operations are enclosed in a <cite>try-except</cite> block. Any exception thrown (including MongoDB errors) is caught and returned as a structured error message.</p>
</section>
<section id="id47">
<h4>Side Effects<a class="headerlink" href="#id47" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><strong>Read-Only</strong>: This function does not modify the database.</p></li>
<li><p><strong>Stateless</strong>: It can be safely called multiple times without impacting system state.</p></li>
</ul>
</section>
<section id="id48">
<h4>Example Usage<a class="headerlink" href="#id48" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configuredRadios</span> <span class="o">=</span> <span class="n">retrieveAllConfiguredRadio</span><span class="p">()</span>

<span class="k">for</span> <span class="n">radio</span> <span class="ow">in</span> <span class="n">configuredRadios</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAC: </span><span class="si">{</span><span class="n">radio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">, Node: </span><span class="si">{</span><span class="n">radio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, Start: </span><span class="si">{</span><span class="n">radio</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">, End: </span><span class="si">{</span><span class="n">radio</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="populatedbhelper">
<h3>populateDbHelper<a class="headerlink" href="#populatedbhelper" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">populateDbHelper</span><span class="p">()</span>
</pre></div>
</div>
<p>Populates the system database with <strong>10,000 randomly generated dummy XBee radio entries</strong> for testing, debugging, or benchmarking purposes. This helper is meant for development and should <strong>not be used in production environments</strong> due to its data-spamming nature.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>None (Output is printed to console during execution)</p>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</div></blockquote>
<section id="id49">
<h4>Overview<a class="headerlink" href="#id49" title="Link to this heading"></a></h4>
<p>This function generates a large number of fake XBee radios, each with:
- A random 16-character MAC address,
- A random Modbus start address between 39000 and 39999,
- A predictable node identifier in the format <code class="docutils literal notranslate"><span class="pre">&quot;Radio</span> <span class="pre">&lt;i&gt;&quot;</span></code>,</p>
<p>It uses the existing <cite>configureXbeeRadio()</cite> function to register each dummy radio into the persistent <cite>configuredRadioCollection</cite>.</p>
<p>After each addition, it prints the current list of all configured radios using <cite>retrieveAllConfiguredRadio()</cite>.</p>
</section>
<section id="purpose">
<h4>Purpose<a class="headerlink" href="#purpose" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Stress-testing MongoDB-based radio configuration storage</p></li>
<li><p>Evaluating retrieval performance (<cite>retrieveAllConfiguredRadio</cite>)</p></li>
<li><p>Simulating system behavior under large-scale configurations</p></li>
<li><p>Validating UI elements like radio configuration tables or pagination</p></li>
</ul>
</section>
<section id="id50">
<h4>Implementation Details<a class="headerlink" href="#id50" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>Loop 10,000 Times</strong>:</p>
<p>The function generates 10,000 fake radios with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
</pre></div>
</div>
</li>
<li><p><strong>Random XBee MAC Generation</strong>:</p>
<p>Each MAC is 16 characters long and consists of uppercase letters and digits:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xbeeMac</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Note</strong>: This MAC format is synthetic and does not comply with real-world XBee IEEE 64-bit address formats (e.g., “0013A200…”).</p>
</li>
<li><p><strong>Random Modbus Start Address</strong>:</p>
<p>Start address is chosen from the range 39000–39999:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">39000</span><span class="p">,</span> <span class="mi">39999</span><span class="p">)</span>
</pre></div>
</div>
<p>This ensures:
- No conflict with typical operational address ranges (e.g., 4001–5000)
- Isolation from manually added real radios</p>
</li>
<li><p><strong>Node Identifier Naming</strong>:</p>
<p>The node identifier is a fixed label <cite>“Radio “</cite> concatenated with the iteration index:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nodeidentifier</span> <span class="o">=</span> <span class="s2">&quot;Radio &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>This ensures each identifier is unique: <cite>“Radio 0”</cite> to <cite>“Radio 9999”</cite>.</p>
</li>
<li><p><strong>Configure Radio</strong>:</p>
<p>This line attempts to insert the generated radio into the system database:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">configureXbeeRadio</span><span class="p">(</span><span class="n">xbeeMac</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">nodeidentifier</span><span class="p">)</span>
</pre></div>
</div>
<p>The <cite>configureXbeeRadio</cite> function performs input validation, duplicate checks, and MongoDB persistence.</p>
</li>
<li><p><strong>Display Configuration</strong>:</p>
<p>After each insert, the updated list of configured radios is printed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">retrieveAllConfiguredRadio</span><span class="p">())</span>
</pre></div>
</div>
<p>This can significantly slow down execution and flood the console due to the large volume of data.</p>
</li>
</ol>
</section>
<section id="id51">
<h4>Return Value<a class="headerlink" href="#id51" title="Link to this heading"></a></h4>
<p>This function has no return value.</p>
<p>All feedback is shown through console output (<cite>print()</cite>), which is helpful during manual testing but inefficient for automation.</p>
</section>
<section id="id52">
<h4>Side Effects<a class="headerlink" href="#id52" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Adds <strong>10,000 documents</strong> to the <cite>configuredRadioCollection</cite>.</p></li>
<li><p>Generates <strong>10,000 MongoDB collections</strong> in <cite>gatewayDb</cite>, assuming <cite>configureXbeeRadio</cite> follows your documented logic.</p></li>
<li><p><strong>Consumes Modbus address space</strong> in the range 39000–39999.</p></li>
<li><p>Can cause <strong>significant slowdown</strong> due to excessive console output and database writes.</p></li>
</ul>
</section>
<section id="example-output">
<h4>Example Output<a class="headerlink" href="#example-output" title="Link to this heading"></a></h4>
<p>A single output from one iteration might look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">[</span><span class="s1">&#39;Radio 0&#39;</span><span class="p">,</span> <span class="s1">&#39;AB12CD34EF56GH78&#39;</span><span class="p">,</span> <span class="mi">39021</span><span class="p">,</span> <span class="mi">39040</span><span class="p">],</span>
    <span class="o">...</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="main-block-entry">
<h3>__main__ Block Entry<a class="headerlink" href="#main-block-entry" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Acts as the <strong>script execution entry point</strong> in Python. Ensures that code within this block is <strong>only executed when the file is run directly</strong>, and not when it is imported as a module in another script.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>None (currently no runtime behavior)</p>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</div></blockquote>
<section id="id53">
<h4>Overview<a class="headerlink" href="#id53" title="Link to this heading"></a></h4>
<p>This conditional block is standard Python practice and serves as a safeguard to isolate code execution logic. It prevents automatic execution of logic when this script is imported elsewhere in your system (e.g., from another module or during testing).</p>
<p>In its current form, the block is empty (<cite>pass</cite>), which implies it’s a <strong>placeholder</strong> for future startup logic, such as launching a process, running tests, or triggering a simulation loop.</p>
</section>
<section id="id54">
<h4>Purpose<a class="headerlink" href="#id54" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Prevents unintentional side-effects when the module is imported.</p></li>
<li><p>Offers a safe place to define the program’s default startup behavior.</p></li>
<li><p>Commonly used for orchestrators like <cite>startProcess()</cite> or batch utilities like <cite>populateDbHelper()</cite>.</p></li>
</ul>
</section>
<section id="id55">
<h4>Implementation Details<a class="headerlink" href="#id55" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>Condition Evaluation</strong>:</p>
<p>The block checks whether the file is being run as the main program:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</pre></div>
</div>
</li>
<li><p><strong>Empty Execution Block</strong>:</p>
<p>Uses Python’s <cite>pass</cite> keyword to indicate intentional non-operation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">pass</span>
</pre></div>
</div>
<p>This means:
- The script won’t perform any action unless populated.
- It can safely be imported into test harnesses or integration tools.</p>
</li>
</ol>
</section>
<section id="id56">
<h4>Return Value<a class="headerlink" href="#id56" title="Link to this heading"></a></h4>
<p>None. This block contains no logic or returnable function.</p>
</section>
<section id="id57">
<h4>Side Effects<a class="headerlink" href="#id57" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Currently, there are no side effects.</p></li>
<li><p>In future, logic placed here can:
- Alter global variables
- Launch services or daemons
- Populate or modify the database
- Run standalone validation scripts</p></li>
</ul>
</section>
<section id="id58">
<h4>Example Usage<a class="headerlink" href="#id58" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This module was run directly&quot;</span><span class="p">)</span>
    <span class="n">startProcess</span><span class="p">()</span>
</pre></div>
</div>
<p>This would run the gateway process only when the script is launched explicitly, not when imported into another script or service.</p>
</section>
</section>
</section>
<section id="modbus">
<span id="id59"></span><h2>modbus<a class="headerlink" href="#modbus" title="Link to this heading"></a></h2>
<section id="id60">
<h3>Overview<a class="headerlink" href="#id60" title="Link to this heading"></a></h3>
<p>The <cite>modbus</cite> module provides essential utilities for managing Modbus communication within the gateway system. It includes functions for converting data between formats suitable for Modbus registers, managing Modbus server contexts, and retrieving the local machine’s network IP address. The module is integral for managing data exchange between Modbus slaves and handling networking concerns for Modbus servers.</p>
<section id="key-functionalities">
<h4>Key Functionalities<a class="headerlink" href="#key-functionalities" title="Link to this heading"></a></h4>
<ol class="arabic simple">
<li><p><strong>Float to Modbus Registers Conversion</strong>:
- Converts floating-point values to two 16-bit Modbus registers for use in Modbus communication.</p></li>
<li><p><strong>Modbus Server Context Management</strong>:
- Creates and manages a Modbus server context, including defining storage for multiple Modbus data types (Discrete Inputs, Coils, Holding Registers, and Input Registers).</p></li>
<li><p><strong>IP Address Retrieval</strong>:
- Retrieves the machine’s network IP address, either from Ethernet or Wi-Fi interfaces, to facilitate network-based communication.</p></li>
</ol>
</section>
<section id="id61">
<h4>Imports<a class="headerlink" href="#id61" title="Link to this heading"></a></h4>
<p>The following libraries are imported in the module:</p>
<ul class="simple">
<li><p><strong>psutil</strong>: For accessing system and network interface information.</p></li>
<li><p><strong>socket</strong>: For network-related operations, particularly to retrieve network interface IP addresses.</p></li>
<li><p><strong>struct</strong>: Used for packing and unpacking binary data, especially for converting floating-point values to Modbus register format.</p></li>
<li><p><strong>pymodbus.datastore</strong>: Provides the necessary classes for Modbus data storage and server context management.</p></li>
</ul>
</section>
<section id="id62">
<h4>Purpose<a class="headerlink" href="#id62" title="Link to this heading"></a></h4>
<p>This module supports Modbus communication by providing tools to:
- Convert real-world data (e.g., sensor readings) into Modbus-compatible formats.
- Set up a Modbus server context for managing Modbus data for multiple devices.
- Determine the local machine’s IP address for network configuration.</p>
</section>
</section>
<section id="floattoregisters">
<h3>floatToRegisters<a class="headerlink" href="#floattoregisters" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">floatToRegisters</span><span class="p">(</span><span class="n">floatValue</span><span class="p">)</span>
</pre></div>
</div>
<p>Converts a <strong>32-bit floating-point number</strong> (Python <cite>float</cite>) into <strong>two 16-bit Modbus register values</strong> for compatibility with the Modbus protocol.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">param float floatValue<span class="colon">:</span></dt>
<dd class="field-odd"><p>A single precision floating-point number to convert.</p>
</dd>
<dt class="field-even">returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A list containing two 16-bit unsigned integers representing the input float in Modbus register format.</p>
</dd>
<dt class="field-odd">rtype<span class="colon">:</span></dt>
<dd class="field-odd"><p>list[int]</p>
</dd>
</dl>
</div></blockquote>
<section id="id63">
<h4>Overview<a class="headerlink" href="#id63" title="Link to this heading"></a></h4>
<p>The Modbus protocol operates on 16-bit registers, but modern sensor data (e.g., temperature, pressure, flow rate) is often represented as 32-bit IEEE 754 floating-point values. To store such values within a Modbus context, the float must be split into two 16-bit registers.</p>
<p>This helper function provides that conversion using Python’s built-in <cite>struct</cite> module.</p>
</section>
<section id="id64">
<h4>Implementation Details<a class="headerlink" href="#id64" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>Pack the Float to Binary</strong>:</p>
<p>The input float is packed into a 4-byte binary format using little-endian (<cite>&lt;f</cite>) encoding:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">binaryData</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;f&#39;</span><span class="p">,</span> <span class="n">floatValue</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><cite>&lt;</cite>: Little-endian byte order (least significant byte first).</p></li>
<li><p><cite>f</cite>: 32-bit float.</p></li>
</ul>
</li>
<li><p><strong>Unpack as Two Unsigned Shorts</strong>:</p>
<p>The binary data is unpacked into <strong>two 16-bit unsigned integers</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;HH&#39;</span><span class="p">,</span> <span class="n">binaryData</span><span class="p">))</span>
</pre></div>
</div>
<p>This yields a list like <cite>[low_word, high_word]</cite> representing the float in Modbus register format.</p>
</li>
</ol>
</section>
<section id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h4>
<p>This function is used throughout the gateway system to convert real-valued sensor readings for Modbus compatibility. It is especially critical in <cite>modbusPolling</cite>, where incoming data from XBee radios is prepared for storage in Modbus registers.</p>
</section>
<section id="reference">
<h4>Reference<a class="headerlink" href="#reference" title="Link to this heading"></a></h4>
<p>This function is used in the main gateway polling loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">registerValues</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sensorValues</span><span class="p">:</span>
    <span class="n">registerValues</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">floatToRegisters</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

<span class="n">registers</span> <span class="o">=</span> <span class="n">registerValues</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
<span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
<span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
</pre></div>
</div>
<p>The above logic shows that each sensor value is first passed to <cite>floatToRegisters</cite>, then the resulting register pairs are written to <strong>Holding (FC3)</strong> and <strong>Input (FC4)</strong> Modbus registers.</p>
</section>
</section>
<section id="contextmanager">
<h3>contextManager<a class="headerlink" href="#contextmanager" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">contextManager</span><span class="p">()</span>
</pre></div>
</div>
<p>Initializes and returns a <strong>Modbus data context</strong> that defines memory areas for <strong>Discrete Inputs</strong>, <strong>Coils</strong>, <strong>Holding Registers</strong>, and <strong>Input Registers</strong> using the <cite>pymodbus</cite> library.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>The initialized <cite>ModbusSlaveContext</cite> for slave ID 0.</p>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>pymodbus.datastore.ModbusSlaveContext</p>
</dd>
</dl>
</div></blockquote>
<section id="id65">
<h4>Overview<a class="headerlink" href="#id65" title="Link to this heading"></a></h4>
<p>This function sets up the in-memory data model for a Modbus TCP server using <cite>pymodbus</cite>. It pre-allocates <strong>1000 registers or bits</strong> for each of the four primary Modbus data blocks:
- Discrete Inputs (read-only binary values)
- Coils (read/write binary values)
- Holding Registers (read/write 16-bit registers)
- Input Registers (read-only 16-bit registers)</p>
<p>The resulting context is structured in a way compatible with multi-slave Modbus networks, even though only slave ID <cite>0</cite> is actively used.</p>
</section>
<section id="id66">
<h4>Implementation Details<a class="headerlink" href="#id66" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>Create the ModbusSlaveContext</strong>:</p>
<p>Initializes memory areas for all four standard Modbus types, each with 1000 default entries (set to zero):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="o">=</span> <span class="n">ModbusSlaveContext</span><span class="p">(</span>
    <span class="n">di</span><span class="o">=</span><span class="n">ModbusSequentialDataBlock</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">co</span><span class="o">=</span><span class="n">ModbusSequentialDataBlock</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">hr</span><span class="o">=</span><span class="n">ModbusSequentialDataBlock</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">ir</span><span class="o">=</span><span class="n">ModbusSequentialDataBlock</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Create a ModbusServerContext</strong>:</p>
<p>Wraps the slave context into a server context to support multiple slaves (although only one is used here):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">contextAsNextedDic</span> <span class="o">=</span> <span class="n">ModbusServerContext</span><span class="p">(</span><span class="n">slaves</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">store</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">store</span><span class="p">},</span> <span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The <cite>single=True</cite> flag makes all operations target slave ID <cite>0</cite> unless explicitly overridden.</p>
<p>Though despite the flag, the slave ID is still very relevant and requesting for data using wrong slave ID, won’t return anything</p>
</li>
<li><p><strong>Extract the Slave Context</strong>:</p>
<p>The server context is accessed like a dictionary. Slave ID <cite>0</cite> is used by default:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">contextAsNextedDic</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>This context is what will be used to read/write Modbus data in functions like <cite>modbusPolling</cite>.</p>
</li>
</ol>
</section>
<section id="id67">
<h4>Usage<a class="headerlink" href="#id67" title="Link to this heading"></a></h4>
<p>The context returned by this function is passed to the Modbus TCP server and used throughout the gateway system. It allows real-time updates of Modbus registers using data received from XBee radios.</p>
<p>For example, in <cite>modbusPolling</cite>, register values are written like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
<span class="n">contextValue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setValues</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">startAddress</span><span class="p">,</span> <span class="n">registers</span><span class="p">)</span>
</pre></div>
</div>
<p>This means:
- Function code 3 (Holding Registers)
- Function code 4 (Input Registers)</p>
</section>
</section>
<section id="getipaddress">
<h3>getIpAddress<a class="headerlink" href="#getipaddress" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">getIpAddress</span><span class="p">()</span>
</pre></div>
</div>
<p>Determines and returns the current machine’s <strong>local IPv4 address</strong>, preferring Ethernet interfaces over Wi-Fi, and falling back to a default if no valid network connection is detected.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>The selected IP address as a string.</p>
</dd>
<dt class="field-even">rtype<span class="colon">:</span></dt>
<dd class="field-even"><p>str</p>
</dd>
</dl>
</div></blockquote>
<section id="id68">
<h4>Overview<a class="headerlink" href="#id68" title="Link to this heading"></a></h4>
<p>This utility function inspects all active network interfaces on the machine using the <cite>psutil</cite> library and selects a valid IPv4 address. It does so with the following priorities:</p>
<ol class="arabic simple">
<li><p><strong>Ethernet IP address</strong> (if available and valid).</p></li>
<li><p><strong>Wi-Fi IP address</strong> (if Ethernet is unavailable).</p></li>
<li><p><strong>Default value</strong> <cite>“0.0.0.0”</cite> if no valid IP is found.</p></li>
</ol>
<p>It performs platform-independent pattern matching on interface names (supporting both English and Chinese characters) to differentiate between Ethernet and Wi-Fi adapters.</p>
</section>
<section id="id69">
<h4>Implementation Details<a class="headerlink" href="#id69" title="Link to this heading"></a></h4>
<ol class="arabic">
<li><p><strong>Get all network interfaces</strong>:</p>
<p>Uses <cite>psutil.net_if_addrs()</cite> to enumerate all available network interfaces and their assigned addresses:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">interfaces</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">net_if_addrs</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Define interface name patterns</strong>:</p>
<p>Maintains two lists of keywords to identify Ethernet and Wi-Fi adapters. These include common naming schemes across Windows, Linux, and macOS — even including <strong>localized Chinese names</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ethernetPatterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eth&#39;</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="s1">&#39;ethernet&#39;</span><span class="p">,</span> <span class="s1">&#39;local area connection&#39;</span><span class="p">,</span> <span class="s1">&#39;有线&#39;</span><span class="p">]</span>
<span class="n">wifiPatterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wifi&#39;</span><span class="p">,</span> <span class="s1">&#39;wi-fi&#39;</span><span class="p">,</span> <span class="s1">&#39;wireless&#39;</span><span class="p">,</span> <span class="s1">&#39;wl&#39;</span><span class="p">,</span> <span class="s1">&#39;wlan&#39;</span><span class="p">,</span> <span class="s1">&#39;无线&#39;</span><span class="p">,</span> <span class="s1">&#39;wi_fi&#39;</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p><strong>Iterate through interfaces</strong>:</p>
<p>Loops through all interfaces and their address entries, filtering only for <strong>IPv4 addresses</strong> (<cite>AF_INET</cite>) that are not <strong>loopback</strong> (<cite>127.*</cite>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">address</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">address</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;127.&quot;</span><span class="p">):</span>
</pre></div>
</div>
</li>
<li><p><strong>Classify and select IP addresses</strong>:</p>
<ul class="simple">
<li><p>For <strong>Ethernet</strong> interfaces:</p>
<ul>
<li><p>Match name using <cite>ethernetPatterns</cite></p></li>
<li><p>Skip <strong>APIPA addresses</strong> (i.e. <cite>169.254.*.*</cite> range, which indicate failed DHCP assignment)</p></li>
<li><p>Assign the first matching, valid IP to <cite>ethernetIp</cite></p></li>
</ul>
</li>
<li><p>For <strong>Wi-Fi</strong> interfaces:</p>
<ul>
<li><p>Match name using <cite>wifiPatterns</cite></p></li>
<li><p>Assign first valid IP to <cite>wifiIp</cite></p></li>
</ul>
</li>
</ul>
<p>This ensures that <strong>Ethernet is prioritized</strong>, but Wi-Fi is used as a fallback.</p>
</li>
<li><p><strong>Return logic</strong>:</p>
<ul class="simple">
<li><p>If a valid Ethernet IP was found: return it and print the selection.</p></li>
<li><p>Else if a valid Wi-Fi IP was found: return it and print a fallback message.</p></li>
<li><p>Else: return a default <cite>“0.0.0.0”</cite> and print a warning.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ethernetIp</span><span class="p">:</span>
   <span class="k">return</span> <span class="n">ethernetIp</span>
<span class="k">elif</span> <span class="n">wifiIp</span><span class="p">:</span>
   <span class="k">return</span> <span class="n">wifiIp</span>
<span class="k">else</span><span class="p">:</span>
   <span class="k">return</span> <span class="n">default</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="console-output">
<h4>Console Output<a class="headerlink" href="#console-output" title="Link to this heading"></a></h4>
<p>Depending on the selected result, the function prints a contextual message to the console:</p>
<ul class="simple">
<li><p><cite>“Ethernet IP Address: &lt;ip&gt;”</cite></p></li>
<li><p><cite>“No Ethernet interface detected. Falling back to Wi-Fi.”</cite></p></li>
<li><p><cite>“Wi-Fi IP Address: &lt;ip&gt;”</cite></p></li>
<li><p><cite>“No Ethernet or Wi-Fi network detected on this machine.”</cite></p></li>
<li><p><cite>“Using default address 0.0.0.0”</cite></p></li>
</ul>
<p>These messages aid debugging during startup or troubleshooting in environments where networking may be unreliable.</p>
</section>
<section id="usage-scenario">
<h4>Usage Scenario<a class="headerlink" href="#usage-scenario" title="Link to this heading"></a></h4>
<p>This function is commonly used at system or server initialization time to:</p>
<ul class="simple">
<li><p>Report which interface will be used for <strong>network binding</strong> (e.g., Modbus TCP).</p></li>
<li><p>Show diagnostics or status in a GUI or terminal.</p></li>
<li><p>Avoid binding services to the wrong interface.</p></li>
</ul>
</section>
</section>
</section>
<section id="serialselector">
<span id="id70"></span><h2>serialSelector<a class="headerlink" href="#serialselector" title="Link to this heading"></a></h2>
<section id="id71">
<h3>Overview<a class="headerlink" href="#id71" title="Link to this heading"></a></h3>
<p>The <cite>serialSelector</cite> module provides utility logic for detecting and selecting the appropriate USB serial port to which the XBee radio is connected. It simplifies setup by automating the process of identifying the correct USB interface based on its hardware serial number (HWID).</p>
<p>This module can also be run as a standalone CLI utility using a <cite>–get</cite> flag to print all connected serial devices and help users configure their system correctly by copying the HWID into the <cite>variables.py</cite> file.</p>
<section id="id72">
<h4>Key Functionalities<a class="headerlink" href="#id72" title="Link to this heading"></a></h4>
<ol class="arabic simple">
<li><p><strong>Auto-select USB Serial Port</strong>:
- Detects all connected USB or COM serial devices.
- Matches the correct port using a preconfigured serial number from the <cite>variables</cite> module.</p></li>
<li><p><strong>User Prompt Utility (CLI Mode)</strong>:
- When run as a standalone script with the <cite>–get</cite> flag, it lists all connected serial devices with their <cite>port</cite> and <cite>hwid</cite>.
- Assists users in identifying and copying the correct hardware serial number for XBee connection setup.</p></li>
<li><p><strong>Error Handling</strong>:
- Gracefully handles user interruption (e.g., <cite>Ctrl+C</cite>), serial access issues, and other exceptions.</p></li>
</ol>
</section>
<section id="id73">
<h4>Imports<a class="headerlink" href="#id73" title="Link to this heading"></a></h4>
<p>The module makes use of the following Python libraries and packages:</p>
<ul class="simple">
<li><p><strong>serial</strong>: From <cite>pyserial</cite>, for enumerating and interacting with serial ports.</p></li>
<li><p><strong>serial.tools.list_ports</strong>: For retrieving a list of all serial ports on the system.</p></li>
<li><p><strong>argparse</strong>: For parsing command-line arguments in standalone mode.</p></li>
<li><p><strong>sys</strong>: To exit gracefully after displaying results.</p></li>
<li><p><strong>asyncio</strong>: Imported for potential future use, although unused in this module directly.</p></li>
<li><p><strong>digi.xbee.devices.XBeeDevice</strong>: Imported to support XBee device interaction (future integration).</p></li>
<li><p><strong>functools.partial</strong>: Imported but unused in the current module implementation.</p></li>
<li><p><strong>variables</strong> (local import): Contains user-defined configuration, specifically the <cite>prefferedRadioSerialNumber</cite>.</p></li>
</ul>
</section>
<section id="id74">
<h4>Usage<a class="headerlink" href="#id74" title="Link to this heading"></a></h4>
<p>The module is typically used in two ways:</p>
<ol class="arabic">
<li><p><strong>Programmatic Access</strong> (from other modules):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">modules.serialSelector</span><span class="w"> </span><span class="kn">import</span> <span class="n">selectUsbPort</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">selectUsbPort</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Command-Line Utility</strong> (standalone):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>modules.serialSelector<span class="w"> </span>--get
</pre></div>
</div>
<p>This prints a list of all detected USB/COM ports with their HWIDs, helping the user determine which value to set in <cite>variables.prefferedRadioSerialNumber</cite>.</p>
</li>
</ol>
</section>
<section id="id75">
<h4>Dependencies<a class="headerlink" href="#id75" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>This module depends on <cite>pyserial</cite> and <cite>digi-xbee</cite>.</p></li>
<li><p>It also requires a correctly defined <cite>prefferedRadioSerialNumber</cite> in the <cite>variables.py</cite> module to perform auto-selection.</p></li>
<li><p>The XBee device itself is not opened or initialized here, but the port returned can be passed to <cite>XBeeDevice</cite> elsewhere in the application.</p></li>
</ul>
</section>
</section>
<section id="selectusbport">
<h3>selectUsbPort<a class="headerlink" href="#selectusbport" title="Link to this heading"></a></h3>
<section id="definition">
<h4>Definition<a class="headerlink" href="#definition" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">selectUsbPort</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</pre></div>
</div>
</section>
<section id="description">
<h4>Description<a class="headerlink" href="#description" title="Link to this heading"></a></h4>
<p>Detects and returns the USB serial port corresponding to the preferred XBee radio device.
It does this by scanning all available serial ports and matching them against a known hardware serial substring defined in the <cite>variables.prefferedRadioSerialNumber</cite>.</p>
<p>If the <cite>get</cite> argument is set to <cite>True</cite>, the function prints all available USB/COM ports along with their hardware IDs, helping the user identify the correct device to configure in the <cite>variables</cite> module. In this mode, the program exits after displaying information.</p>
</section>
<section id="parameters">
<h4>Parameters<a class="headerlink" href="#parameters" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">g</span></code> (<cite>bool</cite>): Optional flag (default <cite>False</cite>).
If <cite>True</cite>, displays connected serial devices and exits.</p></li>
</ul>
</section>
<section id="returns">
<h4>Returns<a class="headerlink" href="#returns" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>(<cite>str</cite> or <cite>None</cite>) The matched USB port device name (e.g., <cite>‘COM3’</cite>, <cite>‘/dev/ttyUSB0’</cite>) if found.
Returns <cite>None</cite> if no matching port is found or if an error occurs.</p></li>
</ul>
</section>
<section id="behavior">
<h4>Behavior<a class="headerlink" href="#behavior" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Uses <cite>serial.tools.list_ports.comports()</cite> to fetch a list of connected serial devices.</p></li>
<li><p>Filters ports that include <cite>“USB”</cite> or <cite>“COM”</cite> in their names.</p></li>
<li><p>If <cite>get</cite> is <cite>True</cite>, prints out all discovered serial devices and exits the program.</p></li>
<li><p>Otherwise, searches for the port whose hardware ID contains the configured serial substring from <cite>variables.prefferedRadioSerialNumber</cite>.</p></li>
<li><p>If found, returns the matching port name.</p></li>
<li><p>If not found, prints guidance to the user to run the script with <cite>–g</cite> and update the <cite>variables.py</cite> file accordingly.</p></li>
</ul>
</section>
<section id="exceptions-handled">
<h4>Exceptions Handled<a class="headerlink" href="#exceptions-handled" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><cite>KeyboardInterrupt</cite>: Gracefully exits if the user aborts the operation.</p></li>
<li><p><cite>serial.SerialException</cite>: Handles issues with accessing serial ports.</p></li>
<li><p><cite>Exception</cite>: Catches any other unexpected error and logs it.</p></li>
</ul>
</section>
<section id="id76">
<h4>Example Usage<a class="headerlink" href="#id76" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Called during startup to automatically bind to the correct port</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">selectUsbPort</span><span class="p">()</span>
<span class="k">if</span> <span class="n">port</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using port: </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid USB port found. Check your connections and configuration.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="cli-mode">
<h4>CLI Mode<a class="headerlink" href="#cli-mode" title="Link to this heading"></a></h4>
<p>This function can also be triggered directly via command line:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>modules.serialSelector<span class="w"> </span>--g
</pre></div>
</div>
<p>This prints all connected serial devices with hardware info, and helps configure the correct serial number in <cite>variables.py</cite>.</p>
</section>
</section>
<section id="handleusbdisconnection">
<h3>handleUsbDisconnection<a class="headerlink" href="#handleusbdisconnection" title="Link to this heading"></a></h3>
<section id="id77">
<h4>Definition<a class="headerlink" href="#id77" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">handleUsbDisconnection</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">xbeeQueue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xbeeObject</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</pre></div>
</div>
</section>
<section id="id78">
<h4>Description<a class="headerlink" href="#id78" title="Link to this heading"></a></h4>
<p>Handles unexpected USB disconnection events related to the XBee device, and attempts automatic recovery by detecting reconnected ports and reinitializing the XBee radio.</p>
<p>This function is triggered via an error callback registered on the XBee device using <code class="docutils literal notranslate"><span class="pre">add_error_callback()</span></code>. When a disconnection occurs, it flags the radio as offline, closes the old connection, continuously polls for an available USB port, and re-initializes the XBee device when found.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This implementation currently functions as intended, but its structure is considered spaghetti code (see <cite>Spaghetti Code Warning</cite> section).</p>
</div>
</section>
<section id="id79">
<h4>Parameters<a class="headerlink" href="#id79" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">err</span></code> (<em>Exception</em>): Error raised by the Digi XBee library when USB disconnection occurs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeQueue</span></code> (<em>asyncio.Queue</em>, optional): Queue to which parsed data will be pushed once reconnected.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xbeeObject</span></code> (<em>XBeeDevice</em>, optional): The currently active XBee device instance to close and replace.</p></li>
</ul>
</section>
<section id="id80">
<h4>Returns<a class="headerlink" href="#id80" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>None</p></li>
</ul>
</section>
<section id="id81">
<h4>Behavior<a class="headerlink" href="#id81" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Sets <code class="docutils literal notranslate"><span class="pre">variables.radioFlag</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p>Closes the existing <code class="docutils literal notranslate"><span class="pre">xbeeObject</span></code> connection.</p></li>
<li><p>Enters a loop to poll USB ports using <code class="docutils literal notranslate"><span class="pre">selectUsbPort()</span></code> until a match is found.</p></li>
<li><p>Once a valid port is found:</p>
<ul>
<li><p>Initializes a new <code class="docutils literal notranslate"><span class="pre">XBeeDevice</span></code> on the detected port.</p></li>
<li><p>Opens the device and re-registers both data and error callbacks.</p></li>
<li><p>Sets <code class="docutils literal notranslate"><span class="pre">variables.radioFlag</span></code> back to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="id82">
<h4>Exceptions Handled<a class="headerlink" href="#id82" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>None directly, but the function is invoked in response to runtime exceptions from the XBee library.</p></li>
</ul>
</section>
<section id="id83">
<h4>Example Usage<a class="headerlink" href="#id83" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="n">xbeeDevice</span><span class="o">.</span><span class="n">add_error_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">handleUsbDisconnection</span><span class="p">,</span> <span class="n">xbeeQueue</span><span class="o">=</span><span class="n">myQueue</span><span class="p">,</span> <span class="n">xbeeObject</span><span class="o">=</span><span class="n">xbeeDevice</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="spaghetti-code-warning">
<h4>Spaghetti Code Warning<a class="headerlink" href="#spaghetti-code-warning" title="Link to this heading"></a></h4>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While effective in practice, this function’s structure is currently unmaintainable and should be refactored:</p>
<ul class="simple">
<li><p>It nests callbacks (<cite>dataReceiveCallback</cite>) inside the function body.</p></li>
<li><p>It blocks with <code class="docutils literal notranslate"><span class="pre">while</span> <span class="pre">not</span> <span class="pre">usbDetected</span></code>, which can stall the main thread.</p></li>
<li><p>It mixes recovery, I/O, and callback logic into one procedural block.</p></li>
<li><p>It depends on shared global state via <code class="docutils literal notranslate"><span class="pre">variables.*</span></code>.</p></li>
</ul>
<p>A cleaner implementation should extract:</p>
<ul class="simple">
<li><p>Port selection</p></li>
<li><p>Device setup</p></li>
<li><p>Callback registration</p></li>
<li><p>Recovery logic</p></li>
</ul>
<p>into modular, reusable functions that can be tested and maintained independently.</p>
<blockquote>
<div><p>The current implementation achieves its purpose but suffers from structural and architectural issues, classifying it as <em>spaghetti code</em>. Key concerns include:</p>
</div></blockquote>
<ul class="simple">
<li><p><strong>Nested Callback Definitions</strong>: The <cite>dataReceiveCallback</cite> is defined inside <cite>xbeePolling()</cite>, limiting reusability and making testing difficult.</p></li>
<li><p><strong>Global State Side Effects</strong>: Critical variables such as <cite>variables.xbeeInstance</cite>, <cite>variables.radioFlag</cite>, and <cite>variables.knownXbeeAddress</cite> are accessed and mutated across multiple scopes and functions.</p></li>
<li><p><strong>Duplicated Initialization Logic</strong>: The USB disconnection recovery routine duplicates the radio setup logic rather than calling the <cite>xbeePolling()</cite> function or a shared initializer.</p></li>
<li><p><strong>Async + Blocking Confusion</strong>: The loop in <cite>xbeePolling()</cite> awaits sleep without doing actual work. This keeps the coroutine alive but doesn’t leverage asyncio for I/O tasks.</p></li>
<li><p><strong>Error Recovery Lacks Structure</strong>: Error handling is done via a partially applied <cite>handleUsbDisconnection</cite> function, which adds more callbacks and I/O operations in-line.</p></li>
</ul>
<p>Refactoring Suggestions:</p>
<ul class="simple">
<li><p>Move <cite>dataReceiveCallback</cite> to a top-level function.</p></li>
<li><p>Isolate shared setup logic into a reusable <cite>initializeXbeeDevice()</cite> function.</p></li>
<li><p>Store device state in a class or context manager rather than global <cite>variables</cite>.</p></li>
<li><p>Replace bare <cite>await asyncio.sleep()</cite> loop with actual task queue polling or health checks.</p></li>
<li><p>Use dependency injection or a state machine to separate device control flow from data handling.</p></li>
</ul>
<p>Doing so would significantly improve testability, error handling, and maintainability.</p>
</div>
</section>
</section>
<section id="main-execution-block">
<h3>__main__ Execution Block<a class="headerlink" href="#main-execution-block" title="Link to this heading"></a></h3>
<section id="id84">
<h4>Definition<a class="headerlink" href="#id84" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;USB Port Selector Script&quot;</span><span class="p">)</span>

    <span class="c1"># Define flags</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-g&quot;</span><span class="p">,</span> <span class="s2">&quot;--get&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Retrieve and display the USB port with the preferred serial number.&quot;</span><span class="p">)</span>

    <span class="c1"># Parse the arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">selectUsbPort</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id85">
<h4>Description<a class="headerlink" href="#id85" title="Link to this heading"></a></h4>
<p>This block enables the <cite>serialSelector</cite> module to be run directly as a standalone script.
It provides a command-line interface (CLI) for interacting with the USB port selection logic, especially useful for discovering connected XBee radios and retrieving their serial number information.</p>
</section>
<section id="id86">
<h4>Behavior<a class="headerlink" href="#id86" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Uses Python’s built-in <cite>argparse</cite> module to define a CLI interface.</p></li>
<li><p>Adds a <cite>–get</cite> (or <cite>-g</cite>) flag to allow users to retrieve and display all connected USB/COM serial devices.</p></li>
<li><p>After parsing command-line arguments, calls the <cite>selectUsbPort(get=args.get)</cite> function:</p>
<ul>
<li><p>If <cite>–get</cite> is supplied, it prints detailed serial port info and exits.</p></li>
<li><p>If not, it proceeds with normal serial port selection.</p></li>
</ul>
</li>
</ul>
</section>
<section id="command-line-usage">
<h4>Command-Line Usage<a class="headerlink" href="#command-line-usage" title="Link to this heading"></a></h4>
<p>To retrieve connected USB serial devices and their hardware IDs:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>modules.serialSelector<span class="w"> </span>--get
</pre></div>
</div>
<p>This is especially helpful during initial setup to determine the correct value for <cite>variables.prefferedRadioSerialNumber</cite>.</p>
</section>
<section id="typical-use-case">
<h4>Typical Use Case<a class="headerlink" href="#typical-use-case" title="Link to this heading"></a></h4>
<p>This block is mainly for developer or deployment-time use when verifying or configuring the USB connection between the XBee radio and the system.</p>
</section>
<section id="note">
<h4>Note<a class="headerlink" href="#note" title="Link to this heading"></a></h4>
<p>In actual runtime, port selection is typically done automatically by calling <cite>selectUsbPort()</cite> from another module, using the configured serial number in <cite>variables.py</cite>.</p>
</section>
</section>
</section>
<section id="variables">
<span id="id87"></span><h2>variables<a class="headerlink" href="#variables" title="Link to this heading"></a></h2>
<section id="id88">
<h3>Overview<a class="headerlink" href="#id88" title="Link to this heading"></a></h3>
<p>The <cite>variable</cite> module serves as a centralized configuration and global state management file for the XBee Modbus gateway system.
It defines constants and mutable runtime variables used across multiple modules including Modbus configuration, XBee communication, and application logic.</p>
<p>This module separates configuration from logic, enabling better modularity and maintainability of the system.</p>
</section>
<section id="global-configuration-constants">
<h3>Global Configuration Constants<a class="headerlink" href="#global-configuration-constants" title="Link to this heading"></a></h3>
<ul>
<li><p><strong>prefferedRadioSerialNumber</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>prefferedRadioSerialNumber = “SER=A10NX8UT”</p>
</div></blockquote>
<p>The USB serial number (typically from <cite>hwid</cite>) of the preferred XBee radio.
Used by the <cite>serialSelector</cite> module to automatically identify the correct serial port.</p>
</li>
<li><p><strong>xbeeBaudRate</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>xbeeBaudRate = 9600</p>
</div></blockquote>
<p>The baud rate used for serial communication with the XBee device.</p>
</li>
<li><p><strong>modbusPort</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>modbusPort = 5020</p>
</div></blockquote>
<p>The TCP port on which the Modbus server listens.
Common default is 502; this system uses 5020 to avoid conflicts and for better sandboxing.</p>
</li>
<li><p><strong>validMacAddressLength</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>validMacAddressLength = 16</p>
</div></blockquote>
<p>Expected length of an XBee MAC address string (in hexadecimal digits).</p>
</li>
<li><p><strong>validModbusAddressLength</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>validModbusAddressLength = 3</p>
</div></blockquote>
<p>Expected length of a valid Modbus address string (assumed to be three-digit numeric).</p>
</li>
<li><p><strong>incrementalModbusAddress</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>incrementalModbusAddress = 50</p>
</div></blockquote>
<p>The number of Modbus register addresses allocated per XBee device.
Ensures each device has a dedicated, non-overlapping register block.</p>
</li>
<li><p><strong>lowestRegister</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>lowestRegister = 0</p>
</div></blockquote>
<p>The base (minimum) address in the Modbus register space.</p>
</li>
<li><p><strong>highestRegister</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>highestRegister = 1000 - incrementalModbusAddress</p>
</div></blockquote>
<p>The upper bound of usable Modbus registers (accounting for per-device allocation).
Set to avoid overflows when allocating <cite>incrementalModbusAddress</cite>-sized blocks.</p>
</li>
</ul>
</section>
<section id="global-runtime-variables">
<h3>Global Runtime Variables<a class="headerlink" href="#global-runtime-variables" title="Link to this heading"></a></h3>
<ul>
<li><p><strong>knownXbeeAddress</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>knownXbeeAddress = []</p>
</div></blockquote>
<p>A dynamically updated list of XBee MAC addresses that have been discovered or configured.
Used to track device presence and avoid duplicate configuration.</p>
</li>
<li><p><strong>xbeeInstance</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>xbeeInstance = None</p>
</div></blockquote>
<p>Holds a reference to the currently connected <cite>XBeeDevice</cite> object.
Assigned during XBee initialization and used across modules to send/receive data.</p>
</li>
<li><p><strong>xbeePollingTask</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>xbeePollingTask = None</p>
</div></blockquote>
<p>Holds a reference to the asyncio Task responsible for polling XBee radios.
Allows centralized task management (starting, stopping, or checking status).</p>
</li>
<li><p><strong>data_callback</strong>:
.. code-block:: python</p>
<blockquote>
<div><p>data_callback = None</p>
</div></blockquote>
<p>Placeholder for the asynchronous callback function used to process incoming XBee data packets.
This is dynamically assigned to link XBee reception with user-defined logic.</p>
</li>
</ul>
</section>
<section id="id89">
<h3>Usage Context<a class="headerlink" href="#id89" title="Link to this heading"></a></h3>
<p>This module is imported into most other modules (such as <cite>serialSelector</cite>, <cite>xbeeComm</cite>, <cite>modbus</cite>, and <cite>dbintegration</cite>) to:</p>
<ul class="simple">
<li><p>Maintain consistency in port, baud rate, and address allocation logic.</p></li>
<li><p>Access or update shared state variables like <cite>xbeeInstance</cite> and <cite>knownXbeeAddress</cite>.</p></li>
<li><p>Prevent magic numbers or hard-coded strings scattered throughout the codebase.</p></li>
</ul>
</section>
</section>
<section id="xbeedata">
<span id="id90"></span><h2>xbeeData<a class="headerlink" href="#xbeedata" title="Link to this heading"></a></h2>
<section id="id91">
<h3>Overview<a class="headerlink" href="#id91" title="Link to this heading"></a></h3>
<p>The <cite>xbeeData</cite> module is responsible for decoding and parsing sensor payloads received from XBee radio devices, transforming raw byte data into human-readable values, and logging this information for historical storage and debugging purposes.</p>
<p>It serves as the bridge between raw radio transmission and structured application logic by applying decoding logic (using the Cayenne LPP format), extracting sensor values, and optionally interfacing with the database layer to store historical readings. This module helps centralize and abstract payload handling so other modules (such as the Modbus poller or analytics systems) can operate on clean, float-based sensor readings.</p>
<section id="key-responsibilities">
<h4>Key Responsibilities<a class="headerlink" href="#key-responsibilities" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>Decode XBee-transmitted sensor payloads from binary to float values using the <strong>Cayenne Low Power Payload (LPP)</strong> decoding format via the third-party <cite>python_cayennelpp</cite> package.</p></li>
<li><p>Maintain consistent extraction of <cite>value</cite> fields from each decoded item.</p></li>
<li><p>Persist decoded values to a MongoDB historian using the <cite>storeXbeeHistoryData()</cite> function from the <cite>dbIntegration</cite> module.</p></li>
<li><p>Output extracted values for human-readable debugging and operational transparency.</p></li>
<li><p>(Commented out) Provide an optional utility for retrieving XBee node identifiers (NI) through remote AT commands. This can be useful for device mapping, metadata tracking, or debugging physical deployments.</p></li>
</ul>
</section>
<section id="id92">
<h4>Usage Context<a class="headerlink" href="#id92" title="Link to this heading"></a></h4>
<p>This module is invoked by polling functions such as <cite>modbusPolling()</cite> in the <cite>modbus</cite> module. The <cite>cayenneParse()</cite> coroutine is used to interpret the sensor payload returned by XBee radios and convert it into a format suitable for storage and Modbus register mapping.</p>
<p>The output of this module is a clean list of floating-point sensor values derived from XBee data frames.</p>
</section>
<section id="id93">
<h4>Dependencies<a class="headerlink" href="#id93" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><cite>digi.xbee.devices</cite>: For handling XBee addresses and device communication (used in the commented utility).</p></li>
<li><p><cite>python_cayennelpp.decoder</cite>: For decoding the payloads from Cayenne LPP format into structured sensor data.</p></li>
<li><p><cite>datetime</cite>: For timestamping sensor readings during storage.</p></li>
<li><p><cite>dbIntegration</cite>: Specifically for the <cite>storeXbeeHistoryData()</cite> function that handles database insertion of sensor logs.</p></li>
</ul>
<p>This module provides a focused and reusable interface to interpret incoming payloads from edge XBee devices and is a core part of the Modbus-XBee gateway data pipeline.</p>
</section>
</section>
<section id="getnodeid">
<h3>getNodeId<a class="headerlink" href="#getnodeid" title="Link to this heading"></a></h3>
<section id="id94">
<h4>Definition<a class="headerlink" href="#id94" title="Link to this heading"></a></h4>
<dl class="py function">
<dt class="sig sig-object py" id="getNodeId">
<span class="sig-name descname"><span class="pre">getNodeId</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">macAddress</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">initializedXbee</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#getNodeId" title="Link to this definition"></a></dt>
<dd><p>Attempts to retrieve the Node Identifier (NI string) of a remote XBee device using a remote AT command. This utility function is designed for debugging, diagnostics, or node identification purposes during network setup and maintenance but is currently <strong>not used</strong> in the active codebase.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>macAddress</strong> (<em>str</em>) – The 64-bit MAC address of the remote XBee device.</p></li>
<li><p><strong>initializedXbee</strong> (<em>digi.xbee.devices.XBeeDevice</em>) – An active and initialized <cite>XBeeDevice</cite> instance from the Digi XBee Python library.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The Node Identifier (NI string) of the remote XBee device, or <cite>“UNKNOWN”</cite> if it cannot be retrieved.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="function-workflow">
<h4>Function Workflow<a class="headerlink" href="#function-workflow" title="Link to this heading"></a></h4>
<blockquote>
<div><ol class="arabic simple">
<li><p>A <cite>RemoteXBeeDevice</cite> instance is created using the provided MAC address and the initialized local XBee device.</p></li>
<li><p>A remote AT command <cite>“NI”</cite> is issued to request the Node Identifier string from the target XBee device.</p></li>
<li><p>If a valid response is returned and the <cite>parameter</cite> field is not <cite>None</cite>, the NI string is decoded from bytes to a UTF-8 string.</p></li>
<li><p>If no valid response is received or an error occurs during the process, <cite>“UNKNOWN”</cite> is returned as a fallback.</p></li>
</ol>
</div></blockquote>
</section>
<section id="id95">
<h4>Error Handling<a class="headerlink" href="#id95" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>If any exception occurs during the AT command or decoding process, it is caught and logged with an error message.</p></li>
<li><p>All failures result in a return value of <cite>“UNKNOWN”</cite> to maintain compatibility and prevent hard crashes.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">nodeId</span> <span class="o">=</span> <span class="n">getNodeId</span><span class="p">(</span><span class="s2">&quot;0013A200419717AE&quot;</span><span class="p">,</span> <span class="n">xbeeInstance</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote Node ID is: </span><span class="si">{</span><span class="n">nodeId</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="usage-status">
<h4>Usage Status<a class="headerlink" href="#usage-status" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p><strong>Currently not in use</strong> in the production code.</p></li>
<li><p>It may be useful in future implementations for enhanced node discovery, logging, or debugging during deployments.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id96">
<h4>Dependencies<a class="headerlink" href="#id96" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p><cite>digi.xbee.devices.RemoteXBeeDevice</cite> for remote device representation.</p></li>
<li><p><cite>digi.xbee.devices.XBeeDevice.send_remote_at_command()</cite> for issuing AT commands.</p></li>
</ul>
</div></blockquote>
</section>
</section>
<section id="cayenneparse">
<h3>cayenneParse<a class="headerlink" href="#cayenneparse" title="Link to this heading"></a></h3>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">async</span> <span class="pre">cayenneParse(xbeeMacAddress,</span> <span class="pre">xbeeByteData)</span></span></dt>
<dd><p>Asynchronously parses and decodes a raw payload received from an XBee radio device using the Cayenne Low Power Payload (LPP) format. This function translates the raw binary data into a list of floating-point sensor values, stores them in the MongoDB historian, and prints the decoded result for logging purposes.</p>
<p>This function acts as a critical link between the binary data transmitted by XBee remote nodes and the human-readable sensor values used in higher-level logic such as Modbus register updates or analytics.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>xbeeMacAddress</strong> (<em>str</em>) – The 64-bit MAC address of the XBee device that sent the payload.</p></li>
<li><p><strong>xbeeByteData</strong> (<em>bytes</em>) – The raw data payload received from the XBee device as a bytes object.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A list of decoded float sensor values extracted from the Cayenne-formatted payload.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list[float]</p>
</dd>
</dl>
</dd></dl>

<section id="decoding-process">
<h4>Decoding Process<a class="headerlink" href="#decoding-process" title="Link to this heading"></a></h4>
<blockquote>
<div><ol class="arabic simple">
<li><p>The raw bytes are converted into a hex string (<cite>hexConversion</cite>) which is required by the Cayenne decoder.</p></li>
<li><p>The <cite>decode()</cite> function from the <cite>python_cayennelpp</cite> package parses this hex string into a list of dictionaries, each representing a sensor reading.</p></li>
<li><p>The function extracts only the <cite>value</cite> field from each dictionary item (if it exists), casts it to a float, and appends it to a result list.</p></li>
<li><p>The resulting list is stored in a MongoDB database by calling <code class="xref py py-func docutils literal notranslate"><span class="pre">storeXbeeHistoryData()</span></code> with the MAC address, list of float values, and a timestamp.</p></li>
<li><p>The decoded values are printed to the console for debugging or operational transparency.</p></li>
</ol>
</div></blockquote>
</section>
<section id="id97">
<h4>Example Output<a class="headerlink" href="#id97" title="Link to this heading"></a></h4>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>List of values extracted from 0013A200419717AE byte array are: [22.4, 56.3, 1.02]
</pre></div>
</div>
</div></blockquote>
</section>
<section id="id98">
<h4>Usage Context<a class="headerlink" href="#id98" title="Link to this heading"></a></h4>
<blockquote>
<div><p>This function is used in the <code class="xref py py-func docutils literal notranslate"><span class="pre">modbusPolling()</span></code> routine (found in the <cite>modbus</cite> module), which receives raw data from the XBee serial interface, parses it using <cite>cayenneParse()</cite>, and writes the resulting floats into Modbus registers for network exposure.</p>
</div></blockquote>
</section>
<section id="id99">
<h4>Notes<a class="headerlink" href="#id99" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p>Any sensor value that is <cite>None</cite> is skipped silently.</p></li>
<li><p>The decoder assumes that the payload strictly follows the Cayenne LPP format.</p></li>
<li><p>The database storage is timestamped using the current system time via <cite>datetime.datetime.now()</cite>.</p></li>
</ul>
</div></blockquote>
</section>
<section id="id100">
<h4>Dependencies<a class="headerlink" href="#id100" title="Link to this heading"></a></h4>
<blockquote>
<div><ul class="simple">
<li><p><cite>python_cayennelpp.decoder.decode</cite> for Cayenne LPP decoding.</p></li>
<li><p><cite>storeXbeeHistoryData</cite> from <cite>dbIntegration</cite> for MongoDB storage.</p></li>
<li><p><cite>datetime.datetime</cite> for timestamping historical records.</p></li>
</ul>
</div></blockquote>
</section>
</section>
</section>
<section id="xbeedummydatatransmitter">
<span id="id101"></span><h2>xbeeDummyDataTransmitter<a class="headerlink" href="#xbeedummydatatransmitter" title="Link to this heading"></a></h2>
<section id="id102">
<h3>Overview<a class="headerlink" href="#id102" title="Link to this heading"></a></h3>
<p>Simulates XBee slave devices broadcasting structured sensor data via SoftwareSerial.
Each slave sends a structured sensor message wrapped in an XBee Transmit Request frame to the master.
Frames are sent via SoftwareSerial and printed to the Serial monitor for inspection.</p>
<p>This sketch is useful for simulating XBee slaves in a lab/test environment when actual hardware is limited.</p>
</section>
<section id="key-features">
<h3>Key Features<a class="headerlink" href="#key-features" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Emulates 4 XBee slave devices.</p></li>
<li><p>Sends structured payloads with XBee API frames.</p></li>
<li><p>Uses SoftwareSerial to simulate individual slaves.</p></li>
<li><p>Manually constructs and validates API frames and checksums.</p></li>
</ul>
</section>
<section id="global-constants">
<h3>Global Constants<a class="headerlink" href="#global-constants" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define META_DATA_LEN 17</span>
<span class="cp">#define START_DELIMITER 0x7E</span>
<span class="cp">#define START_DELIMITER_OFFSET 0</span>
</pre></div>
</div>
</section>
<section id="xbee-address-definitions">
<h3>XBee Address Definitions<a class="headerlink" href="#xbee-address-definitions" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">master_addr</span><span class="p">[]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="mh">0xE8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4F</span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">slave_1_addr</span><span class="p">[]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">,</span><span class="w"> </span><span class="mh">0x5B</span><span class="p">,</span><span class="w"> </span><span class="mh">0xE1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x07</span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">slave_2_addr</span><span class="p">[]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="mh">0xEB</span><span class="p">,</span><span class="w"> </span><span class="mh">0xCC</span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">slave_3_addr</span><span class="p">[]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="mh">0xA2</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x42</span><span class="p">,</span><span class="w"> </span><span class="mh">0x39</span><span class="p">,</span><span class="w"> </span><span class="mh">0xE3</span><span class="p">,</span><span class="w"> </span><span class="mh">0xE2</span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">broadcast_addr</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">};</span>
</pre></div>
</div>
</section>
<section id="simulated-messages">
<h3>Simulated Messages<a class="headerlink" href="#simulated-messages" title="Link to this heading"></a></h3>
<p>Each message is a simulated Cayenne payload, unique per slave.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">slave1_message</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">slave2_message</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">slave3_message</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">slave4_message</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
</section>
<section id="softwareserial-definitions">
<h3>SoftwareSerial Definitions<a class="headerlink" href="#softwareserial-definitions" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SoftwareSerial</span><span class="w"> </span><span class="nf">slave1_serial</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="n">SoftwareSerial</span><span class="w"> </span><span class="nf">slave2_serial</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="n">SoftwareSerial</span><span class="w"> </span><span class="nf">slave3_serial</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span>
<span class="n">SoftwareSerial</span><span class="w"> </span><span class="nf">slave4_serial</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="function-setup">
<h3>Function: setup<a class="headerlink" href="#function-setup" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">pinMode</span><span class="p">(</span><span class="n">LED_BUILTIN</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="w">  </span><span class="n">slave1_serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="w">  </span><span class="n">slave2_serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="w">  </span><span class="n">slave3_serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="w">  </span><span class="n">slave4_serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Initializes serial ports and sets up slave communication channels.</p>
</section>
<section id="function-loop">
<h3>Function: loop<a class="headerlink" href="#function-loop" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">send_transmit_request</span><span class="p">(</span><span class="n">slave1_serial</span><span class="p">,</span><span class="w"> </span><span class="n">broadcast_addr</span><span class="p">,</span><span class="w"> </span><span class="n">slave1_message</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">slave1_message</span><span class="p">));</span>
<span class="w">  </span><span class="n">send_transmit_request</span><span class="p">(</span><span class="n">slave2_serial</span><span class="p">,</span><span class="w"> </span><span class="n">broadcast_addr</span><span class="p">,</span><span class="w"> </span><span class="n">slave2_message</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">slave2_message</span><span class="p">));</span>
<span class="w">  </span><span class="n">send_transmit_request</span><span class="p">(</span><span class="n">slave3_serial</span><span class="p">,</span><span class="w"> </span><span class="n">broadcast_addr</span><span class="p">,</span><span class="w"> </span><span class="n">slave3_message</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">slave3_message</span><span class="p">));</span>
<span class="w">  </span><span class="n">send_transmit_request</span><span class="p">(</span><span class="n">slave4_serial</span><span class="p">,</span><span class="w"> </span><span class="n">broadcast_addr</span><span class="p">,</span><span class="w"> </span><span class="n">slave4_message</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">slave4_message</span><span class="p">));</span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Sends a broadcast message from each simulated slave every second.</p>
</section>
<section id="function-send-transmit-request">
<h3>Function: send_transmit_request<a class="headerlink" href="#function-send-transmit-request" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">send_transmit_request</span><span class="p">(</span><span class="n">SoftwareSerial</span><span class="w"> </span><span class="n">serial</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">dest_addr</span><span class="p">[],</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">message</span><span class="p">[],</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">message_len</span><span class="p">);</span>
</pre></div>
</div>
<p>Constructs and sends a raw XBee Transmit Request API frame with:</p>
<ul class="simple">
<li><p>Frame delimiter (<cite>0x7E</cite>)</p></li>
<li><p>Length, frame type, frame ID</p></li>
<li><p>Destination address (64-bit + 16-bit)</p></li>
<li><p>Broadcast radius and options</p></li>
<li><p>Payload</p></li>
<li><p>Checksum</p></li>
</ul>
<p>The frame is printed as a HEX dump on Serial.</p>
</section>
<section id="function-calculatechecksum">
<h3>Function: calculateChecksum<a class="headerlink" href="#function-calculatechecksum" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint8_t</span><span class="w"> </span><span class="nf">calculateChecksum</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">length</span><span class="p">);</span>
</pre></div>
</div>
<p>Calculates the checksum for an XBee frame, excluding the start delimiter and length fields.</p>
</section>
<section id="function-receive-transmit-request-optional-utility">
<h3>Function: receive_transmit_request (optional utility)<a class="headerlink" href="#function-receive-transmit-request-optional-utility" title="Link to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">receive_transmit_request</span><span class="p">();</span>
</pre></div>
</div>
<p>Receives and prints an XBee API frame from Serial input. Currently unused in main logic.</p>
</section>
<section id="usage-notes">
<h3>Usage Notes<a class="headerlink" href="#usage-notes" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Ensure baud rate consistency across the system (<cite>9600</cite> in this case).</p></li>
<li><p><cite>SoftwareSerial</cite> pins must be physically separate and not shared.</p></li>
<li><p>Only one <cite>SoftwareSerial</cite> interface can be actively listening at a time—this sketch assumes slaves are transmit-only.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="usage.html" class="btn btn-neutral float-left" title="Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, n1lby73.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>